<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRIMA - Système de Contrôle et Supervision à Distance</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./homeprima_files/stylesPRIMA.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }


        :root {
            --body-bg: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            --elevated-bg: rgba(255, 255, 255, 0.95);
            --elevated-bg-min: rgba(255, 255, 255, 0.92);
            --elevated-border: rgba(0, 0, 0, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --top-marquee-bg: linear-gradient(135deg, #4a6cf7 0%, #2e4ead 100%);
            --top-marquee-bg-min: linear-gradient(135deg, rgba(74, 108, 247, 0.92) 0%, rgba(46, 74, 173, 0.92) 100%);
            --bottom-marquee-bg: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            --accent: #4a6cf7;
            --accent-2: #2e4ead;
            --btn-text: #ffffff;
        }

        [data-theme="dark"] {
            --body-bg: linear-gradient(135deg, #0b1220 0%, #111827 100%);
            --elevated-bg: rgba(17, 24, 39, 0.85);
            --elevated-bg-min: rgba(17, 24, 39, 0.82);
            --elevated-border: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.12);
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --top-marquee-bg: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            --top-marquee-bg-min: linear-gradient(135deg, rgba(31, 41, 55, 0.92) 0%, rgba(17, 24, 39, 0.92) 100%);
            --bottom-marquee-bg: linear-gradient(135deg, #0b1220 0%, #0a0f1a 100%);
            --accent: #7aa2ff;
            --accent-2: #4a6cf7;
            --btn-text: #0b1220;
        }

        @media (prefers-color-scheme: dark) {
            :root:not([data-theme]) {
                --body-bg: linear-gradient(135deg, #0b1220 0%, #111827 100%);
                --elevated-bg: rgba(17, 24, 39, 0.85);
                --elevated-bg-min: rgba(17, 24, 39, 0.82);
                --elevated-border: rgba(255, 255, 255, 0.08);
                --glass-border: rgba(255, 255, 255, 0.12);
                --text-primary: #e5e7eb;
                --text-secondary: #9ca3af;
                --top-marquee-bg: linear-gradient(135deg, #1f2937 0%, #111827 100%);
                --top-marquee-bg-min: linear-gradient(135deg, rgba(31, 41, 55, 0.92) 0%, rgba(17, 24, 39, 0.92) 100%);
                --bottom-marquee-bg: linear-gradient(135deg, #0b1220 0%, #0a0f1a 100%);
                --accent: #7aa2ff;
                --accent-2: #4a6cf7;
                --btn-text: #0b1220;
            }
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--body-bg);
            position: relative;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            color: var(--text-primary);
            color-scheme: light dark;
        }

        /* Advanced Loading Overlay */
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #4a6cf7 0%, #2e4ead 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page-loader.active {
            opacity: 1;
            visibility: visible;
        }

        .loader-content {
            text-align: center;
            color: white;
        }

        .loader-spinner {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1.2s linear infinite;
            margin: 0 auto 30px;
        }

        .loader-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .loader-subtext {
            font-size: 14px;
            opacity: 0.7;
            margin-bottom: 30px;
        }

        .loader-progress {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin: 0 auto;
        }

        .loader-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.8) 0%, white 50%, rgba(255, 255, 255, 0.8) 100%);
            border-radius: 2px;
            width: 0%;
            animation: loadProgress 2s ease-in-out;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes loadProgress {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }

        /* Page Content Fade Animation */
        .page-content {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page-content.loaded {
            opacity: 1;
            transform: translateY(0);
        }

        /* Animated background overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, 
                rgba(74, 108, 247, 0.05) 0%, 
                rgba(102, 126, 234, 0.03) 25%,
                rgba(59, 130, 246, 0.04) 50%,
                rgba(147, 197, 253, 0.02) 75%,
                rgba(74, 108, 247, 0.05) 100%);
            background-size: 400% 400%;
            z-index: -1;
            animation: gradientShift 15s ease infinite;
            will-change: transform;
            transform: var(--bg-transform-1, translate(0, 0));
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Secondary parallax layer */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(74, 108, 247, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(102, 126, 234, 0.06) 0%, transparent 50%);
            z-index: -2;
            will-change: transform;
            transition: transform 0.1s ease-out;
            transform: var(--bg-transform-2, translate(0, 0));
        }

        /* Top Marquee */
        .top-marquee {
            background: var(--top-marquee-bg);
            color: white;
            height: 45px;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1001;
            display: flex;
            align-items: center;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Minimized top marquee state */
        .top-marquee.minimized {
            height: 32px;
            transform: translateY(-2px);
            background: var(--top-marquee-bg-min);
            backdrop-filter: blur(20px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            opacity: 0.85;
        }

        .top-scrolling-text {
            color: white;
            font-weight: 500;
            font-size: 14px;
            white-space: nowrap;
            position: relative;
            z-index: 1;
            line-height: 45px;
            padding: 0 20px;
            animation: scroll-left 30s linear infinite;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Minimized scrolling text */
        .top-marquee.minimized .top-scrolling-text {
            font-size: 12px;
            line-height: 32px;
            padding: 0 15px;
        }

        @keyframes scroll-left {
            0% { transform: translateX(100vw); }
            100% { transform: translateX(-100%); }
        }

        /* Bottom Marquee */
        .bottom-marquee {
            background: var(--bottom-marquee-bg);
            color: white;
            height: 45px;
            overflow: hidden;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1001;
            display: flex;
            align-items: center;
        }

        .bottom-scrolling-text {
            color: white;
            font-weight: 500;
            font-size: 14px;
            white-space: nowrap;
            position: relative;
            z-index: 1;
            line-height: 45px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            animation: scroll-right 35s linear infinite;
        }

        .bottom-logo {
            height: 30px;
            width: auto;
            margin: 0 15px;
            vertical-align: middle;
            filter: brightness(0) invert(1);
            opacity: 0.9;
        }

        @keyframes scroll-right {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100vw); }
        }

        /* Navigation */
        .wrapper {
            display: flex;
            position: relative;
        }

        .wrapper .top_navbar {
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1003;
            position: fixed;
            top: 45px;
            left: 0;
            right: 0;
            width: 100vw;
            overflow: visible;
        }

        /* Minimized navbar state on scroll */
        .wrapper .top_navbar.minimized {
            top: 30px;
            transform: translateY(0);
        }

        .wrapper .top_navbar .top_menu {
            background: var(--elevated-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-radius: 0 !important;
            border-top-right-radius: 0 !important;
            overflow: visible;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
            width: 100%;
            margin: 0;
            box-sizing: border-box;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Minimized top_menu state */
        .wrapper .top_navbar.minimized .top_menu {
            height: 50px;
            padding: 0 15px;
            background: var(--elevated-bg-min);
            backdrop-filter: blur(25px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            opacity: 0.88;
        }

        .wrapper .top_navbar .top_menu .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: 20px;
            transition: all 0.3s ease;
            position: relative;
        }

        .wrapper .top_navbar .top_menu .logo .logo-image {
            width: 40px;
            height: 40px;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .wrapper .top_navbar .top_menu .logo .logo-text {
            background: linear-gradient(135deg, #2e4ead 0%, #4a6cf7 50%, #667eea 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            font-size: 28px;
            letter-spacing: -1px;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            text-shadow: 0 2px 10px rgba(46, 74, 173, 0.2);
        }

        .wrapper .top_navbar .top_menu .logo:hover .logo-image {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .wrapper .top_navbar .top_menu .logo:hover .logo-text {
            text-shadow: 0 4px 15px rgba(46, 74, 173, 0.3);
        }

        /* Advanced Navbar Icons */
        /* ESP32 System Info Styles */
        .esp32-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 0 20px;
            padding: 8px 15px;
            background: var(--elevated-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            font-size: 12px;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .esp32-info:hover {
            background: var(--elevated-bg-min);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .esp32-info-item {
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .esp32-info-item i {
            font-size: 11px;
            color: var(--accent);
        }

        .esp32-info-value {
            font-weight: 500;
            color: var(--text-primary);
        }

        .esp32-status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .esp32-status-indicator.warning {
            background: #f59e0b;
        }

        .esp32-status-indicator.critical {
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Responsive ESP32 info */
        @media (max-width: 1200px) {
            .esp32-info {
                gap: 10px;
                margin: 0 10px;
                padding: 6px 10px;
            }
            .esp32-info-item:nth-child(n+4) {
                display: none;
            }
        }

        @media (max-width: 900px) {
            .esp32-info {
                gap: 8px;
                margin: 0 5px;
                padding: 4px 8px;
            }
            .esp32-info-item:nth-child(n+3) {
                display: none;
            }
        }

        /* Enhanced ESP32 Info Visual Elements */
        .info-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 8px;
            background: var(--accent);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 4px;
        }

        .flash-badge {
            background: #8b5cf6;
        }

        .sketch-badge {
            background: #06b6d4;
        }

        /* Signal Bars */
        .signal-bars {
            display: flex;
            gap: 1px;
            align-items: flex-end;
            margin-left: 4px;
        }

        .signal-bars .bar {
            width: 3px;
            background: #d1d5db;
            border-radius: 1px;
            transition: background 0.3s ease;
        }

        .signal-bars .bar:nth-child(1) { height: 4px; }
        .signal-bars .bar:nth-child(2) { height: 6px; }
        .signal-bars .bar:nth-child(3) { height: 8px; }
        .signal-bars .bar:nth-child(4) { height: 10px; }

        .signal-bars.excellent .bar { background: #10b981; }
        .signal-bars.good .bar:nth-child(-n+3) { background: #10b981; }
        .signal-bars.fair .bar:nth-child(-n+2) { background: #f59e0b; }
        .signal-bars.poor .bar:nth-child(1) { background: #ef4444; }

        /* CPU Load Bar */
        .cpu-load-bar {
            width: 20px;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            margin-left: 4px;
        }

        .cpu-load-bar .load-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #f59e0b, #ef4444);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 45%;
        }

        /* RAM Usage Bar */
        .ram-usage-bar {
            width: 20px;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            margin-left: 4px;
        }

        .ram-usage-bar .usage-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 65%;
        }

        /* Temperature Indicator */
        .temp-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            margin-left: 4px;
            transition: background 0.3s ease;
        }

        .temp-indicator.warm { background: #f59e0b; }
        .temp-indicator.hot { background: #ef4444; }
        .temp-indicator.critical { background: #dc2626; animation: pulse 1s infinite; }

        /* Power Indicator */
        .power-indicator {
            width: 8px;
            height: 8px;
            border-radius: 2px;
            background: #10b981;
            margin-left: 4px;
            position: relative;
        }

        .power-indicator::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 1px;
        }

        /* Network Activity */
        .network-activity {
            display: flex;
            gap: 2px;
            margin-left: 4px;
        }

        .activity-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #d1d5db;
        }

        .activity-dot.tx {
            background: #ef4444;
            animation: networkBlink 1s infinite;
        }

        .activity-dot.rx {
            background: #10b981;
            animation: networkBlink 1.2s infinite;
        }

        @keyframes networkBlink {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* Sensor Status Dots */
        .sensor-status {
            display: flex;
            gap: 2px;
            margin-left: 4px;
        }

        .sensor-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #10b981;
            position: relative;
            transition: all 0.3s ease;
        }

        .sensor-dot.error { background: #ef4444; }
        .sensor-dot.warning { background: #f59e0b; }
        .sensor-dot.offline { background: #6b7280; }

        .sensor-dot:hover {
            transform: scale(1.3);
        }

        /* Actuator Status Dots */
        .actuator-status {
            display: flex;
            gap: 2px;
            margin-left: 4px;
        }

        .actuator-dot {
            width: 6px;
            height: 6px;
            border-radius: 2px;
            background: #6b7280;
            transition: all 0.3s ease;
        }

        .actuator-dot.active { background: #10b981; }
        .actuator-dot.pump.active { background: #3b82f6; }
        .actuator-dot.light.active { background: #f59e0b; }
        .actuator-dot.fan.active { background: #06b6d4; }
        .actuator-dot.heater.active { background: #ef4444; }
        .actuator-dot.valve.active { background: #8b5cf6; }

        .actuator-dot:hover {
            transform: scale(1.3);
        }

        /* Responsive adjustments for new elements */
        @media (max-width: 1400px) {
            .esp32-info-item:nth-child(n+8) {
                display: none;
            }
        }

        @media (max-width: 1200px) {
            .esp32-info-item:nth-child(n+6) {
                display: none;
            }
            .info-badge, .signal-bars, .cpu-load-bar, .ram-usage-bar {
                display: none;
            }
        }

        @media (max-width: 900px) {
            .esp32-info-item:nth-child(n+4) {
                display: none;
            }
        }

        .wrapper .top_navbar .top_menu ul {
            display: flex;
            gap: 24px; /* Further increased gap to prevent hover overlap */
            align-items: center;
            margin: 0;
            list-style: none;
            padding: 0 12px; /* Add horizontal padding */
        }

        .wrapper .top_navbar .top_menu ul li {
            position: relative;
            margin: 0; /* Remove extra margin since gap handles spacing */
            /* Ensure each icon has its own isolated hover area */
            z-index: 1;
            /* Allow badges to overflow the container */
            overflow: visible;
        }

        .wrapper .top_navbar .top_menu ul li > a.nav-icon {
            display: flex !important;
            align-items: center;
            justify-content: center;
            width: 44px !important;
            height: 44px !important;
            margin: 0 !important;
            border: 2px solid transparent !important;
            border-radius: 50% !important;
            background: rgba(255, 255, 255, 0.9) !important;
            backdrop-filter: blur(20px) !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
            color: #4a6cf7 !important;
            font-size: 16px !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            position: relative !important;
            overflow: visible !important;
            text-decoration: none;
            /* Strict circular hover area */
            clip-path: circle(22px at center);
            pointer-events: auto;
            isolation: isolate;
        }


        .wrapper .top_navbar .top_menu ul li > a.nav-icon::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s ease;
        }

        .wrapper .top_navbar .top_menu ul li > a.nav-icon:hover::before {
            left: 100%;
        }

        .wrapper .top_navbar .top_menu ul li > a.nav-icon:hover {
            transform: translateY(-2px) scale(1.05) !important;
            background: linear-gradient(135deg, #4a6cf7 0%, #2e4ead 100%) !important;
            color: white !important;
            border: 2px solid rgba(255, 255, 255, 0.3) !important;
            box-shadow: 0 8px 25px rgba(74, 108, 247, 0.4), 0 0 20px rgba(74, 108, 247, 0.2) !important;
            z-index: 10; /* Ensure hovered icon is above others */
        }

        .wrapper .top_navbar .top_menu ul li > a.nav-icon i {
            transition: all 0.3s ease;
            z-index: 2;
            position: relative;
        }

        .wrapper .top_navbar .top_menu ul li > a.nav-icon:hover i {
            color: white !important;
            transform: scale(1.1);
        }

        /* Neutralize external circular styles for non-icon anchors inside top_menu */
        .wrapper .top_navbar .top_menu ul li a:not(.nav-icon) {
            display: inline-flex !important;
            align-items: center !important;
            justify-content: flex-start !important;
            width: auto !important;
            height: auto !important;
            line-height: normal !important;
            padding: 0 !important;
            margin: 0 !important;
            border: none !important;
            border-radius: 8px !important;
            background: transparent !important;
            box-shadow: none !important;
            text-align: left !important;
            color: inherit !important;
        }
        .wrapper .top_navbar .top_menu ul li a:not(.nav-icon):hover {
            background: transparent !important;
            color: inherit !important;
            transform: none !important;
        }
        .wrapper .top_navbar .top_menu ul li a:not(.nav-icon) i {
            color: inherit !important;
        }

        /* Dark theme navbar icon tuning */
        body[data-theme="dark"] .wrapper .top_navbar .top_menu ul li > a.nav-icon {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--glass-border) !important;
            color: var(--accent) !important;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35) !important;
            backdrop-filter: none !important;
        }

        body[data-theme="dark"] .wrapper .top_navbar .top_menu ul li > a.nav-icon i {
            color: var(--accent) !important;
        }

        body[data-theme="dark"] .wrapper .top_navbar .top_menu ul li > a.nav-icon::before {
            background: none !important; /* disable shimmer band on dark */
        }

        body[data-theme="dark"] .wrapper .top_navbar .top_menu ul li > a.nav-icon:hover {
            background: linear-gradient(135deg, rgba(122, 162, 255, 0.18) 0%, rgba(74, 108, 247, 0.18) 100%) !important;
            border: 1px solid var(--glass-border) !important;
            color: white !important;
            box-shadow: 0 10px 28px rgba(0, 0, 0, 0.45) !important;
        }

        /* Individual icon animations */
        .wrapper .top_navbar .top_menu ul li:nth-child(1) > a.nav-icon:hover {
            animation: bellRing 0.6s ease-in-out;
        }

        .wrapper .top_navbar .top_menu ul li:nth-child(2) > a.nav-icon:hover {
            animation: envelopeFloat 0.6s ease-in-out;
        }

        .wrapper .top_navbar .top_menu ul li:nth-child(3) > a.nav-icon:hover {
            animation: userPulse 0.6s ease-in-out;
        }

        .wrapper .top_navbar .top_menu ul li:nth-child(4) > a.nav-icon:hover {
            animation: signOutSlide 0.6s ease-in-out;
        }

        @keyframes bellRing {
            0%, 100% { transform: translateY(-2px) scale(1.05) rotate(0deg); }
            25% { transform: translateY(-2px) scale(1.05) rotate(-10deg); }
            75% { transform: translateY(-2px) scale(1.05) rotate(10deg); }
        }

        @keyframes envelopeFloat {
            0%, 100% { transform: translateY(-2px) scale(1.05); }
            50% { transform: translateY(-6px) scale(1.05); }
        }

        @keyframes userPulse {
            0%, 100% { transform: translateY(-2px) scale(1.05); }
            50% { transform: translateY(-2px) scale(1.15); }
        }

        @keyframes signOutSlide {
            0%, 100% { transform: translateY(-2px) scale(1.05) translateX(0); }
            50% { transform: translateY(-2px) scale(1.05) translateX(3px); }
        }

        /* Notification Badges */
        .notification-badge, .alert-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: 600;
            border: 1px solid white;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
            animation: badgePulse 2s infinite;
            z-index: 20; /* Ensure badges appear above everything */
            pointer-events: none; /* Make badges non-hoverable */
        }
        
        .alert-badge {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
        }
        
        .alert-badge.critical {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
            animation: pulseUrgent 1s infinite;
        }
        
        @keyframes pulseUrgent {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }

        /* Hide badge when empty (e.g., 0 notifications) */
        .notification-badge:empty { display: none; }

        /* Dark theme tweaks: soften white ring and glow */
        body[data-theme="dark"] .notification-badge {
            border-color: var(--elevated-bg) !important;
            box-shadow: 0 3px 10px rgba(239, 68, 68, 0.25) !important;
        }

        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Special effects for different icons */
        .nav-icon.notifications:hover .notification-badge {
            animation: badgeShake 0.6s ease-in-out;
        }

        .nav-icon.messages:hover .notification-badge {
            animation: badgeBounce 0.6s ease-in-out;
        }

        @keyframes badgeShake {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(-5deg); }
            75% { transform: scale(1.1) rotate(5deg); }
        }

        @keyframes badgeBounce {
            0%, 100% { transform: scale(1) translateY(0); }
            50% { transform: scale(1.2) translateY(-2px); }
        }

        /* Advanced Dropdown Menus */
        .top_menu .has-dropdown { position: relative; }

        .dropdown-menu {
            position: absolute;
            top: 50px; /* reduced gap - align closer to navbar */
            right: 0;
            width: 360px;
            max-width: calc(100vw - 24px);
            background: var(--elevated-bg);
            border: 1px solid var(--elevated-border);
            box-shadow: 0 24px 60px rgba(0,0,0,0.2), 0 4px 16px rgba(0,0,0,0.12);
            border-radius: 14px;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(8px) scale(0.98);
            transition: opacity .2s ease, transform .2s ease, visibility .2s ease;
            z-index: 1200;
            backdrop-filter: blur(16px);
        }

        .has-dropdown.open > .dropdown-menu {
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) scale(1) !important;
            pointer-events: auto !important;
            display: block !important;
            position: absolute !important;
            top: calc(100% + 8px) !important;
            right: 0 !important;
            z-index: 9999 !important;
            max-height: calc(100vh - 80px) !important;
            overflow-y: auto !important;
        }

        .dropdown-menu::before {
            content: '';
            position: absolute;
            top: -8px;
            right: 18px;
            width: 16px;
            height: 16px;
            background: var(--elevated-bg);
            border-left: 1px solid var(--elevated-border);
            border-top: 1px solid var(--elevated-border);
            transform: rotate(45deg);
        }

        .dropdown-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            border-bottom: 1px solid var(--elevated-border);
            background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.25));
        }
        body[data-theme="dark"] .dropdown-header {
            background: linear-gradient(180deg, rgba(17,24,39,0.7), rgba(17,24,39,0.4));
        }
        .dropdown-header span { font-weight: 700; color: var(--text-primary); letter-spacing: -.01em; }
        .dropdown-action {
            height: 30px; width: 30px; border-radius: 8px;
            border: 1px solid var(--elevated-border);
            background: rgba(255,255,255,0.6);
            color: var(--text-primary);
            display: grid; place-items: center;
            cursor: pointer; transition: all .2s ease;
        }
        body[data-theme="dark"] .dropdown-action { background: rgba(255,255,255,0.06); color: var(--text-primary); }
        .dropdown-action:hover { filter: brightness(0.98); transform: translateY(-1px); }

        .dropdown-content { max-height: 52vh; overflow-y: auto; padding: 10px; display: grid; gap: 8px; }
        .dropdown-content::-webkit-scrollbar { width: 10px; }
        .dropdown-content::-webkit-scrollbar-track { background: transparent; }
        .dropdown-content::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.08); border-radius: 8px; }

        .dropdown-item {
            display: flex; align-items: center; gap: 12px;
            padding: 10px 12px; border-radius: 10px;
            color: var(--text-primary); text-decoration: none;
            transition: background .2s ease, transform .2s ease;
        }
        .dropdown-item:hover { background: rgba(17,24,39,0.05); transform: translateY(-1px); }
        body[data-theme="dark"] .dropdown-item:hover { background: rgba(255,255,255,0.06); }
        .dropdown-item .item-icon {
            flex: 0 0 36px; height: 36px; width: 36px; border-radius: 9px;
            display: grid; place-items: center;
            background: var(--icon-bg, #eef2ff);
            color: var(--icon-color, #4f46e5);
            box-shadow: inset 0 0 0 1px var(--elevated-border);
        }
        .dropdown-item .item-info { display: grid; gap: 2px; }
        .dropdown-item .item-title { font-weight: 600; color: var(--text-primary); }
        .dropdown-item .item-meta { font-size: 12px; color: var(--text-secondary); }
        .dropdown-item.danger { color: #991b1b; }
        .dropdown-item.danger:hover { background: rgba(239,68,68,0.08); }

        /* Reset external navbar <li> a styles inside dropdowns */
        .wrapper .top_navbar .top_menu .dropdown-menu .dropdown-item {
            display: flex !important;
            align-items: center !important;
            justify-content: flex-start !important;
            width: auto !important;
            height: auto !important;
            line-height: normal !important;
            margin: 0 !important;
            border: none !important;
            border-radius: 10px !important;
            background: transparent !important;
            box-shadow: none !important;
            text-align: left !important;
            text-decoration: none !important;
            white-space: normal !important;
        }
        .wrapper .top_navbar .top_menu .dropdown-menu .dropdown-item:hover {
            background: rgba(17,24,39,0.05) !important;
        }
        body[data-theme="dark"] .wrapper .top_navbar .top_menu .dropdown-menu .dropdown-item:hover {
            background: rgba(255,255,255,0.06) !important;
        }
        /* Keep icon colors on hover inside dropdowns */
        .wrapper .top_navbar .top_menu .dropdown-menu .dropdown-item:hover i { color: inherit !important; }

        /* Ensure text truncates gracefully */
        .wrapper .top_navbar .top_menu .dropdown-menu .dropdown-item .item-info { min-width: 0; }
        .wrapper .top_navbar .top_menu .dropdown-menu .dropdown-item .item-title,
        .wrapper .top_navbar .top_menu .dropdown-menu .dropdown-item .item-meta {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Generic anchors inside dropdown menu */
        .wrapper .top_navbar .top_menu .dropdown-menu a {
            width: auto !important;
            height: auto !important;
            line-height: normal !important;
            border: none !important;
            border-radius: 8px !important;
            background: transparent !important;
            text-align: left !important;
        }
        .wrapper .top_navbar .top_menu .dropdown-menu a:focus,
        .wrapper .top_navbar .top_menu .dropdown-menu a:focus-visible {
            outline: 2px solid var(--accent) !important;
            outline-offset: 2px !important;
        }

        /* Footer link reset */
        .wrapper .top_navbar .top_menu .dropdown-menu .dropdown-footer .view-all {
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            width: auto !important;
            height: auto !important;
            line-height: normal !important;
            padding: 0 !important;
            margin: 0 !important;
            border: none !important;
            border-radius: 0 !important;
            background: transparent !important;
            box-shadow: none !important;
            text-decoration: none !important;
        }

        .dropdown-footer {
            border-top: 1px solid var(--elevated-border);
            padding: 10px 12px; display: flex; justify-content: center;
            background: linear-gradient(180deg, rgba(255,255,255,0.2), rgba(255,255,255,0.6));
        }
        body[data-theme="dark"] .dropdown-footer {
            background: linear-gradient(180deg, rgba(17,24,39,0.4), rgba(17,24,39,0.7));
        }
        .dropdown-footer .view-all { color: #1f6feb; text-decoration: none; font-weight: 600; }

        /* Staggered entrance for items */
        @keyframes menuItemIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
        .has-dropdown.open .dropdown-item { animation: menuItemIn .28s ease both; }
        .has-dropdown.open .dropdown-item:nth-child(1) { animation-delay: .02s; }
        .has-dropdown.open .dropdown-item:nth-child(2) { animation-delay: .05s; }
        .has-dropdown.open .dropdown-item:nth-child(3) { animation-delay: .08s; }
        .has-dropdown.open .dropdown-item:nth-child(4) { animation-delay: .11s; }
        .has-dropdown.open .dropdown-item:nth-child(5) { animation-delay: .14s; }

        /* Responsive: full-width on small screens */
        @media (max-width: 640px) {
            .dropdown-menu { position: fixed; right: 12px; left: 12px; width: auto; top: 72px; }
            .dropdown-menu::before { right: 32px; }
        }

        /* Profile Image Styling */
        .profile-image {
            width: 32px !important;
            height: 32px !important;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        body[data-theme="dark"] .profile-image {
            border-color: rgba(255, 255, 255, 0.25) !important;
        }

        .nav-icon.profile:hover .profile-image {
            border-color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* Logout icon special styling */
        .nav-icon.logout:hover {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4), 0 0 20px rgba(239, 68, 68, 0.2) !important;
        }

        /* Profile icon special styling */
        .nav-icon.profile:hover {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4), 0 0 20px rgba(16, 185, 129, 0.2) !important;
        }

        .nav-icon.settings:hover {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%) !important;
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4), 0 0 20px rgba(139, 92, 246, 0.2) !important;
        }

        .nav-icon.settings:hover {
            animation: settingsRotate 0.6s ease-in-out;
        }

        @keyframes settingsRotate {
            0%, 100% { transform: translateY(-2px) scale(1.05) rotate(0deg); }
            50% { transform: translateY(-2px) scale(1.05) rotate(180deg); }
        }

        /* Settings Dropdown Styles */
        .dropdown-settings {
            width: 420px !important;
            max-height: 80vh;
            overflow-y: auto;
        }

        .dropdown-settings .dropdown-content {
            max-height: none;
            padding: 0;
        }

        .settings-content {
            padding: 0;
        }

        .settings-section {
            border-bottom: 1px solid var(--elevated-border);
            padding: 20px;
        }

        .settings-section:last-child {
            border-bottom: none;
        }

        .settings-section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            gap: 12px;
        }

        .setting-item.full-width {
            flex-direction: column;
            align-items: stretch;
        }

        .setting-item label {
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 500;
            flex: 1;
        }

        .setting-item input[type="number"],
        .setting-item input[type="range"],
        .setting-item select {
            background: var(--elevated-bg);
            border: 1px solid var(--elevated-border);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 12px;
            color: var(--text-primary);
            width: 80px;
            transition: all 0.2s ease;
        }

        .setting-item select {
            width: 120px;
        }

        .setting-item input[type="range"] {
            width: 100px;
        }

        .setting-item input:focus,
        .setting-item select:focus {
            outline: none;
            border-color: #4a6cf7;
            box-shadow: 0 0 0 2px rgba(74, 108, 247, 0.2);
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input[type="checkbox"] {
            display: none;
        }

        .toggle-switch .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            border-radius: 24px;
            transition: 0.3s;
        }

        .toggle-switch .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch input:checked + .slider {
            background-color: #4a6cf7;
        }

        .toggle-switch input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* Settings Buttons */
        .settings-btn {
            width: 100%;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 8px;
        }

        .settings-btn.primary {
            background: #4a6cf7;
            color: white;
        }

        .settings-btn.primary:hover {
            background: #3b5cf6;
            transform: translateY(-1px);
        }

        .settings-btn.danger {
            background: #ef4444;
            color: white;
        }

        .settings-btn.danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        /* Animation Speed Indicator */
        #animationSpeedValue {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 600;
            min-width: 25px;
            text-align: center;
        }

        /* Settings Utility Classes */
        .no-transitions * {
            transition: none !important;
            animation: none !important;
        }

        .debug-mode {
            position: relative;
        }

        /* Advanced Settings Styles - Blue & White Theme */
        .nav-icon.settings-advanced:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%) !important;
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4), 0 0 20px rgba(37, 99, 235, 0.3) !important;
            animation: settingsAdvancedRotate 0.8s ease-in-out;
        }

        @keyframes settingsAdvancedRotate {
            0%, 100% { transform: translateY(-2px) scale(1.05) rotate(0deg); }
            25% { transform: translateY(-2px) scale(1.05) rotate(90deg); }
            50% { transform: translateY(-2px) scale(1.05) rotate(180deg); }
            75% { transform: translateY(-2px) scale(1.05) rotate(270deg); }
        }

        /* Advanced Settings Dropdown */
        .dropdown-settings-advanced {
            width: 520px !important;
            max-height: 85vh;
            overflow-y: auto;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #e2e8f0;
            box-shadow: 0 25px 50px rgba(37, 99, 235, 0.15), 0 0 30px rgba(37, 99, 235, 0.1);
        }

        [data-theme="dark"] .dropdown-settings-advanced {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-color: #334155;
        }

        .settings-header {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-header span {
            font-weight: 700;
            font-size: 16px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .settings-actions {
            display: flex;
            gap: 8px;
        }

        .settings-actions .dropdown-action {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .settings-actions .dropdown-action:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .settings-advanced-content {
            padding: 0;
            max-height: none;
        }

        /* Settings Categories */
        .settings-category {
            border-bottom: 1px solid #e2e8f0;
            background: white;
        }

        [data-theme="dark"] .settings-category {
            border-color: #334155;
            background: #1e293b;
        }

        .settings-category:last-child {
            border-bottom: none;
        }

        .settings-category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #2563eb;
        }

        [data-theme="dark"] .settings-category-header {
            background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
        }

        .settings-category-header:hover {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            transform: translateX(2px);
        }

        [data-theme="dark"] .settings-category-header:hover {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
        }

        .settings-category-header i {
            color: #2563eb;
            font-size: 18px;
            margin-right: 12px;
        }

        .settings-category-header span {
            font-weight: 700;
            font-size: 15px;
            color: #1e293b;
            flex: 1;
        }

        [data-theme="dark"] .settings-category-header span {
            color: #f1f5f9;
        }

        .category-toggle {
            background: none;
            border: none;
            color: #64748b;
            font-size: 14px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .category-toggle:hover {
            background: rgba(37, 99, 235, 0.1);
            color: #2563eb;
        }

        .category-toggle.rotated {
            transform: rotate(180deg);
        }

        .settings-category-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .settings-category-content.expanded {
            max-height: 1000px;
            padding: 20px;
        }

        /* Setting Rows */
        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid #f1f5f9;
            gap: 20px;
        }

        [data-theme="dark"] .setting-row {
            border-color: #334155;
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-row.action-row {
            justify-content: center;
            padding: 12px 0;
        }

        .setting-info {
            flex: 1;
        }

        .setting-info label {
            display: block;
            font-weight: 600;
            font-size: 14px;
            color: #1e293b;
            margin-bottom: 4px;
        }

        [data-theme="dark"] .setting-info label {
            color: #f1f5f9;
        }

        .setting-description {
            font-size: 12px;
            color: #64748b;
            line-height: 1.4;
        }

        [data-theme="dark"] .setting-description {
            color: #94a3b8;
        }

        .setting-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Advanced Toggle Switch */
        .toggle-switch-advanced {
            position: relative;
            width: 52px;
            height: 28px;
        }

        .toggle-switch-advanced input[type="checkbox"] {
            display: none;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
            border-radius: 28px;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .toggle-switch-advanced input:checked + .toggle-slider {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        .toggle-switch-advanced input:checked + .toggle-slider:before {
            transform: translateX(24px);
            background: linear-gradient(135deg, #ffffff 0%, #dbeafe 100%);
        }

        /* Range Controls */
        .range-control {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 180px;
        }

        .range-control input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .range-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.3);
            transition: all 0.2s ease;
        }

        .range-control input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }

        .range-value {
            font-weight: 600;
            font-size: 13px;
            color: #2563eb;
            min-width: 60px;
            text-align: center;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            padding: 4px 8px;
            border-radius: 6px;
        }

        /* Action Buttons */
        .settings-action-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 180px;
            justify-content: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .settings-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .settings-action-btn.primary {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
        }

        .settings-action-btn.success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
        }

        .settings-action-btn.warning {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            color: white;
        }

        .settings-action-btn.danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
        }

        .settings-action-btn.info {
            background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
            color: white;
        }

        .debug-mode::before {
            content: 'DEBUG MODE';
            position: fixed;
            top: 45px;
            left: 50%;
            transform: translateX(-50%);
            background: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            z-index: 9999;
            letter-spacing: 1px;
        }

        /* Animation speed CSS variable */
        :root {
            --animation-speed: 1;
        }

        /* Apply animation speed to transitions */
        * {
            transition-duration: calc(var(--transition-duration, 0.3s) / var(--animation-speed));
        }

        /* Close dropdown when clicking outside */
        .dropdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 999;
            background: transparent;
        }

        /* Hamburger Menu - Override external CSS */
        .wrapper .top_navbar .hamburger {
            background: var(--elevated-bg) !important;
            backdrop-filter: blur(20px) !important;
            border: 1px solid var(--glass-border) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1) !important;
            border-radius: 0 !important;
            border-top-left-radius: 0 !important;
            width: 50px !important;
            height: 70px !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            cursor: pointer !important;
            padding: 0 !important;
        }

        .wrapper .top_navbar .hamburger:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15) !important;
            background: rgba(255, 255, 255, 1) !important;
        }

        body[data-theme="dark"] .wrapper .top_navbar .hamburger:hover {
            background: var(--elevated-bg) !important;
        }

        /* Hamburger menu minimized state */
        .wrapper .top_navbar.minimized .hamburger {
            height: 50px !important;
            background: var(--elevated-bg-min) !important;
            backdrop-filter: blur(25px) !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08) !important;
            opacity: 0.88 !important;
        }

        .wrapper .top_navbar .hamburger div {
            background: linear-gradient(135deg, #2e4ead 0%, #4a6cf7 100%) !important;
            border-radius: 3px;
            transition: all 0.3s ease;
            width: 25px;
            height: 3px;
            margin: 3px 0;
        }

        .wrapper .top_navbar .hamburger:hover div {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%) !important;
            transform: scale(1.05);
        }

        /* Sidebar */
        .wrapper .sidebar {
            background: var(--elevated-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--elevated-border);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
            padding-top: 0;
            position: fixed;
            left: 0;
            top: 115px;
            width: 250px;
            height: calc(100vh - 160px);
            z-index: 999;
            transform: translateX(-100%);
            transition: transform 0.3s ease,
                        top 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                        height 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                        background 0.6s ease,
                        backdrop-filter 0.6s ease,
                        box-shadow 0.6s ease,
                        opacity 0.6s ease;
        }

        .wrapper .sidebar.active {
            transform: translateX(0);
        }

        /* Minimized sidebar state on scroll (sync with navbar) */
        .wrapper .top_navbar.minimized ~ .sidebar {
            top: 82px;
            height: calc(100vh - 127px); /* 82(top) + 45(bottom marquee) */
            background: var(--elevated-bg-min);
            backdrop-filter: blur(25px);
            box-shadow: 4px 0 16px rgba(0, 0, 0, 0.08);
            opacity: 0.92;
        }

        .wrapper .sidebar ul {
            list-style: none;
            padding: 16px 0;
        }

        .wrapper .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            color: #6b7280;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s ease;
            margin: 2px 8px;
            font-size: 13px;
        }

        .wrapper .sidebar ul li a:hover,
        .wrapper .sidebar ul li a.active {
            background: linear-gradient(135deg, #4a6cf7 0%, #2e4ead 100%);
            transform: translateX(4px);
            box-shadow: 0 4px 15px rgba(74, 108, 247, 0.3);
            color: white !important;
        }

        .wrapper .sidebar ul li a span.icon {
            color: #6b7280;
            margin-right: 12px;
            width: 16px;
            font-size: 14px;
        }

        .wrapper .sidebar ul li a:hover span.icon,
        .wrapper .sidebar ul li a.active span.icon {
            color: white;
        }

        /* Submenu Styles */
        .wrapper .sidebar ul li.has-submenu {
            position: relative;
        }

        .wrapper .sidebar ul li a span.arrow {
            margin-left: auto;
            transition: transform 0.3s ease;
            color: #6b7280;
            font-size: 10px;
        }

        .wrapper .sidebar ul li.has-submenu.open > a {
            background: linear-gradient(135deg, #4a6cf7 0%, #2e4ead 100%);
            transform: translateX(4px);
            box-shadow: 0 4px 15px rgba(74, 108, 247, 0.3);
            color: white !important;
        }

        .wrapper .sidebar ul li.has-submenu.open > a span.arrow {
            transform: rotate(90deg);
            color: white;
        }

        .wrapper .sidebar ul li.has-submenu.open > a span.icon,
        .wrapper .sidebar ul li.has-submenu.open > a span.title {
            color: white;
        }

        .wrapper .sidebar ul li .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(0, 0, 0, 0.15);
            margin: 4px 8px 0 8px;
            border-radius: 8px;
            list-style: none;
            padding: 0;
        }

        .wrapper .sidebar ul li.has-submenu.open .submenu {
            max-height: 200px;
            padding: 8px 0;
        }

        .wrapper .sidebar ul li .submenu li {
            margin: 0;
            padding: 0;
        }

        .wrapper .sidebar ul li .submenu li a {
            display: flex;
            align-items: center;
            padding: 10px 16px 10px 32px;
            margin: 2px 6px;
            font-size: 13px;
            border-radius: 6px;
            color: #9ca3af;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .wrapper .sidebar ul li .submenu li a span.icon {
            font-size: 12px;
            width: 14px;
            margin-right: 10px;
            color: #9ca3af;
        }

        .wrapper .sidebar ul li .submenu li a span.title {
            color: #9ca3af;
        }

        .wrapper .sidebar ul li .submenu li a:hover {
            background: linear-gradient(135deg, #5b73f7 0%, #3f57c4 100%);
            transform: translateX(2px);
            color: white;
        }

        .wrapper .sidebar ul li .submenu li a:hover span.icon,
        .wrapper .sidebar ul li .submenu li a:hover span.title {
            color: white;
        }

        /* Main Content */
        .main_container {
            margin-left: 0;
            margin-top: 115px;
            margin-bottom: 45px;
            padding: 40px;
            min-height: calc(100vh - 160px);
            transition: margin-left 0.3s ease, margin-top 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Adjust main container when navbar is minimized */
        .wrapper .top_navbar.minimized ~ .main_container,
        .main_container.navbar-minimized {
            margin-top: 82px;
        }

        .main_container.sidebar-open {
            margin-left: 250px;
        }

        .item {
            margin-bottom: 40px;
        }

        /* Hero Section */
        .hero-section {
            text-align: center;
            padding: 60px 0;
            background: linear-gradient(135deg, rgba(74, 108, 247, 0.15) 0%, rgba(46, 74, 173, 0.15) 100%);
            border-radius: 24px;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
        }

        /* Multi-layer color parallax backgrounds */
        .hero-section::before {
            content: '';
            position: absolute;
            top: -30px;
            left: -30px;
            right: -30px;
            bottom: -30px;
            background:
                radial-gradient(ellipse at 30% 20%, rgba(74, 108, 247, 0.25) 0%, transparent 60%),
                radial-gradient(ellipse at 70% 80%, rgba(102, 126, 234, 0.20) 0%, transparent 60%);
            border-radius: 24px;
            z-index: -2;
            will-change: transform;
            transition: transform 0.1s ease-out;
            transform: var(--hero-before-transform, translate(0, 0));
        }

        .hero-section::after {
            content: '';
            position: absolute;
            top: -20px;
            left: -20px;
            right: -20px;
            bottom: -20px;
            background:
                radial-gradient(circle at 25% 75%, rgba(147, 197, 253, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 75% 25%, rgba(99, 102, 241, 0.12) 0%, transparent 50%);
            border-radius: 24px;
            z-index: -1;
            will-change: transform;
            transition: transform 0.1s ease-out;
            transform: var(--hero-after-transform, translate(0, 0));
        }

        .hero-title {
            font-size: 4rem;
            font-weight: 800;
            color: #2e4ead;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #2e4ead 0%, #4a6cf7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            will-change: transform;
            transition: transform 0.1s ease-out;
            transform: var(--hero-title-transform, translate(0, 0));
        }

        .hero-subtitle {
            font-size: 1.5rem;
            color: #4a6cf7;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .hero-description {
            font-size: 1.1rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Welcome Card */
        .welcome-card {
            background: linear-gradient(135deg, #e8f4fd 0%, #dbeafe 100%);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.1);
            position: relative;
            overflow: hidden;
            transition: transform 0.1s ease-out;
            will-change: transform;
        }

        .welcome-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.05) 0%, transparent 70%);
            transition: transform 0.1s ease-out;
            will-change: transform;
            pointer-events: none;
            animation: welcomeFloat 8s ease-in-out infinite;
        }

        @keyframes welcomeFloat {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-10px, -5px) scale(1.02); }
        }

        .welcome-card h3 {
            color: #1e40af;
            margin-bottom: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            z-index: 2;
        }

        .welcome-card p {
            color: #64748b;
            margin: 0;
            font-weight: 400;
            position: relative;
            z-index: 2;
        }

        /* Photo Carousel */
        .photo-carousel {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 400px;
            margin: 20px auto;
            border-radius: 25px;
            overflow: hidden;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.15);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .carousel-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .carousel-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .carousel-slide.active {
            opacity: 1;
            transform: translateX(0);
        }

        .carousel-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.8s ease;
        }

        .carousel-slide.active img {
            transform: scale(1.05);
        }

        .photo-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            color: white;
            padding: 40px 30px 30px;
            transform: translateY(100%);
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .carousel-slide.active .photo-info {
            transform: translateY(0);
        }

        .photo-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .photo-description {
            font-size: 1rem;
            opacity: 0.9;
            line-height: 1.5;
        }

        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .carousel-nav:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) scale(1.1);
        }

        .carousel-nav.prev {
            left: 20px;
        }

        .carousel-nav.next {
            right: 20px;
        }

        .carousel-indicators {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .indicator.active {
            background: white;
            transform: scale(1.2);
        }

        .carousel-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background: linear-gradient(90deg, #4a6cf7, #667eea);
            transition: width 0.1s ease;
            z-index: 10;
        }

        /* Charts and Statistics Styles */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 32px;
            margin-top: 24px;
        }

        .chart-container-mountain {
            height: 280px;
            background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            position: relative;
        }

        .chart-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
            margin-bottom: 24px;
            position: relative;
            min-width: 400px;
        }

        .chart-stats-inline {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-value-large {
            font-size: 2.2rem;
            font-weight: 800;
            color: #1e293b;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Features Grid */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .feature-card {
            background: var(--elevated-bg);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            border: 1px solid var(--glass-border);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .feature-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }

        .feature-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #4a6cf7 0%, #2e4ead 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 2rem;
            color: white;
        }

        .feature-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .feature-description {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Elevation components override for theme (ensures inline styles are themed) */
        .content-card,
        .stat-card,
        .sensor-card,
        .support-hours,
        .page-header {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
            color: var(--text-primary) !important;
        }

        /* Basic text theming within page content; keep photo captions white */
        body[data-theme="dark"] .page-content h1,
        body[data-theme="dark"] .page-content h2,
        body[data-theme="dark"] .page-content h3,
        body[data-theme="dark"] .page-content h4,
        body[data-theme="dark"] .page-content h5,
        body[data-theme="dark"] .page-content h6 {
            color: var(--text-primary) !important;
        }

        body[data-theme="dark"] .page-content p,
        body[data-theme="dark"] .page-content span {
            color: var(--text-secondary) !important;
        }

        body[data-theme="dark"] .page-content .photo-info,
        body[data-theme="dark"] .page-content .photo-info * {
            color: white !important;
        }

        /* Dark mode for sensor cards and charts */
        body[data-theme="dark"] .stat-card,
        body[data-theme="dark"] .sensor-card,
        body[data-theme="dark"] .content-card {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
            color: var(--text-primary) !important;
        }

        body[data-theme="dark"] .stat-card h3,
        body[data-theme="dark"] .sensor-card h3,
        body[data-theme="dark"] .content-card h3 {
            color: var(--text-primary) !important;
        }

        body[data-theme="dark"] .stat-card .value,
        body[data-theme="dark"] .sensor-card .value {
            color: var(--text-primary) !important;
        }

        body[data-theme="dark"] .stat-card .label,
        body[data-theme="dark"] .sensor-card .label {
            color: var(--text-secondary) !important;
        }

        /* Dark mode for welcome section */
        body[data-theme="dark"] .welcome-card,
        body[data-theme="dark"] .hero-section {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        body[data-theme="dark"] .welcome-card h1,
        body[data-theme="dark"] .welcome-card h2,
        body[data-theme="dark"] .hero-section h1,
        body[data-theme="dark"] .hero-section h2 {
            color: var(--text-primary) !important;
        }

        body[data-theme="dark"] .welcome-card p,
        body[data-theme="dark"] .hero-section p {
            color: var(--text-secondary) !important;
        }

        /* Dark mode for charts container */
        body[data-theme="dark"] .chart-container,
        body[data-theme="dark"] .chart-container-mountain {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        body[data-theme="dark"] .chart-header h3 {
            color: var(--text-primary) !important;
        }

        /* Dark mode for actuator controls */
        body[data-theme="dark"] .actuator-card,
        body[data-theme="dark"] .control-card {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        body[data-theme="dark"] .actuator-card h3,
        body[data-theme="dark"] .control-card h3 {
            color: var(--text-primary) !important;
        }

        body[data-theme="dark"] .actuator-status,
        body[data-theme="dark"] .control-status {
            color: var(--text-secondary) !important;
        }

        /* Dark mode for streaming section */
        body[data-theme="dark"] .camera-container,
        body[data-theme="dark"] .stream-card {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        body[data-theme="dark"] .camera-controls,
        body[data-theme="dark"] .stream-controls {
            background: var(--elevated-bg) !important;
        }

        /* Dark mode for about section */
        body[data-theme="dark"] .feature-card,
        body[data-theme="dark"] .support-card {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        body[data-theme="dark"] .feature-card h3,
        body[data-theme="dark"] .support-card h3 {
            color: var(--text-primary) !important;
        }

        body[data-theme="dark"] .feature-card p,
        body[data-theme="dark"] .support-card p {
            color: var(--text-secondary) !important;
        }

        /* Dark mode for status indicators */
        body[data-theme="dark"] .status-indicator {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
            color: var(--text-primary) !important;
        }

        /* Dark mode for buttons and controls */
        body[data-theme="dark"] .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%) !important;
            border: 1px solid #2563eb !important;
        }

        body[data-theme="dark"] .btn-secondary {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
            color: var(--text-primary) !important;
        }

        /* Dark mode for form elements */
        body[data-theme="dark"] input,
        body[data-theme="dark"] select,
        body[data-theme="dark"] textarea {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
            color: var(--text-primary) !important;
        }

        /* Dark mode for tables */
        body[data-theme="dark"] table {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        body[data-theme="dark"] th,
        body[data-theme="dark"] td {
            border-color: var(--elevated-border) !important;
            color: var(--text-primary) !important;
        }

        /* Dark mode for AI recommendations and system components */
        body[data-theme="dark"] .ai-card,
        body[data-theme="dark"] .recommendation-card,
        body[data-theme="dark"] .system-card,
        body[data-theme="dark"] .info-card {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
            color: var(--text-primary) !important;
        }

        body[data-theme="dark"] .ai-card h3,
        body[data-theme="dark"] .recommendation-card h3,
        body[data-theme="dark"] .system-card h3,
        body[data-theme="dark"] .info-card h3 {
            color: var(--text-primary) !important;
        }

        body[data-theme="dark"] .ai-card p,
        body[data-theme="dark"] .recommendation-card p,
        body[data-theme="dark"] .system-card p,
        body[data-theme="dark"] .info-card p {
            color: var(--text-secondary) !important;
        }

        /* Dark mode for confidence scores and indicators */
        body[data-theme="dark"] .confidence-score,
        body[data-theme="dark"] .score-indicator,
        body[data-theme="dark"] .metric-value {
            color: var(--text-primary) !important;
        }

        /* Dark mode for progress bars and sliders */
        body[data-theme="dark"] .progress-bar {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        body[data-theme="dark"] .progress-fill {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%) !important;
        }

        /* Dark mode for alerts and notifications */
        body[data-theme="dark"] .alert,
        body[data-theme="dark"] .notification,
        body[data-theme="dark"] .warning-card {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
            color: var(--text-primary) !important;
        }

        /* Dark mode for ESP32 system info display */
        body[data-theme="dark"] .esp32-info,
        body[data-theme="dark"] .system-status,
        body[data-theme="dark"] .connection-status {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
            color: var(--text-primary) !important;
        }

        body[data-theme="dark"] div[style*="background: #ffffff; border-radius: 16px; padding: 24px"] {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        body[data-theme="dark"] div[style*="background: #f8fafc; border-radius: 12px"] {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        body[data-theme="dark"] div[style*="height: 280px; background: #ffffff"] {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        body[data-theme="dark"] div[style*="background: #ffffff; border-radius: 16px; padding: 20px"] {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        /* Dark mode for data grid and lists */
        body[data-theme="dark"] .data-grid,
        body[data-theme="dark"] .sensor-list,
        body[data-theme="dark"] .actuator-list {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        body[data-theme="dark"] .data-row,
        body[data-theme="dark"] .list-item {
            border-color: var(--elevated-border) !important;
            color: var(--text-primary) !important;
        }

        body[data-theme="dark"] .data-row:hover,
        body[data-theme="dark"] .list-item:hover {
            background: rgba(255, 255, 255, 0.05) !important;
        }

        /* Dark mode for modal dialogs */
        body[data-theme="dark"] .modal,
        body[data-theme="dark"] .dialog {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
            color: var(--text-primary) !important;
        }

        body[data-theme="dark"] .modal-header,
        body[data-theme="dark"] .dialog-header {
            border-color: var(--elevated-border) !important;
            color: var(--text-primary) !important;
        }

        /* Dark mode for tooltips */
        body[data-theme="dark"] .tooltip {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
            color: var(--text-primary) !important;
        }

        /* Dark mode for badges and tags */
        body[data-theme="dark"] .badge,
        body[data-theme="dark"] .tag,
        body[data-theme="dark"] .chip {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
            color: var(--text-primary) !important;
        }

        /* Dark mode for loading states */
        body[data-theme="dark"] .loading,
        body[data-theme="dark"] .spinner {
            background: var(--elevated-bg) !important;
            border-color: var(--elevated-border) !important;
        }

        /* Dark mode for chart legends and labels */
        body[data-theme="dark"] .chart-legend,
        body[data-theme="dark"] .chart-label {
            color: var(--text-primary) !important;
        }

        /* Dark mode for sidebar content when visible */
        body[data-theme="dark"] .sidebar-content,
        body[data-theme="dark"] .menu-content {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
            color: var(--text-primary) !important;
        }

        /* Force dark mode for sensor cards with inline styles */
        body[data-theme="dark"] .sensors-grid > div,
        body[data-theme="dark"] .stats-overview > div,
        body[data-theme="dark"] .actuators-grid > div,
        body[data-theme="dark"] .charts-grid > div {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        /* Force dark mode for chart containers */
        body[data-theme="dark"] .chart-container-mountain,
        body[data-theme="dark"] .chart-card {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        /* Force dark mode text colors for inline styled elements */
        body[data-theme="dark"] .stat-value,
        body[data-theme="dark"] .sensor-value,
        body[data-theme="dark"] .actuator-value {
            color: var(--text-primary) !important;
        }

        body[data-theme="dark"] .stat-label,
        body[data-theme="dark"] .sensor-label,
        body[data-theme="dark"] .actuator-label {
            color: var(--text-secondary) !important;
        }

        /* Override any white backgrounds in dark mode */
        body[data-theme="dark"] [style*="background: rgba(255, 255, 255"],
        body[data-theme="dark"] [style*="background: #ffffff"],
        body[data-theme="dark"] [style*="background: white"] {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        /* Override text colors in dark mode */
        body[data-theme="dark"] [style*="color: #1e293b"],
        body[data-theme="dark"] [style*="color: #374151"],
        body[data-theme="dark"] [style*="color: #4b5563"] {
            color: var(--text-primary) !important;
        }

        body[data-theme="dark"] [style*="color: #64748b"],
        body[data-theme="dark"] [style*="color: #6b7280"],
        body[data-theme="dark"] [style*="color: #9ca3af"] {
            color: var(--text-secondary) !important;
        }

        /* Force dark mode for all white background elements */
        body[data-theme="dark"] div[style*="background: #ffffff"],
        body[data-theme="dark"] div[style*="background:#ffffff"],
        body[data-theme="dark"] div[style*="background: white"],
        body[data-theme="dark"] div[style*="background:white"] {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        /* Specific targeting for system status and sensor chart areas */
        body[data-theme="dark"] .system-status-grid > div,
        body[data-theme="dark"] .sensor-charts-grid > div,
        body[data-theme="dark"] .home-content > div > div {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        /* Force dark backgrounds for any remaining chart containers */
        body[data-theme="dark"] canvas {
            background: transparent !important;
        }

        /* Override chart.js default backgrounds */
        body[data-theme="dark"] .chartjs-render-monitor {
            background: var(--elevated-bg) !important;
        }

        /* Ultra-specific overrides for stubborn white backgrounds */
        body[data-theme="dark"] div[style*="background: rgba(255, 255, 255, 0.95)"],
        body[data-theme="dark"] div[style*="background: rgba(255,255,255,0.95)"],
        body[data-theme="dark"] div[style*="background:rgba(255, 255, 255, 0.95)"],
        body[data-theme="dark"] div[style*="background:rgba(255,255,255,0.95)"] {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        /* Target all divs with white/light backgrounds in dark mode */
        body[data-theme="dark"] div[style*="background: #f"],
        body[data-theme="dark"] div[style*="background:#f"],
        body[data-theme="dark"] div[style*="background: rgb(255"],
        body[data-theme="dark"] div[style*="background:rgb(255"] {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        /* Force dark mode for system status cards specifically */
        body[data-theme="dark"] #systemStatusGrid div,
        body[data-theme="dark"] .system-info div,
        body[data-theme="dark"] .esp32-status div {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        /* Force dark mode for all chart parent containers */
        body[data-theme="dark"] .chart-wrapper,
        body[data-theme="dark"] .chart-parent,
        body[data-theme="dark"] .sensor-chart-container {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        /* Target specific system status section */
        body[data-theme="dark"] div[style*="background: #ffffff; border-radius: 16px"] {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        body[data-theme="dark"] div[style*="background: #f8fafc"] {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        /* Target sensor chart containers with exact inline styles */
        body[data-theme="dark"] div[style*="height: 280px"][style*="background: #ffffff"] {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        /* Override chart container backgrounds */
        body[data-theme="dark"] .chart-container,
        body[data-theme="dark"] .chart-card,
        body[data-theme="dark"] .chart-container-mountain {
            background: var(--elevated-bg) !important;
            border: 1px solid var(--elevated-border) !important;
        }

        /* Themed buttons override */
        .refresh-btn,
        .themed-button {
            background: var(--accent) !important;
            color: var(--btn-text) !important;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            position: fixed;
            bottom: 70px;
            right: 20px;
            z-index: 1100;
            width: 42px;
            height: 42px;
            background: var(--elevated-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            display: grid;
            place-items: center;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            transition: transform 0.2s ease, background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .theme-toggle:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 10px 28px rgba(0, 0, 0, 0.18);
        }

        .theme-toggle i {
            color: var(--accent);
            font-size: 18px;
            line-height: 1;
        }

        .theme-toggle .sun-icon { display: inline-block; }
        .theme-toggle .moon-icon { display: none; }
        [data-theme="dark"] .theme-toggle .sun-icon { display: none; }
        [data-theme="dark"] .theme-toggle .moon-icon { display: inline-block; }

        @media (max-width: 768px) {
            .theme-toggle {
                bottom: 60px;
                right: 16px;
            }
        }

        /* Assets tuning in dark */
        [data-theme="dark"] .bottom-logo { filter: none; }

        /* Scroll Animations */
        .scroll-animate {
            opacity: 0;
            transform: translateY(50px);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .scroll-animate.animate-in {
            opacity: 1;
            transform: translateY(0);
        }

        .scroll-animate-left {
            opacity: 0;
            transform: translateX(-50px);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .scroll-animate-left.animate-in {
            opacity: 1;
            transform: translateX(0);
        }

        .scroll-animate-right {
            opacity: 0;
            transform: translateX(50px);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .scroll-animate-right.animate-in {
            opacity: 1;
            transform: translateX(0);
        }

        .scroll-animate-scale {
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .scroll-animate-scale.animate-in {
            opacity: 1;
            transform: scale(1);
        }

        /* Hover Preview Cards */
        .hover-preview {
            position: relative;
            cursor: pointer;
        }

        .preview-card {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%) translateY(-100%) scale(0.8);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            min-width: 280px;
            max-width: 320px;
        }

        .hover-preview:hover .preview-card {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-100%) scale(1);
        }

        .preview-card h4 {
            margin: 0 0 8px 0;
            color: #2e4ead;
            font-size: 16px;
            font-weight: 600;
        }

        .preview-card p {
            margin: 0;
            color: #6b7280;
            font-size: 14px;
            line-height: 1.5;
        }

        .preview-card .preview-stats {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .preview-stat {
            text-align: center;
            flex: 1;
        }

        .preview-stat .value {
            font-size: 18px;
            font-weight: 700;
            color: #4a6cf7;
            display: block;
        }

        .preview-stat .label {
            font-size: 12px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Loading Skeleton Animations */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        .skeleton-text {
            height: 16px;
            margin: 8px 0;
        }

        .skeleton-title {
            height: 24px;
            width: 60%;
            margin: 12px 0;
        }

        .skeleton-card {
            height: 200px;
            border-radius: 16px;
            margin: 16px 0;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Page Headers */
        .page-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 0;
            background: linear-gradient(135deg, rgba(74, 108, 247, 0.1) 0%, rgba(46, 74, 173, 0.1) 100%);
            border-radius: 16px;
        }

        .page-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .page-header h1 i {
            color: #4a6cf7;
            font-size: 2rem;
        }

        .page-header p {
            color: #64748b;
            font-size: 1.1rem;
            margin: 0;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Content Cards */
        .content-card {
            transition: all 0.3s ease;
        }

        .content-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .wrapper .sidebar {
                width: 100%;
                transform: translateX(-100%);
            }

            .wrapper .sidebar.active {
                transform: translateX(0);
            }

            .main_container.sidebar-open {
                margin-left: 0;
            }

            .page-header h1 {
                font-size: 2rem;
                flex-direction: column;
                gap: 10px;
            }

            .stats-overview {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .sensors-grid,
            .actuators-grid,
            .cameras-grid,
            .charts-grid,
            .content-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Advanced Page Loader -->
    <div class="page-loader" id="pageLoader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <div class="loader-text" id="loaderText">Chargement...</div>
            <div class="loader-subtext" id="loaderSubtext">Préparation de la page</div>
            <div class="loader-progress">
                <div class="loader-progress-bar" id="progressBar"></div>
            </div>
        </div>
    </div>

    <!-- Top Marquee Banner -->
    <div class="top-marquee">
        <div class="top-scrolling-text">
            ✨ Bienvenue à Tataouine ✨ Température ambiante : 27.30°C • Humidité relative : 60.10% ✨ Welcome to Tataouine ✨ Ambient temperature : 27.30°C • Relative humidity : 60.10% ✨
        </div>
    </div>

    <!-- Theme Toggle Button -->
    <button class="theme-toggle" type="button" aria-label="Basculer le thème" onclick="toggleTheme()">
        <i class="fas fa-sun sun-icon" aria-hidden="true"></i>
        <i class="fas fa-moon moon-icon" aria-hidden="true"></i>
    </button>

    <div class="wrapper">
        <div class="top_navbar">
            <div class="hamburger" onclick="toggleSidebar()">
                <div></div>
                <div></div>
                <div></div>
            </div>
            <div class="top_menu">
                <div class="logo">
                    <img src="homeprima_files/ATSSEElogo.jpg" alt="ATSSEE Logo" class="logo-image">
                    <span class="logo-text">PRIMA</span>
                </div>
                
                <!-- ESP32 System Information -->
                <div class="esp32-info" id="esp32Info">
                    <div class="esp32-info-item">
                        <div class="esp32-status-indicator" id="systemStatus"></div>
                        <span class="esp32-info-value" id="systemStatusText">OK</span>
                    </div>
                    <div class="esp32-info-item">
                        <i class="fas fa-wifi"></i>
                        <span class="esp32-info-value" id="ipAddress">192.168.1.100</span>
                        <div class="info-badge" id="wifiBadge">WiFi</div>
                    </div>
                    <div class="esp32-info-item">
                        <i class="fas fa-signal"></i>
                        <span class="esp32-info-value" id="wifiSignal">-45 dBm</span>
                        <div class="signal-bars" id="signalBars">
                            <div class="bar"></div>
                            <div class="bar"></div>
                            <div class="bar"></div>
                            <div class="bar"></div>
                        </div>
                    </div>
                    <div class="esp32-info-item">
                        <i class="fas fa-microchip"></i>
                        <span class="esp32-info-value" id="cpuFreq">240 MHz</span>
                        <div class="cpu-load-bar" id="cpuLoadBar">
                            <div class="load-fill"></div>
                        </div>
                    </div>
                    <div class="esp32-info-item">
                        <i class="fas fa-memory"></i>
                        <span class="esp32-info-value" id="freeRam">128 KB</span>
                        <div class="ram-usage-bar" id="ramUsageBar">
                            <div class="usage-fill"></div>
                        </div>
                    </div>
                    <div class="esp32-info-item">
                        <i class="fas fa-hdd"></i>
                        <span class="esp32-info-value" id="flashUsage">2.1 MB</span>
                        <div class="info-badge flash-badge" id="flashBadge">Flash</div>
                    </div>
                    <div class="esp32-info-item">
                        <i class="fas fa-thermometer-half"></i>
                        <span class="esp32-info-value" id="cpuTemp">45°C</span>
                        <div class="temp-indicator" id="tempIndicator"></div>
                    </div>
                    <div class="esp32-info-item">
                        <i class="fas fa-clock"></i>
                        <span class="esp32-info-value" id="uptime">2h 15m</span>
                    </div>
                    <div class="esp32-info-item">
                        <i class="fas fa-tachometer-alt"></i>
                        <span class="esp32-info-value" id="sketchSize">1.2 MB</span>
                        <div class="info-badge sketch-badge">Sketch</div>
                    </div>
                    <div class="esp32-info-item">
                        <i class="fas fa-plug"></i>
                        <span class="esp32-info-value" id="powerStatus">3.3V</span>
                        <div class="power-indicator" id="powerIndicator"></div>
                    </div>
                    <div class="esp32-info-item">
                        <i class="fas fa-broadcast-tower"></i>
                        <span class="esp32-info-value" id="networkStatus">Connected</span>
                        <div class="network-activity" id="networkActivity">
                            <div class="activity-dot tx"></div>
                            <div class="activity-dot rx"></div>
                        </div>
                    </div>
                    <div class="esp32-info-item">
                        <i class="fas fa-database"></i>
                        <span class="esp32-info-value" id="sensorCount">8 Active</span>
                        <div class="sensor-status" id="sensorStatus">
                            <div class="sensor-dot" title="DHT11"></div>
                            <div class="sensor-dot" title="DS18B20"></div>
                            <div class="sensor-dot" title="MAX6675"></div>
                        </div>
                    </div>
                    <div class="esp32-info-item">
                        <i class="fas fa-cogs"></i>
                        <span class="esp32-info-value" id="actuatorCount">5 Ready</span>
                        <div class="actuator-status" id="actuatorStatus">
                            <div class="actuator-dot pump" title="Pump"></div>
                            <div class="actuator-dot light" title="Light"></div>
                            <div class="actuator-dot fan" title="Fan"></div>
                            <div class="actuator-dot heater" title="Heater"></div>
                            <div class="actuator-dot valve" title="Valve"></div>
                        </div>
                    </div>
                </div>
                
                <ul>
                    <li class="has-dropdown">
                        <a href="#" title="Alertes Système" class="nav-icon alerts" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                            <span class="alert-badge" id="alertBadge">0</span>
                        </a>
                        <div class="dropdown-menu dropdown-alerts" role="menu" aria-label="Alertes Système" aria-hidden="true">
                            <div class="dropdown-header">
                                <span>Alertes Système</span>
                                <div style="display: flex; gap: 8px;">
                                    <button class="dropdown-action" onclick="clearAllAlerts()" title="Effacer toutes les alertes" aria-label="Effacer toutes les alertes">
                                        <i class="fas fa-trash" aria-hidden="true"></i>
                                    </button>
                                    <button class="dropdown-action" onclick="refreshAlerts()" title="Actualiser les alertes" aria-label="Actualiser les alertes">
                                        <i class="fas fa-sync" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="dropdown-content" id="alertsContent">
                                <!-- Alerts will be populated here -->
                            </div>
                        </div>
                    </li>
                    <li class="has-dropdown">
                        <a href="#" title="Notifications" class="nav-icon notifications" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-bell" aria-hidden="true"></i>
                            <span class="notification-badge">3</span>
                        </a>
                        <div class="dropdown-menu dropdown-notifications" role="menu" aria-label="Notifications" aria-hidden="true">
                            <div class="dropdown-header">
                                <span>Notifications</span>
                                <button class="dropdown-action" data-action="mark-all-read" title="Tout marquer comme lu" aria-label="Tout marquer comme lu">
                                    <i class="fas fa-check-double" aria-hidden="true"></i>
                                </button>
                            </div>
                            <div class="dropdown-content">
                                <a href="#" class="dropdown-item" role="menuitem" tabindex="0">
                                    <span class="item-icon" style="--icon-bg:#e0f2fe;--icon-color:#0369a1"><i class="fas fa-video" aria-hidden="true"></i></span>
                                    <div class="item-info">
                                        <div class="item-title">Mouvement détecté - Serre A</div>
                                        <div class="item-meta">il y a 2 min</div>
                                    </div>
                                </a>
                                <a href="#" class="dropdown-item" role="menuitem" tabindex="0">
                                    <span class="item-icon" style="--icon-bg:#fee2e2;--icon-color:#b91c1c"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i></span>
                                    <div class="item-info">
                                        <div class="item-title">Caméra Périmètre en maintenance</div>
                                        <div class="item-meta">il y a 1 h</div>
                                    </div>
                                </a>
                                <a href="#" class="dropdown-item" role="menuitem" tabindex="0">
                                    <span class="item-icon" style="--icon-bg:#dcfce7;--icon-color:#166534"><i class="fas fa-check-circle" aria-hidden="true"></i></span>
                                    <div class="item-info">
                                        <div class="item-title">Enregistrement terminé - Serre B</div>
                                        <div class="item-meta">hier</div>
                                    </div>
                                </a>
                            </div>
                            <div class="dropdown-footer">
                                <a href="#" class="view-all">Voir toutes les notifications</a>
                            </div>
                        </div>
                    </li>
                    
                    <li class="has-dropdown">
                        <a href="#" title="Paramètres Avancés" class="nav-icon settings-advanced" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-cogs" aria-hidden="true"></i>
                        </a>
                        <div class="dropdown-menu dropdown-settings-advanced" role="menu" aria-label="Paramètres Avancés" aria-hidden="true">
                            <div class="dropdown-header settings-header">
                                <span>Paramètres Système</span>
                                <div class="settings-actions">
                                    <button class="dropdown-action" onclick="exportAllSettings()" title="Exporter" aria-label="Exporter les paramètres">
                                        <i class="fas fa-download" aria-hidden="true"></i>
                                    </button>
                                    <button class="dropdown-action" onclick="resetAllSettings()" title="Réinitialiser" aria-label="Réinitialiser les paramètres">
                                        <i class="fas fa-undo" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="dropdown-content settings-advanced-content">
                                <!-- Appearance Settings -->
                                <div class="settings-category">
                                    <div class="settings-category-header">
                                        <i class="fas fa-palette"></i>
                                        <span>Apparence</span>
                                        <button class="category-toggle">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </div>
                                    <div class="settings-category-content">
                                        <div class="setting-row">
                                            <div class="setting-info">
                                                <label>Thème de l'interface</label>
                                                <span class="setting-description">Choisir le thème visuel</span>
                                            </div>
                                            <div class="setting-control">
                                                <select id="themeSelector" onchange="changeAppTheme(this.value)">
                                                    <option value="auto">Automatique</option>
                                                    <option value="light">Clair</option>
                                                    <option value="dark">Sombre</option>
                                                    <option value="blue">Bleu Professionnel</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="setting-row">
                                            <div class="setting-info">
                                                <label>Couleur d'accent</label>
                                                <span class="setting-description">Couleur principale de l'interface</span>
                                            </div>
                                            <div class="setting-control">
                                                <div class="color-picker-group">
                                                    <input type="color" id="accentColor" value="#2563eb" onchange="changeAccentColor(this.value)">
                                                    <span class="color-preview" id="colorPreview"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="setting-row">
                                            <div class="setting-info">
                                                <label>Animations</label>
                                                <span class="setting-description">Activer les animations de l'interface</span>
                                            </div>
                                            <div class="setting-control">
                                                <div class="toggle-switch-advanced">
                                                    <input type="checkbox" id="enableAnimations" checked onchange="toggleAnimations(this.checked)">
                                                    <span class="toggle-slider"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="setting-row">
                                            <div class="setting-info">
                                                <label>Vitesse d'animation</label>
                                                <span class="setting-description">Contrôler la rapidité des animations</span>
                                            </div>
                                            <div class="setting-control">
                                                <div class="range-control">
                                                    <input type="range" id="animationSpeed" min="0.5" max="2" step="0.1" value="1" onchange="updateAnimationSpeed(this.value)">
                                                    <span class="range-value" id="animationSpeedValue">1.0x</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Data Management -->
                                <div class="settings-category">
                                    <div class="settings-category-header">
                                        <i class="fas fa-database"></i>
                                        <span>Gestion des Données</span>
                                        <button class="category-toggle">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </div>
                                    <div class="settings-category-content">
                                        <div class="setting-row">
                                            <div class="setting-info">
                                                <label>Intervalle de rafraîchissement</label>
                                                <span class="setting-description">Fréquence de mise à jour des données</span>
                                            </div>
                                            <div class="setting-control">
                                                <select id="refreshInterval" onchange="updateRefreshInterval(this.value)">
                                                    <option value="1000">1 seconde</option>
                                                    <option value="2000">2 secondes</option>
                                                    <option value="5000" selected>5 secondes</option>
                                                    <option value="10000">10 secondes</option>
                                                    <option value="30000">30 secondes</option>
                                                    <option value="60000">1 minute</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="setting-row">
                                            <div class="setting-info">
                                                <label>Points de données maximum</label>
                                                <span class="setting-description">Nombre maximum de points dans les graphiques</span>
                                            </div>
                                            <div class="setting-control">
                                                <div class="number-input-group">
                                                    <input type="number" id="maxDataPoints" min="50" max="1000" value="200" onchange="updateMaxDataPoints(this.value)">
                                                    <span class="input-unit">points</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="setting-row">
                                            <div class="setting-info">
                                                <label>Sauvegarde automatique</label>
                                                <span class="setting-description">Sauvegarder automatiquement les données</span>
                                            </div>
                                            <div class="setting-control">
                                                <div class="toggle-switch-advanced">
                                                    <input type="checkbox" id="autoSave" checked onchange="toggleAutoSave(this.checked)">
                                                    <span class="toggle-slider"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="setting-row">
                                            <div class="setting-info">
                                                <label>Compression des données</label>
                                                <span class="setting-description">Compresser les données pour économiser l'espace</span>
                                            </div>
                                            <div class="setting-control">
                                                <div class="toggle-switch-advanced">
                                                    <input type="checkbox" id="dataCompression" onchange="toggleDataCompression(this.checked)">
                                                    <span class="toggle-slider"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Notifications -->
                                <div class="settings-category">
                                    <div class="settings-category-header">
                                        <i class="fas fa-bell"></i>
                                        <span>Notifications</span>
                                        <button class="category-toggle">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </div>
                                    <div class="settings-category-content">
                                        <div class="setting-row">
                                            <div class="setting-info">
                                                <label>Notifications bureau</label>
                                                <span class="setting-description">Afficher les notifications système</span>
                                            </div>
                                            <div class="setting-control">
                                                <div class="toggle-switch-advanced">
                                                    <input type="checkbox" id="desktopNotifications" onchange="toggleDesktopNotifications(this.checked)">
                                                    <span class="toggle-slider"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="setting-row">
                                            <div class="setting-info">
                                                <label>Sons de notification</label>
                                                <span class="setting-description">Jouer des sons pour les alertes</span>
                                            </div>
                                            <div class="setting-control">
                                                <div class="toggle-switch-advanced">
                                                    <input type="checkbox" id="notificationSounds" checked onchange="toggleNotificationSounds(this.checked)">
                                                    <span class="toggle-slider"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="setting-row">
                                            <div class="setting-info">
                                                <label>Seuil d'alerte température</label>
                                                <span class="setting-description">Température critique en °C</span>
                                            </div>
                                            <div class="setting-control">
                                                <div class="number-input-group">
                                                    <input type="number" id="tempThreshold" min="0" max="60" value="35" onchange="updateTempThreshold(this.value)">
                                                    <span class="input-unit">°C</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="setting-row">
                                            <div class="setting-info">
                                                <label>Seuil d'alerte humidité</label>
                                                <span class="setting-description">Humidité critique en %</span>
                                            </div>
                                            <div class="setting-control">
                                                <div class="number-input-group">
                                                    <input type="number" id="humidityThreshold" min="0" max="100" value="80" onchange="updateHumidityThreshold(this.value)">
                                                    <span class="input-unit">%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- System Controls -->
                                <div class="settings-category">
                                    <div class="settings-category-header">
                                        <i class="fas fa-cogs"></i>
                                        <span>Contrôles Système</span>
                                        <button class="category-toggle">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </div>
                                    <div class="settings-category-content">
                                        <div class="setting-row">
                                            <div class="setting-info">
                                                <label>Mode debug</label>
                                                <span class="setting-description">Afficher les informations de débogage</span>
                                            </div>
                                            <div class="setting-control">
                                                <div class="toggle-switch-advanced">
                                                    <input type="checkbox" id="debugMode" onchange="toggleDebugMode(this.checked)">
                                                    <span class="toggle-slider"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="setting-row">
                                            <div class="setting-info">
                                                <label>Logs détaillés</label>
                                                <span class="setting-description">Enregistrer des logs détaillés</span>
                                            </div>
                                            <div class="setting-control">
                                                <div class="toggle-switch-advanced">
                                                    <input type="checkbox" id="verboseLogs" onchange="toggleVerboseLogs(this.checked)">
                                                    <span class="toggle-slider"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="setting-row">
                                            <div class="setting-info">
                                                <label>Taille du cache</label>
                                                <span class="setting-description">Mémoire allouée au cache</span>
                                            </div>
                                            <div class="setting-control">
                                                <div class="range-control">
                                                    <input type="range" id="cacheSize" min="10" max="500" value="100" onchange="updateCacheSize(this.value)">
                                                    <span class="range-value" id="cacheSizeValue">100 MB</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="setting-row action-row">
                                            <button class="settings-action-btn primary" onclick="restartSystem()">
                                                <i class="fas fa-power-off"></i>
                                                Redémarrer le système
                                            </button>
                                        </div>
                                        <div class="setting-row action-row">
                                            <button class="settings-action-btn warning" onclick="clearCache()">
                                                <i class="fas fa-broom"></i>
                                                Vider le cache
                                            </button>
                                        </div>
                                        <div class="setting-row action-row">
                                            <button class="settings-action-btn danger" onclick="factoryReset()">
                                                <i class="fas fa-exclamation-triangle"></i>
                                                Réinitialisation complète
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Data Export/Import -->
                                <div class="settings-category">
                                    <div class="settings-category-header">
                                        <i class="fas fa-exchange-alt"></i>
                                        <span>Import/Export</span>
                                        <button class="category-toggle">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </div>
                                    <div class="settings-category-content">
                                        <div class="setting-row action-row">
                                            <button class="settings-action-btn success" onclick="exportData('json')">
                                                <i class="fas fa-file-code"></i>
                                                Exporter données (JSON)
                                            </button>
                                        </div>
                                        <div class="setting-row action-row">
                                            <button class="settings-action-btn success" onclick="exportData('csv')">
                                                <i class="fas fa-file-csv"></i>
                                                Exporter données (CSV)
                                            </button>
                                        </div>
                                        <div class="setting-row action-row">
                                            <button class="settings-action-btn info" onclick="exportSettings()">
                                                <i class="fas fa-cog"></i>
                                                Exporter paramètres
                                            </button>
                                        </div>
                                        <div class="setting-row">
                                            <div class="setting-info">
                                                <label>Importer paramètres</label>
                                                <span class="setting-description">Restaurer depuis un fichier</span>
                                            </div>
                                            <div class="setting-control">
                                                <input type="file" id="importSettings" accept=".json" onchange="importSettings(this.files[0])" style="display: none;">
                                                <button class="settings-file-btn" onclick="document.getElementById('importSettings').click()">
                                                    <i class="fas fa-upload"></i>
                                                    Choisir fichier
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                    
                </ul>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <ul>
                <li><a href="#" onclick="loadPage('home')" class="nav-link active">
                    <span class="icon"><i class="fas fa-home"></i></span>
                    <span class="title">Accueil</span>
                </a></li>
                <li class="has-submenu">
                    <a href="#" onclick="toggleSubmenu(this)" class="nav-link">
                        <span class="icon"><i class="fas fa-chart-bar"></i></span>
                        <span class="title">Capteurs et Statistiques</span>
                        <span class="arrow"><i class="fas fa-chevron-right"></i></span>
                    </a>
                    <ul class="submenu">
                        <li><a href="#" onclick="loadPage('sensors')"><i class="fas fa-thermometer-half"></i>&nbsp;&nbsp;Capteurs</a></li>
                        <li><a href="#" onclick="loadPage('supervision')"><i class="fas fa-chart-line"></i>&nbsp;&nbsp;Statistiques</a></li>
                        <li><a href="#" onclick="loadPage('historical')"><i class="fas fa-history"></i>&nbsp;&nbsp;Historique</a></li>
                    </ul>
                </li>
                <li><a href="#" onclick="loadPage('commande')" class="nav-link">
                    <span class="icon"><i class="fas fa-power-off"></i></span>
                    <span class="title">Actionneurs</span>
                </a></li>
                <li><a href="#" onclick="loadPage('camera')" class="nav-link">
                    <span class="icon"><i class="fas fa-file-video"></i></span>
                    <span class="title">Streaming</span>
                </a></li>
                <li><a href="#" onclick="loadPage('contact')" class="nav-link">
                    <span class="icon"><i class="fas fa-leaf"></i></span>
                    <span class="title">À propos</span>
                </a></li>
            </ul>
        </div>
    </div>

    <!-- Main Content Container -->
    <div class="main_container page-content" id="mainContainer">
        <div id="app">
            <!-- Content will be dynamically loaded here -->
        </div>
    </div>

    <!-- Bottom Marquee Banner -->
    <div class="bottom-marquee">
        <div class="bottom-scrolling-text">
            <img src="homeprima_files/PRIMA-removebg-preview.png" alt="PRIMA Logo" class="bottom-logo"> ℹ️ À propos de PRIMA : PRIMA (Precision Agriculture Management System) est une solution innovante de gestion intelligente pour l'agriculture de précision. • About PRIMA: PRIMA is an innovative intelligent management solution for precision agriculture. <img src="homeprima_files/PRIMA-removebg-preview.png" alt="PRIMA Logo" class="bottom-logo"> ℹ️
        </div>
    </div>

    <script>
        // Global variables
        const app = document.getElementById('app');
        const pageLoader = document.getElementById('pageLoader');
        const loaderText = document.getElementById('loaderText');
        const loaderSubtext = document.getElementById('loaderSubtext');
        const progressBar = document.getElementById('progressBar');
        const mainContainer = document.getElementById('mainContainer');
        const sidebar = document.getElementById('sidebar');

        // Theme toggle and persistence
        function applyTheme(theme) {
            const root = document.documentElement;
            const body = document.body;
            root.setAttribute('data-theme', theme);
            body.setAttribute('data-theme', theme);
            
            // Force dark mode styling for elements with inline white backgrounds
            if (theme === 'dark') {
                setTimeout(() => {
                    const whiteElements = document.querySelectorAll('div[style*="background: #ffffff"], div[style*="background: rgba(255, 255, 255"], div[style*="background: white"], div[style*="background:#ffffff"]');
                    whiteElements.forEach(el => {
                        el.style.setProperty('background', 'rgba(17, 24, 39, 0.8)', 'important');
                        el.style.setProperty('border', '1px solid rgba(55, 65, 81, 0.3)', 'important');
                        el.style.setProperty('backdrop-filter', 'blur(20px)', 'important');
                    });
                    
                    const lightBgElements = document.querySelectorAll('div[style*="background: #f8fafc"], div[style*="background: #f1f5f9"]');
                    lightBgElements.forEach(el => {
                        el.style.setProperty('background', 'rgba(255, 255, 255, 0.05)', 'important');
                        el.style.setProperty('border', '1px solid rgba(55, 65, 81, 0.3)', 'important');
                    });
                    
                    const darkTextElements = document.querySelectorAll('[style*="color: #1e293b"], [style*="color: #374151"], [style*="color: #4b5563"]');
                    darkTextElements.forEach(el => {
                        el.style.setProperty('color', '#f8fafc', 'important');
                    });
                    
                    const grayTextElements = document.querySelectorAll('[style*="color: #64748b"], [style*="color: #6b7280"], [style*="color: #9ca3af"]');
                    grayTextElements.forEach(el => {
                        el.style.setProperty('color', '#94a3b8', 'important');
                    });
                }, 100);
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') ||
                (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            const nextTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(nextTheme);
            try { localStorage.setItem('theme', nextTheme); } catch (e) {}
            
            // Update charts for new theme
            updateChartsForTheme(nextTheme);
        }

        function loadSavedTheme() {
            let savedTheme = null;
            try { savedTheme = localStorage.getItem('theme'); } catch (e) {}
            if (savedTheme === 'light' || savedTheme === 'dark') {
                applyTheme(savedTheme);
            } else {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(prefersDark ? 'dark' : 'light');
            }
            
            // Apply dark mode overrides after page load if needed
            setTimeout(() => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                if (currentTheme === 'dark') {
                    applyTheme('dark');
                }
            }, 500);
        }

        // Settings Management
        let settingsData = {
            theme: 'auto',
            animationSpeed: 1,
            enableTransitions: true,
            dataRefreshRate: 30,
            maxDataPoints: 100,
            enableAutoRefresh: true,
            enableSounds: true,
            enableDesktopNotifs: false,
            alertThreshold: 30,
            enableDebugMode: false,
            cacheSize: 50
        };

        function loadSettings() {
            try {
                const saved = localStorage.getItem('primaSettings');
                if (saved) {
                    settingsData = { ...settingsData, ...JSON.parse(saved) };
                }
            } catch (e) {
                console.warn('Failed to load settings:', e);
            }
            try {
                applySettings();
            } catch (e) {
                // If applySettings fails (missing DOM nodes), log but don't break the UI.
                console.warn('applySettings failed:', e);
            }
        }

        function saveSettings() {
            try {
                localStorage.setItem('primaSettings', JSON.stringify(settingsData));
            } catch (e) {
                console.warn('Failed to save settings:', e);
            }
        }

        function applySettings() {
            // Update UI elements (guarded - some edits might remove elements)
            const themeSelect = document.getElementById('themeSelect');
            const animationSpeedEl = document.getElementById('animationSpeed');
            const animationSpeedValue = document.getElementById('animationSpeedValue');
            const enableTransitionsEl = document.getElementById('enableTransitions');
            const dataRefreshRateEl = document.getElementById('dataRefreshRate');
            const maxDataPointsEl = document.getElementById('maxDataPoints');
            const enableAutoRefreshEl = document.getElementById('enableAutoRefresh');
            const enableSoundsEl = document.getElementById('enableSounds');
            const enableDesktopNotifsEl = document.getElementById('enableDesktopNotifs');
            const alertThresholdEl = document.getElementById('alertThreshold');
            const enableDebugModeEl = document.getElementById('enableDebugMode');
            const cacheSizeEl = document.getElementById('cacheSize');

            if (themeSelect) themeSelect.value = settingsData.theme;
            if (animationSpeedEl) animationSpeedEl.value = settingsData.animationSpeed;
            if (animationSpeedValue) animationSpeedValue.textContent = settingsData.animationSpeed + 'x';
            if (enableTransitionsEl) enableTransitionsEl.checked = !!settingsData.enableTransitions;
            if (dataRefreshRateEl) dataRefreshRateEl.value = settingsData.dataRefreshRate;
            if (maxDataPointsEl) maxDataPointsEl.value = settingsData.maxDataPoints;
            if (enableAutoRefreshEl) enableAutoRefreshEl.checked = !!settingsData.enableAutoRefresh;
            if (enableSoundsEl) enableSoundsEl.checked = !!settingsData.enableSounds;
            if (enableDesktopNotifsEl) enableDesktopNotifsEl.checked = !!settingsData.enableDesktopNotifs;
            if (alertThresholdEl) alertThresholdEl.value = settingsData.alertThreshold;
            if (enableDebugModeEl) enableDebugModeEl.checked = !!settingsData.enableDebugMode;
            if (cacheSizeEl) cacheSizeEl.value = settingsData.cacheSize;

            // Apply animation speed (always safe)
            try {
                document.documentElement.style.setProperty('--animation-speed', settingsData.animationSpeed);
            } catch (e) {
                console.warn('Failed to set animation speed CSS variable', e);
            }
            
            // Apply transitions and debug mode to body safely
            if (settingsData.enableTransitions === false) {
                document.body.classList.add('no-transitions');
            } else {
                document.body.classList.remove('no-transitions');
            }

            if (settingsData.enableDebugMode) {
                document.body.classList.add('debug-mode');
                console.log('Debug mode enabled');
            } else {
                document.body.classList.remove('debug-mode');
            }
        }

        function toggleSettingsDropdown(event) {
            try {
                event.preventDefault();
                event.stopPropagation();

                const dropdown = event.currentTarget && event.currentTarget.closest ? event.currentTarget.closest('.has-dropdown') : null;
                if (!dropdown) return; // nothing to toggle

                const isOpen = dropdown.classList.contains('open');

                // Close other dropdowns
                document.querySelectorAll('.has-dropdown.open').forEach(item => {
                    if (item !== dropdown) item.classList.remove('open');
                });

                // Toggle current dropdown
                dropdown.classList.toggle('open');

                // Load settings after opening, but guard applySettings errors
                if (!isOpen) {
                    try {
                        loadSettings(); // refresh settings when opening
                    } catch (e) {
                        console.warn('loadSettings failed:', e);
                    }
                }
            } catch (e) {
                console.warn('toggleSettingsDropdown error:', e);
            }
        }

        // Advanced Settings Data Management
        let advancedSettingsData = {
            theme: 'auto',
            accentColor: '#2563eb',
            enableAnimations: true,
            animationSpeed: 1.0,
            refreshInterval: 5000,
            maxDataPoints: 200,
            autoSave: true,
            dataCompression: false,
            desktopNotifications: false,
            notificationSounds: true,
            tempThreshold: 35,
            humidityThreshold: 80,
            debugMode: false,
            verboseLogs: false,
            cacheSize: 100
        };

        // Load advanced settings from localStorage
        function loadAdvancedSettings() {
            try {
                const saved = localStorage.getItem('primaAdvancedSettings');
                if (saved) {
                    advancedSettingsData = { ...advancedSettingsData, ...JSON.parse(saved) };
                }
                applyAdvancedSettings();
            } catch (e) {
                console.warn('Failed to load advanced settings:', e);
            }
        }

        // Save advanced settings to localStorage
        function saveAdvancedSettings() {
            try {
                localStorage.setItem('primaAdvancedSettings', JSON.stringify(advancedSettingsData));
                showNotification('Paramètres sauvegardés', 'success');
            } catch (e) {
                console.warn('Failed to save advanced settings:', e);
                showNotification('Erreur de sauvegarde', 'error');
            }
        }

        // Apply advanced settings to UI
        function applyAdvancedSettings() {
            // Theme
            const themeSelector = document.getElementById('themeSelector');
            if (themeSelector) themeSelector.value = advancedSettingsData.theme;

            // Accent Color
            const accentColor = document.getElementById('accentColor');
            const colorPreview = document.getElementById('colorPreview');
            if (accentColor) accentColor.value = advancedSettingsData.accentColor;
            if (colorPreview) colorPreview.style.background = advancedSettingsData.accentColor;

            // Animations
            const enableAnimations = document.getElementById('enableAnimations');
            if (enableAnimations) enableAnimations.checked = advancedSettingsData.enableAnimations;

            // Animation Speed
            const animationSpeed = document.getElementById('animationSpeed');
            const animationSpeedValue = document.getElementById('animationSpeedValue');
            if (animationSpeed) animationSpeed.value = advancedSettingsData.animationSpeed;
            if (animationSpeedValue) animationSpeedValue.textContent = advancedSettingsData.animationSpeed + 'x';

            // Data Management
            const refreshInterval = document.getElementById('refreshInterval');
            if (refreshInterval) refreshInterval.value = advancedSettingsData.refreshInterval;

            const maxDataPoints = document.getElementById('maxDataPoints');
            if (maxDataPoints) maxDataPoints.value = advancedSettingsData.maxDataPoints;

            const autoSave = document.getElementById('autoSave');
            if (autoSave) autoSave.checked = advancedSettingsData.autoSave;

            const dataCompression = document.getElementById('dataCompression');
            if (dataCompression) dataCompression.checked = advancedSettingsData.dataCompression;

            // Notifications
            const desktopNotifications = document.getElementById('desktopNotifications');
            if (desktopNotifications) desktopNotifications.checked = advancedSettingsData.desktopNotifications;

            const notificationSounds = document.getElementById('notificationSounds');
            if (notificationSounds) notificationSounds.checked = advancedSettingsData.notificationSounds;

            const tempThreshold = document.getElementById('tempThreshold');
            if (tempThreshold) tempThreshold.value = advancedSettingsData.tempThreshold;

            const humidityThreshold = document.getElementById('humidityThreshold');
            if (humidityThreshold) humidityThreshold.value = advancedSettingsData.humidityThreshold;

            // System Controls
            const debugMode = document.getElementById('debugMode');
            if (debugMode) debugMode.checked = advancedSettingsData.debugMode;

            const verboseLogs = document.getElementById('verboseLogs');
            if (verboseLogs) verboseLogs.checked = advancedSettingsData.verboseLogs;

            const cacheSize = document.getElementById('cacheSize');
            const cacheSizeValue = document.getElementById('cacheSizeValue');
            if (cacheSize) cacheSize.value = advancedSettingsData.cacheSize;
            if (cacheSizeValue) cacheSizeValue.textContent = advancedSettingsData.cacheSize + ' MB';

            // Apply CSS variables and classes
            document.documentElement.style.setProperty('--accent-color', advancedSettingsData.accentColor);
            document.documentElement.style.setProperty('--animation-speed', advancedSettingsData.animationSpeed);
            
            if (!advancedSettingsData.enableAnimations) {
                document.body.classList.add('no-transitions');
            } else {
                document.body.classList.remove('no-transitions');
            }

            if (advancedSettingsData.debugMode) {
                document.body.classList.add('debug-mode');
            } else {
                document.body.classList.remove('debug-mode');
            }
        }

        // Advanced settings functions
        function changeAppTheme(value) {
            advancedSettingsData.theme = value;
            saveAdvancedSettings();
            
            if (value === 'auto') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(prefersDark ? 'dark' : 'light');
            } else if (value === 'blue') {
                document.documentElement.setAttribute('data-theme', 'light');
                document.documentElement.style.setProperty('--primary-color', '#2563eb');
                document.documentElement.style.setProperty('--secondary-color', '#1d4ed8');
            } else {
                applyTheme(value);
            }
        }

        function changeAccentColor(color) {
            advancedSettingsData.accentColor = color;
            document.documentElement.style.setProperty('--accent-color', color);
            const colorPreview = document.getElementById('colorPreview');
            if (colorPreview) colorPreview.style.background = color;
            saveAdvancedSettings();
        }

        function toggleAnimations(enabled) {
            advancedSettingsData.enableAnimations = enabled;
            if (!enabled) {
                document.body.classList.add('no-transitions');
            } else {
                document.body.classList.remove('no-transitions');
            }
            saveAdvancedSettings();
        }

        function updateAnimationSpeed(value) {
            advancedSettingsData.animationSpeed = parseFloat(value);
            const speedValue = document.getElementById('animationSpeedValue');
            if (speedValue) speedValue.textContent = value + 'x';
            document.documentElement.style.setProperty('--animation-speed', value);
            saveAdvancedSettings();
        }

        function updateRefreshInterval(value) {
            advancedSettingsData.refreshInterval = parseInt(value);
            saveAdvancedSettings();
            showNotification(`Intervalle mis à jour: ${value/1000}s`, 'info');
        }

        function updateMaxDataPoints(value) {
            advancedSettingsData.maxDataPoints = parseInt(value);
            saveAdvancedSettings();
            showNotification(`Points de données max: ${value}`, 'info');
        }

        function toggleAutoSave(enabled) {
            advancedSettingsData.autoSave = enabled;
            saveAdvancedSettings();
            showNotification(`Sauvegarde auto: ${enabled ? 'Activée' : 'Désactivée'}`, 'info');
        }

        function toggleDataCompression(enabled) {
            advancedSettingsData.dataCompression = enabled;
            saveAdvancedSettings();
            showNotification(`Compression: ${enabled ? 'Activée' : 'Désactivée'}`, 'info');
        }

        function toggleDesktopNotifications(enabled) {
            advancedSettingsData.desktopNotifications = enabled;
            if (enabled && 'Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showNotification('Notifications bureau activées', 'success');
                        new Notification('PRIMA', {
                            body: 'Notifications bureau activées avec succès!',
                            icon: 'homeprima_files/PRIMA-removebg-preview.png'
                        });
                    } else {
                        advancedSettingsData.desktopNotifications = false;
                        const desktopNotifs = document.getElementById('desktopNotifications');
                        if (desktopNotifs) desktopNotifs.checked = false;
                        showNotification('Permission refusée', 'error');
                    }
                });
            }
            saveAdvancedSettings();
        }

        function toggleNotificationSounds(enabled) {
            advancedSettingsData.notificationSounds = enabled;
            saveAdvancedSettings();
            if (enabled) {
                playNotificationSound();
            }
            showNotification(`Sons: ${enabled ? 'Activés' : 'Désactivés'}`, 'info');
        }

        function updateTempThreshold(value) {
            advancedSettingsData.tempThreshold = parseInt(value);
            saveAdvancedSettings();
            showNotification(`Seuil température: ${value}°C`, 'info');
        }

        function updateHumidityThreshold(value) {
            advancedSettingsData.humidityThreshold = parseInt(value);
            saveAdvancedSettings();
            showNotification(`Seuil humidité: ${value}%`, 'info');
        }

        function toggleDebugMode(enabled) {
            advancedSettingsData.debugMode = enabled;
            if (enabled) {
                document.body.classList.add('debug-mode');
                console.log('Debug mode enabled');
            } else {
                document.body.classList.remove('debug-mode');
            }
            saveAdvancedSettings();
            showNotification(`Mode debug: ${enabled ? 'Activé' : 'Désactivé'}`, 'info');
        }

        function toggleVerboseLogs(enabled) {
            advancedSettingsData.verboseLogs = enabled;
            saveAdvancedSettings();
            showNotification(`Logs détaillés: ${enabled ? 'Activés' : 'Désactivés'}`, 'info');
        }

        function updateCacheSize(value) {
            advancedSettingsData.cacheSize = parseInt(value);
            const cacheSizeValue = document.getElementById('cacheSizeValue');
            if (cacheSizeValue) cacheSizeValue.textContent = value + ' MB';
            saveAdvancedSettings();
            showNotification(`Taille cache: ${value} MB`, 'info');
        }

        function restartSystem() {
            if (confirm('Êtes-vous sûr de vouloir redémarrer le système?')) {
                showNotification('Redémarrage du système...', 'warning');
                setTimeout(() => {
                    location.reload();
                }, 2000);
            }
        }

        function clearCache() {
            if (confirm('Vider le cache? Cette action supprimera les données temporaires.')) {
                try {
                    // Clear various caches
                    if ('caches' in window) {
                        caches.keys().then(names => {
                            names.forEach(name => caches.delete(name));
                        });
                    }
                    // Clear localStorage except settings
                    const settings = localStorage.getItem('primaAdvancedSettings');
                    localStorage.clear();
                    if (settings) localStorage.setItem('primaAdvancedSettings', settings);
                    
                    showNotification('Cache vidé avec succès', 'success');
                } catch (e) {
                    showNotification('Erreur lors du vidage du cache', 'error');
                }
            }
        }

        function factoryReset() {
            if (confirm('ATTENTION: Cette action supprimera TOUS les paramètres et données. Continuer?')) {
                if (confirm('Êtes-vous absolument certain? Cette action est irréversible!')) {
                    localStorage.clear();
                    sessionStorage.clear();
                    showNotification('Réinitialisation complète effectuée', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                }
            }
        }

        function exportData(format) {
            const data = {
                timestamp: new Date().toISOString(),
                settings: advancedSettingsData,
                sensorData: getSensorData(),
                version: '1.0'
            };

            let content, filename, mimeType;

            if (format === 'json') {
                content = JSON.stringify(data, null, 2);
                filename = `prima-data-${new Date().toISOString().split('T')[0]}.json`;
                mimeType = 'application/json';
            } else if (format === 'csv') {
                content = convertToCSV(data);
                filename = `prima-data-${new Date().toISOString().split('T')[0]}.csv`;
                mimeType = 'text/csv';
            }

            downloadFile(content, filename, mimeType);
            showNotification(`Données exportées: ${filename}`, 'success');
        }

        function exportSettings() {
            const settings = {
                timestamp: new Date().toISOString(),
                settings: advancedSettingsData,
                version: '1.0'
            };

            const content = JSON.stringify(settings, null, 2);
            const filename = `prima-settings-${new Date().toISOString().split('T')[0]}.json`;
            downloadFile(content, filename, 'application/json');
            showNotification('Paramètres exportés', 'success');
        }

        function exportAllSettings() {
            exportSettings();
        }

        function resetAllSettings() {
            if (confirm('Réinitialiser tous les paramètres aux valeurs par défaut?')) {
                advancedSettingsData = {
                    theme: 'auto',
                    accentColor: '#2563eb',
                    enableAnimations: true,
                    animationSpeed: 1.0,
                    refreshInterval: 5000,
                    maxDataPoints: 200,
                    autoSave: true,
                    dataCompression: false,
                    desktopNotifications: false,
                    notificationSounds: true,
                    tempThreshold: 35,
                    humidityThreshold: 80,
                    debugMode: false,
                    verboseLogs: false,
                    cacheSize: 100
                };
                saveAdvancedSettings();
                applyAdvancedSettings();
                showNotification('Paramètres réinitialisés', 'success');
            }
        }

        function importSettings(file) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.settings) {
                        advancedSettingsData = { ...advancedSettingsData, ...imported.settings };
                        saveAdvancedSettings();
                        applyAdvancedSettings();
                        showNotification('Paramètres importés avec succès', 'success');
                    } else {
                        showNotification('Format de fichier invalide', 'error');
                    }
                } catch (error) {
                    showNotification('Erreur lors de l\'importation', 'error');
                }
            };
            reader.readAsText(file);
        }

        function getSensorData() {
            // Return real sensor data fetched from ESP32 instead of hardcoded values
            // This function should be updated to use actual ESP32 data
            // For now, we'll use the updateSensorValues function which fetches real data
            return {
                temperature: parseFloat(document.getElementById('temperatureValue')?.textContent?.replace('°C', '') || '0') || 0,
                humidity: parseFloat(document.getElementById('humidityValue')?.textContent?.replace('%', '') || '0') || 0,
                soilMoisture: parseFloat(document.getElementById('soilValue')?.textContent?.replace('%', '') || '0') || 0
            };
        }

        function convertToCSV(data) {
            const headers = ['Timestamp', 'Temperature', 'Humidity', 'Soil Moisture'];
            const rows = [headers.join(',')];
            
            rows.push([
                data.timestamp,
                data.sensorData?.temperature || 0,
                data.sensorData?.humidity || 0,
                data.sensorData?.soilMoisture || 0
            ].join(','));
            
            return rows.join('\n');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function toggleCategory(button) {
            try {
                const header = button.closest('.settings-category-header');
                const content = header ? header.nextElementSibling : null;
                
                if (!content || !content.classList.contains('settings-category-content')) {
                    console.warn('Category content not found');
                    return;
                }
                
                const isExpanded = content.classList.contains('expanded');
                
                if (isExpanded) {
                    content.classList.remove('expanded');
                    button.classList.remove('rotated');
                } else {
                    content.classList.add('expanded');
                    button.classList.add('rotated');
                }
                
                console.log('Category toggled:', isExpanded ? 'collapsed' : 'expanded');
            } catch (e) {
                console.error('Error toggling category:', e);
            }
        }

        function changeTheme(value) {
            settingsData.theme = value;
            saveSettings();
            
            if (value === 'auto') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(prefersDark ? 'dark' : 'light');
            } else {
                applyTheme(value);
            }
            updateChartsForTheme(value === 'auto' ? 
                (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : value);
        }

        function updateAnimationSpeed(value) {
            settingsData.animationSpeed = parseFloat(value);
            document.getElementById('animationSpeedValue').textContent = value + 'x';
            document.documentElement.style.setProperty('--animation-speed', value);
            saveSettings();
        }

        function toggleTransitions(enabled) {
            settingsData.enableTransitions = enabled;
            if (!enabled) {
                document.body.classList.add('no-transitions');
            } else {
                document.body.classList.remove('no-transitions');
            }
            saveSettings();
        }

        function updateRefreshRate(value) {
            settingsData.dataRefreshRate = parseInt(value);
            saveSettings();
            
            // Restart auto-refresh with new rate
            if (settingsData.enableAutoRefresh && window.chartRefreshInterval) {
                clearInterval(window.chartRefreshInterval);
                startChartAutoRefresh();
            }
            
            showNotification('Taux de rafraîchissement mis à jour: ' + value + 's');
        }

        function updateMaxDataPoints(value) {
            settingsData.maxDataPoints = parseInt(value);
            saveSettings();
            showNotification('Maximum de points de données: ' + value);
        }

        function toggleAutoRefresh(enabled) {
            settingsData.enableAutoRefresh = enabled;
            saveSettings();
            
            if (enabled) {
                startChartAutoRefresh();
                showNotification('Rafraîchissement automatique activé');
            } else {
                if (window.chartRefreshInterval) {
                    clearInterval(window.chartRefreshInterval);
                }
                showNotification('Rafraîchissement automatique désactivé');
            }
        }

        function toggleSounds(enabled) {
            settingsData.enableSounds = enabled;
            saveSettings();
            
            if (enabled) {
                playNotificationSound();
                showNotification('Sons activés');
            } else {
                showNotification('Sons désactivés');
            }
        }

        function toggleDesktopNotifications(enabled) {
            settingsData.enableDesktopNotifs = enabled;
            saveSettings();
            
            if (enabled && 'Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        new Notification('PRIMA', {
                            body: 'Notifications bureau activées',
                            icon: './homeprima_files/PRIMA-removebg-preview.png'
                        });
                    }
                });
            }
            
            showNotification('Notifications bureau ' + (enabled ? 'activées' : 'désactivées'));
        }

        function updateAlertThreshold(value) {
            settingsData.alertThreshold = parseInt(value);
            saveSettings();
            showNotification('Seuil d\'alerte température: ' + value + '°C');
        }

        function toggleDebugMode(enabled) {
            settingsData.enableDebugMode = enabled;
            saveSettings();
            
            if (enabled) {
                document.body.classList.add('debug-mode');
                console.log('Debug mode enabled');
                showNotification('Mode debug activé - Vérifiez la console');
            } else {
                document.body.classList.remove('debug-mode');
                showNotification('Mode debug désactivé');
            }
        }

        function updateCacheSize(value) {
            settingsData.cacheSize = parseInt(value);
            saveSettings();
            showNotification('Taille du cache: ' + value + 'MB');
        }

        function clearAllData() {
            if (confirm('Êtes-vous sûr de vouloir effacer toutes les données? Cette action est irréversible.')) {
                try {
                    localStorage.clear();
                    sessionStorage.clear();
                    location.reload();
                } catch (e) {
                    console.error('Failed to clear data:', e);
                    showNotification('Erreur lors de l\'effacement des données', 'error');
                }
            }
        }

        function resetAllSettings() {
            if (confirm('Réinitialiser tous les paramètres aux valeurs par défaut?')) {
                settingsData = {
                    theme: 'auto',
                    animationSpeed: 1,
                    enableTransitions: true,
                    dataRefreshRate: 5,
                    maxDataPoints: 100,
                    enableAutoRefresh: true,
                    enableSounds: true,
                    enableDesktopNotifs: false,
                    alertThreshold: 30,
                    enableDebugMode: false,
                    cacheSize: 50
                };
                saveSettings();
                applySettings();
                showNotification('Paramètres réinitialisés');
            }
        }

        function exportSettings() {
            const dataStr = JSON.stringify(settingsData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'prima-settings.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('Paramètres exportés');
        }

        function playNotificationSound() {
            if (settingsData.enableSounds) {
                // Create a simple notification sound
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            }
        }

        function showNotification(message, type = 'info') {
            // Create a notification toast
            const toast = document.createElement('div');
            toast.className = `notification-toast ${type}`;
            toast.textContent = message;
            
            // Add toast styles if not already added
            if (!document.getElementById('toast-styles')) {
                const style = document.createElement('style');
                style.id = 'toast-styles';
                style.textContent = `
                    .notification-toast {
                        position: fixed;
                        top: 100px;
                        right: 20px;
                        background: var(--elevated-bg);
                        color: var(--text-primary);
                        padding: 12px 20px;
                        border-radius: 8px;
                        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
                        border: 1px solid var(--elevated-border);
                        z-index: 9999;
                        font-size: 14px;
                        font-weight: 500;
                        animation: slideInRight 0.3s ease;
                        max-width: 300px;
                        backdrop-filter: blur(10px);
                    }
                    .notification-toast.error {
                        border-left: 4px solid #ef4444;
                    }
                    .notification-toast.success {
                        border-left: 4px solid #10b981;
                    }
                    .notification-toast.info {
                        border-left: 4px solid #3b82f6;
                    }
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOutRight {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(toast);
            
            // Play sound if enabled
            if (settingsData.enableSounds && type !== 'info') {
                playNotificationSound();
            }
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Update charts when theme changes
        function updateChartsForTheme(theme) {
            // Update sensor charts
            Object.keys(charts).forEach(type => {
                if (charts[type]) {
                    const unit = type === 'temperature' ? '°C' : '%';
                    const yRange = type === 'temperature' ? [15, 35] :
                                  type === 'humidity' ? [30, 90] : [20, 80];
                    
                    charts[type].options = getChartOptions(unit, yRange);
                    charts[type].update('none');
                }
            });

            // Update historical chart
            if (historicalChart) {
                const currentSensor = document.querySelector('.sensor-btn.active')?.dataset.sensor || 'temperature';
                historicalChart.options = getHistoricalChartOptions(currentSensor);
                historicalChart.update('none');
            }
        }

        // Page content templates
        const pages = {
            home: `
                <div class="item">
                    <div class="hero-section scroll-animate">
                        <div class="hero-content">
                            <h1 class="hero-title">PRIMA</h1>
                            <p class="hero-subtitle">Système de Contrôle et Supervision à Distance</p>
                            <p class="hero-description">
                                Plateforme intelligente pour l'agriculture moderne avec surveillance IoT,
                                contrôle automatisé et analyse de données en temps réel.
                            </p>
                        </div>
                    </div>

                    <div class="welcome-card">
                        <h3>
                            <i class="fas fa-user-check"></i> Bienvenue, Utilisateur!
                        </h3>
                        <p>
                            Connecté depuis le ${new Date().toLocaleDateString('fr-FR')} à ${new Date().toLocaleTimeString('fr-FR')}
                        </p>
                    </div>
                </div>

                <div class="item">
                    <h2 class="scroll-animate" style="text-align: center; margin-bottom: 40px; color: #1e293b; font-size: 2.5rem; font-weight: 600;">
                        Fonctionnalités Principales
                    </h2>
                    <div class="features-grid">
                        <div class="feature-card scroll-animate-left">
                            <div class="feature-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h3 class="feature-title">Surveillance IoT</h3>
                            <p class="feature-description">
                                Monitoring en temps réel des capteurs environnementaux avec alertes intelligentes
                            </p>
                        </div>

                        <div class="feature-card scroll-animate-right">
                            <div class="feature-icon">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <h3 class="feature-title">Contrôle Automatisé</h3>
                            <p class="feature-description">
                                Gestion automatique des actionneurs et systèmes d'irrigation intelligents
                            </p>
                        </div>

                        <div class="feature-card scroll-animate-left">
                            <div class="feature-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h3 class="feature-title">Analyse de Données</h3>
                            <p class="feature-description">
                                Visualisation avancée et analyse prédictive des tendances environnementales
                            </p>
                        </div>

                        <div class="feature-card scroll-animate-right">
                            <div class="feature-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <h3 class="feature-title">Sécurité Avancée</h3>
                            <p class="feature-description">
                                Protection des données avec authentification sécurisée et chiffrement
                            </p>
                        </div>
                    </div>
                </div>

                <div class="item">
                    <h2 class="scroll-animate" style="text-align: center; margin-bottom: 40px; color: #1e293b; font-size: 2.5rem; font-weight: 600;">
                        Intelligence Artificielle
                    </h2>
                    <div class="features-grid">
                        <div class="feature-card scroll-animate-left">
                            <div class="feature-icon">
                                <i class="fas fa-brain"></i>
                            </div>
                            <h3 class="feature-title">Recommandations IA</h3>
                            <p class="feature-description">
                                Suggestions intelligentes basées sur l'analyse des données environnementales et des tendances historiques
                            </p>
                        </div>

                        <div class="feature-card scroll-animate-up">
                            <div class="feature-icon">
                                <i class="fas fa-robot"></i>
                            </div>
                            <h3 class="feature-title">Automatisation Prédictive</h3>
                            <p class="feature-description">
                                Anticipation des besoins d'irrigation et d'ajustements climatiques grâce aux algorithmes d'apprentissage
                            </p>
                        </div>

                        <div class="feature-card scroll-animate-right">
                            <div class="feature-icon">
                                <i class="fas fa-search-plus"></i>
                            </div>
                            <h3 class="feature-title">Détection d'Anomalies</h3>
                            <p class="feature-description">
                                Identification automatique des problèmes potentiels et alertes préventives intelligentes
                            </p>
                        </div>

                        <div class="feature-card scroll-animate-left">
                            <div class="feature-icon">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <h3 class="feature-title">Optimisation Énergétique</h3>
                            <p class="feature-description">
                                Réduction de la consommation énergétique par l'optimisation IA des cycles d'irrigation et de chauffage
                            </p>
                        </div>

                        <div class="feature-card scroll-animate-up">
                            <div class="feature-icon">
                                <i class="fas fa-seedling"></i>
                            </div>
                            <h3 class="feature-title">Prédiction de Croissance</h3>
                            <p class="feature-description">
                                Modélisation de la croissance des cultures et prévisions de rendement basées sur l'IA
                            </p>
                        </div>

                        <div class="feature-card scroll-animate-right">
                            <div class="feature-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <h3 class="feature-title">Assistant Virtuel</h3>
                            <p class="feature-description">
                                Chatbot intelligent pour répondre aux questions et fournir des conseils agricoles personnalisés
                            </p>
                        </div>
                    </div>
                </div>

                <div class="item">
                    <div class="photo-carousel">
                        <div class="carousel-container">
                            <div class="carousel-slide active" data-slide="0">
                                <img src="./homeprima_files/tata1.jpg" alt="Agriculture Smart">
                                <div class="photo-info">
                                    <div class="photo-title">Agriculture Intelligente</div>
                                    <div class="photo-description">Surveillance avancée des cultures avec capteurs IoT</div>
                                </div>
                            </div>
                            <div class="carousel-slide" data-slide="1">
                                <img src="./homeprima_files/tata2.jpg" alt="Monitoring System">
                                <div class="photo-info">
                                    <div class="photo-title">Système de Monitoring</div>
                                    <div class="photo-description">Contrôle en temps réel des paramètres environnementaux</div>
                                </div>
                            </div>
                            <div class="carousel-slide" data-slide="2">
                                <img src="./homeprima_files/tata3.jpg" alt="Smart Irrigation">
                                <div class="photo-info">
                                    <div class="photo-title">Irrigation Automatisée</div>
                                    <div class="photo-description">Gestion optimisée de l'eau avec capteurs d'humidité</div>
                                </div>
                            </div>
                            <div class="carousel-slide" data-slide="3">
                                <img src="./homeprima_files/tata4.jpeg" alt="Data Analytics">
                                <div class="photo-info">
                                    <div class="photo-title">Analyse de Données</div>
                                    <div class="photo-description">Tableaux de bord interactifs et statistiques avancées</div>
                                </div>
                            </div>
                            <div class="carousel-slide" data-slide="4">
                                <img src="./homeprima_files/img8.jpg" alt="Remote Control">
                                <div class="photo-info">
                                    <div class="photo-title">Contrôle à Distance</div>
                                    <div class="photo-description">Interface web responsive pour gestion mobile</div>
                                </div>
                            </div>
                            <div class="carousel-slide" data-slide="5">
                                <img src="./homeprima_files/agri16.jpg" alt="Future Agriculture">
                                <div class="photo-info">
                                    <div class="photo-title">Agriculture du Futur</div>
                                    <div class="photo-description">Innovation technologique pour l'agriculture durable</div>
                                </div>
                            </div>
                        </div>
                        <div class="carousel-nav prev" onclick="changeSlide(-1)">
                            <i class="fas fa-chevron-left"></i>
                        </div>
                        <div class="carousel-nav next" onclick="changeSlide(1)">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="carousel-indicators">
                            <div class="indicator active" onclick="goToSlide(0)"></div>
                            <div class="indicator" onclick="goToSlide(1)"></div>
                            <div class="indicator" onclick="goToSlide(2)"></div>
                            <div class="indicator" onclick="goToSlide(3)"></div>
                            <div class="indicator" onclick="goToSlide(4)"></div>
                            <div class="indicator" onclick="goToSlide(5)"></div>
                        </div>
                        <div class="carousel-progress" id="carouselProgress"></div>
                    </div>
                </div>
            `,
            sensors: `
                <!-- Sensor Status Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin-bottom: 32px;">
                    <!-- Temperature Sensor -->
                    <div style="background: #ffffff; border-radius: 16px; padding: 24px; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 4px 20px rgba(0,0,0,0.06);">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-thermometer-half" style="color: white; font-size: 20px;"></i>
                            </div>
                            <div>
                                <h3 style="color: #1e293b; font-size: 1.4rem; font-weight: 600; margin: 0;">Température</h3>
                                <p style="color: #64748b; margin: 0; font-size: 0.9rem;">Capteur atmosphérique</p>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div id="temperatureValue" style="font-size: 2.5rem; font-weight: 700; color: #10b981; margin-bottom: 8px;">23.5°C</div>
                            <div id="temperatureStatus" style="background: rgba(16, 185, 129, 0.1); padding: 8px 16px; border-radius: 20px; color: #059669; font-weight: 600; display: inline-block;">Normal</div>
                            <div style="margin-top: 12px; padding: 8px 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 3px solid #3b82f6;">
                                <div style="font-size: 0.85rem; color: #3b82f6; font-weight: 600; margin-bottom: 4px;"><i class="fas fa-brain"></i> Prédiction IA</div>
                                <div style="font-size: 0.8rem; color: #64748b;">Température stable. Augmentation prévue de +2°C dans 3h</div>
                            </div>
                        </div>
                    </div>

                    <!-- Humidity Sensor -->
                    <div style="background: #ffffff; border-radius: 16px; padding: 24px; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 4px 20px rgba(0,0,0,0.06);">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-tint" style="color: white; font-size: 20px;"></i>
                            </div>
                            <div>
                                <h3 style="color: #1e293b; font-size: 1.4rem; font-weight: 600; margin: 0;">Humidité</h3>
                                <p style="color: #64748b; margin: 0; font-size: 0.9rem;">Atmosphérique</p>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div id="humidityValue" style="font-size: 2.5rem; font-weight: 700; color: #3b82f6; margin-bottom: 8px;">64.3%</div>
                            <div id="humidityStatus" style="background: rgba(59, 130, 246, 0.1); padding: 8px 16px; border-radius: 20px; color: #2563eb; font-weight: 600; display: inline-block;">Optimal</div>
                            <div style="margin-top: 12px; padding: 8px 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-left: 3px solid #f59e0b;">
                                <div style="font-size: 0.85rem; color: #f59e0b; font-weight: 600; margin-bottom: 4px;"><i class="fas fa-exclamation-triangle"></i> Alerte</div>
                                <div style="font-size: 0.8rem; color: #64748b;">Baisse prévue. Activation ventilation recommandée</div>
                            </div>
                        </div>
                    </div>

                    <!-- Soil Moisture Sensor -->
                    <div style="background: #ffffff; border-radius: 16px; padding: 24px; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 4px 20px rgba(0,0,0,0.06);">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-seedling" style="color: white; font-size: 20px;"></i>
                            </div>
                            <div>
                                <h3 style="color: #1e293b; font-size: 1.4rem; font-weight: 600; margin: 0;">Humidité Sol</h3>
                                <p style="color: #64748b; margin: 0; font-size: 0.9rem;">Irrigation</p>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div id="soilValue" style="font-size: 2.5rem; font-weight: 700; color: #f59e0b; margin-bottom: 8px;">45.2%</div>
                            <div id="soilStatus" style="background: rgba(245, 158, 11, 0.1); padding: 8px 16px; border-radius: 20px; color: #d97706; font-weight: 600; display: inline-block;">Bon</div>
                            <div style="margin-top: 12px; padding: 8px 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid #ef4444;">
                                <div style="font-size: 0.85rem; color: #ef4444; font-weight: 600; margin-bottom: 4px;"><i class="fas fa-tint"></i> Action Requise</div>
                                <div style="font-size: 0.8rem; color: #64748b;">Irrigation programmée dans 2h. Niveau critique atteint</div>
                            </div>
                        </div>
                    </div>

                    <!-- Thermocouple Temperature Sensor -->
                    <div style="background: #ffffff; border-radius: 16px; padding: 24px; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 4px 20px rgba(0,0,0,0.06);">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-fire" style="color: white; font-size: 20px;"></i>
                            </div>
                            <div>
                                <h3 style="color: #1e293b; font-size: 1.4rem; font-weight: 600; margin: 0;">Thermocouple</h3>
                                <p style="color: #64748b; margin: 0; font-size: 0.9rem;">Température interne</p>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div id="thermocoupleValue" style="font-size: 2.5rem; font-weight: 700; color: #10b981; margin-bottom: 8px;">32.1°C</div>
                            <div id="thermocoupleStatus" style="background: rgba(16, 185, 129, 0.1); padding: 8px 16px; border-radius: 20px; color: #059669; font-weight: 600; display: inline-block;">Normal</div>
                            <div style="margin-top: 12px; padding: 8px 12px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 3px solid #10b981;">
                                <div style="font-size: 0.85rem; color: #10b981; font-weight: 600; margin-bottom: 4px;"><i class="fas fa-shield-alt"></i> Sécurité</div>
                                <div style="font-size: 0.8rem; color: #64748b;">Température dans la plage normale. Surveillance continue</div>
                            </div>
                        </div>
                    </div>


                    <!-- Voltage Sensor -->
                    <div style="background: #ffffff; border-radius: 16px; padding: 24px; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 4px 20px rgba(0,0,0,0.06);">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-bolt" style="color: white; font-size: 24px;"></i>
                            </div>
                            <div>
                                <h3 style="color: #1e293b; font-size: 1.4rem; font-weight: 600; margin: 0;">Tension</h3>
                                <p style="color: #64748b; margin: 0; font-size: 0.9rem;">Capteur de voltage</p>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div id="voltageValue" style="font-size: 2.5rem; font-weight: 700; color: #f59e0b; margin-bottom: 8px;">--.-V</div>
                            <div id="voltageStatus" style="background: rgba(245, 158, 11, 0.1); padding: 8px 16px; border-radius: 20px; color: #d97706; font-weight: 600; display: inline-block;">--</div>
                            <div style="margin-top: 12px; padding: 8px 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border-left: 3px solid #8b5cf6;">
                                <div style="font-size: 0.85rem; color: #8b5cf6; font-weight: 600; margin-bottom: 4px;"><i class="fas fa-chart-line"></i> Tendance</div>
                                <div style="font-size: 0.8rem; color: #64748b;">Voltage stable. Fluctuation normale</div>
                            </div>
                        </div>
                    </div>

                    <!-- Current Sensor -->
                    <div style="background: #ffffff; border-radius: 16px; padding: 24px; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 4px 20px rgba(0,0,0,0.06);">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-plug" style="color: white; font-size: 20px;"></i>
                            </div>
                            <div>
                                <h3 style="color: #1e293b; font-size: 1.4rem; font-weight: 600; margin: 0;">Courant</h3>
                                <p style="color: #64748b; margin: 0; font-size: 0.9rem;">Capteur d'intensité</p>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div id="currentValue" style="font-size: 2.5rem; font-weight: 700; color: #8b5cf6; margin-bottom: 8px;">2.3A</div>
                            <div id="currentStatus" style="background: rgba(139, 92, 246, 0.1); padding: 8px 16px; border-radius: 20px; color: #7c3aed; font-weight: 600; display: inline-block;">Normal</div>
                            <div style="margin-top: 12px; padding: 8px 12px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border-left: 3px solid #22c55e;">
                                <div style="font-size: 0.85rem; color: #22c55e; font-weight: 600; margin-bottom: 4px;"><i class="fas fa-zap"></i> Consommation</div>
                                <div style="font-size: 0.8rem; color: #64748b;">Consommation optimale. Efficacité 92%</div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- System Status -->
                <div style="background: #ffffff; border-radius: 16px; padding: 24px; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 4px 20px rgba(0,0,0,0.06); margin-bottom: 24px;">
                    <h3 style="color: #1e293b; font-size: 1.5rem; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-wifi" style="color: #10b981;"></i>
                        État du Système
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center; padding: 16px; background: #f8fafc; border-radius: 12px;">
                            <div style="color: #10b981; font-size: 1.8rem; font-weight: 700; margin-bottom: 8px;">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div style="color: #1e293b; font-weight: 600;">Connexion</div>
                            <div style="color: #64748b; font-size: 0.9rem;">Stable</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: #f8fafc; border-radius: 12px;">
                            <div style="color: #3b82f6; font-size: 1.8rem; font-weight: 700; margin-bottom: 8px;">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div style="color: #1e293b; font-weight: 600;">Dernière MàJ</div>
                            <div style="color: #64748b; font-size: 0.9rem;">Il y a 2s</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: #f8fafc; border-radius: 12px;">
                            <div style="color: #f59e0b; font-size: 1.8rem; font-weight: 700; margin-bottom: 8px;">
                                <i class="fas fa-battery-three-quarters"></i>
                            </div>
                            <div style="color: #1e293b; font-weight: 600;">Batterie</div>
                            <div style="color: #64748b; font-size: 0.9rem;">78%</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: #f8fafc; border-radius: 12px;">
                            <div style="color: #8b5cf6; font-size: 1.8rem; font-weight: 700; margin-bottom: 8px;">
                                <i class="fas fa-memory"></i>
                            </div>
                            <div style="color: #1e293b; font-weight: 600;">Mémoire</div>
                            <div style="color: #64748b; font-size: 0.9rem;">42% utilisée</div>
                        </div>
                    </div>
                </div>
            `,
            supervision: `

                <div class="analytics-dashboard" style="margin-top: 5px;">
                    <div class="advanced-charts-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 3px;">
                        <!-- Temperature Chart -->
                        <div style="background: #ffffff; border-radius: 8px; padding: 8px; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                <div style="width: 35px; height: 35px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-thermometer-half" style="color: white; font-size: 16px;"></i>
                                </div>
                                <div style="flex: 1;">
                                    <h3 style="color: #1e293b; font-size: 1.2rem; font-weight: 600; margin: 0;">Température</h3>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; background: rgba(16, 185, 129, 0.1); padding: 6px 10px; border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.2);">
                                    <i class="fas fa-clock" style="color: #10b981; font-size: 12px;"></i>
                                    <span style="color: #10b981; font-size: 0.75rem; font-weight: 600;">MàJ:</span>
                                    <select onchange="setRefreshRate('temperature', this.value)" style="background: white; border: 1px solid #10b981; border-radius: 4px; padding: 3px 6px; font-size: 0.75rem; cursor: pointer; color: #10b981; font-weight: 600;">
                                        <option value="1000">1s</option>
                                        <option value="5000" selected>5s</option>
                                        <option value="30000">30s</option>
                                        <option value="60000">1m</option>
                                    </select>
                                </div>
                                <div style="margin-left: auto; text-align: right;">
                                    <div id="temperatureStats" style="background: rgba(16, 185, 129, 0.1); padding: 8px 12px; border-radius: 8px;">
                                        <div class="current" style="font-size: 1.5rem; font-weight: 700; color: #10b981;">23.5°C</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Threshold Bands -->
                            <div style="margin-bottom: 5px; padding: 4px 6px; background: #f8fafc; border-radius: 4px; border-left: 3px solid #10b981;">
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem;">
                                    <span style="color: #64748b;">Seuils:</span>
                                    <div style="display: flex; gap: 10px;">
                                        <span style="color: #ef4444;">🔴 >30°C</span>
                                        <span style="color: #f59e0b;">🟡 18-30°C</span>
                                        <span style="color: #10b981;">🟢 <18°C</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="height: 200px; background: #f8fafc; border-radius: 8px; padding: 10px; position: relative;">
                                <canvas id="temperatureChart" style="position: relative; z-index: 2; cursor: crosshair;"></canvas>
                                <div style="position: absolute; top: 10px; left: 10px; background: rgba(16, 185, 129, 0.9); padding: 4px 8px; border-radius: 6px; color: white; font-size: 0.7rem; font-weight: 600;">
                                    <i class="fas fa-circle" style="color: #ffffff; margin-right: 3px; font-size: 4px;"></i> LIVE
                                </div>
                                <div style="position: absolute; top: 10px; right: 10px; background: rgba(59, 130, 246, 0.9); padding: 4px 8px; border-radius: 6px; color: white; font-size: 0.7rem; font-weight: 600;">
                                    <i class="fas fa-chart-line" style="color: #ffffff; margin-right: 3px;"></i> +2.1°C
                                </div>
                            </div>
                            
                            <!-- Additional Stats -->
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px;">
                                <div style="text-align: center; background: #f1f5f9; padding: 8px; border-radius: 6px;">
                                    <div style="color: #ef4444; font-size: 0.9rem; font-weight: 700;">31.5°C</div>
                                    <div style="color: #64748b; font-size: 0.7rem;">Max 24h</div>
                                </div>
                                <div style="text-align: center; background: #f1f5f9; padding: 8px; border-radius: 6px;">
                                    <div style="color: #3b82f6; font-size: 0.9rem; font-weight: 700;">16.8°C</div>
                                    <div style="color: #64748b; font-size: 0.7rem;">Min 24h</div>
                                </div>
                                <div style="text-align: center; background: #f1f5f9; padding: 8px; border-radius: 6px;">
                                    <div style="color: #10b981; font-size: 0.9rem; font-weight: 700;">68%</div>
                                    <div style="color: #64748b; font-size: 0.7rem;">Optimal</div>
                                </div>
                            </div>
                            
                            <!-- AI Intelligence -->
                            <div style="margin-top: 6px; padding: 4px 6px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1)); border-radius: 4px; border: 1px solid rgba(16, 185, 129, 0.2);">
                                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                    <i class="fas fa-brain" style="color: #10b981; font-size: 12px;"></i>
                                    <span style="color: #10b981; font-weight: 600; font-size: 0.8rem;">IA Analytics</span>
                                </div>
                                <div style="color: #64748b; font-size: 0.75rem;">Température stable dans la plage optimale. Prédiction: maintien à 24±2°C pour les 6h. Efficacité énergétique: 92%. Aucune action requise.</div>
                            </div>
                        </div>


                        <!-- Humidity Chart -->
                        <div style="background: #ffffff; border-radius: 6px; padding: 6px; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 1px 4px rgba(0,0,0,0.03);">
                            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                                <div style="width: 35px; height: 35px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-tint" style="color: white; font-size: 16px;"></i>
                                </div>
                                <div style="flex: 1;">
                                    <h3 style="color: #1e293b; font-size: 1.2rem; font-weight: 600; margin: 0;">Humidité</h3>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; background: rgba(59, 130, 246, 0.1); padding: 6px 10px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
                                    <i class="fas fa-clock" style="color: #3b82f6; font-size: 12px;"></i>
                                    <span style="color: #3b82f6; font-size: 0.75rem; font-weight: 600;">MàJ:</span>
                                    <select onchange="setRefreshRate('humidity', this.value)" style="background: white; border: 1px solid #3b82f6; border-radius: 4px; padding: 3px 6px; font-size: 0.75rem; cursor: pointer; color: #3b82f6; font-weight: 600;">
                                        <option value="1000">1s</option>
                                        <option value="5000" selected>5s</option>
                                        <option value="30000">30s</option>
                                        <option value="60000">1m</option>
                                    </select>
                                </div>
                                <div style="margin-left: auto; text-align: right;">
                                    <div id="humidityStats" style="background: rgba(59, 130, 246, 0.1); padding: 8px 12px; border-radius: 8px;">
                                        <div class="current" style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">64.3%</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Threshold Bands -->
                            <div style="margin-bottom: 10px; padding: 8px; background: #f8fafc; border-radius: 6px; border-left: 4px solid #3b82f6;">
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem;">
                                    <span style="color: #64748b;">Seuils:</span>
                                    <div style="display: flex; gap: 10px;">
                                        <span style="color: #ef4444;">🔴 <40%</span>
                                        <span style="color: #f59e0b;">🟡 40-70%</span>
                                        <span style="color: #10b981;">🟢 >70%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="height: 200px; background: #f8fafc; border-radius: 8px; padding: 10px; position: relative;">
                                <canvas id="humidityChart" style="position: relative; z-index: 2; cursor: crosshair;"></canvas>
                                <div style="position: absolute; top: 10px; left: 10px; background: rgba(59, 130, 246, 0.9); padding: 4px 8px; border-radius: 6px; color: white; font-size: 0.7rem; font-weight: 600;">
                                    <i class="fas fa-circle" style="color: #ffffff; margin-right: 3px; font-size: 4px;"></i> LIVE
                                </div>
                                <div style="position: absolute; top: 10px; right: 10px; background: rgba(239, 68, 68, 0.9); padding: 4px 8px; border-radius: 6px; color: white; font-size: 0.7rem; font-weight: 600;">
                                    <i class="fas fa-arrow-down" style="color: #ffffff; margin-right: 3px;"></i> -5.3%
                                </div>
                            </div>
                            
                            <!-- Additional Stats -->
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px;">
                                <div style="text-align: center; background: #f1f5f9; padding: 8px; border-radius: 6px;">
                                    <div style="color: #ef4444; font-size: 0.9rem; font-weight: 700;">89.2%</div>
                                    <div style="color: #64748b; font-size: 0.7rem;">Max 24h</div>
                                </div>
                                <div style="text-align: center; background: #f1f5f9; padding: 8px; border-radius: 6px;">
                                    <div style="color: #10b981; font-size: 0.9rem; font-weight: 700;">35.7%</div>
                                    <div style="color: #64748b; font-size: 0.7rem;">Min 24h</div>
                                </div>
                                <div style="text-align: center; background: #f1f5f9; padding: 8px; border-radius: 6px;">
                                    <div style="color: #f59e0b; font-size: 0.9rem; font-weight: 700;">23%</div>
                                    <div style="color: #64748b; font-size: 0.7rem;">Lows</div>
                                </div>
                            </div>
                            
                            <!-- AI Intelligence -->
                            <div style="margin-top: 10px; padding: 8px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
                                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                    <i class="fas fa-brain" style="color: #3b82f6; font-size: 12px;"></i>
                                    <span style="color: #3b82f6; font-weight: 600; font-size: 0.8rem;">IA Analytics</span>
                                </div>
                                <div style="color: #64748b; font-size: 0.75rem;">Humidité en baisse constante. Risque de stress hydrique détecté. Recommandation: augmenter fréquence d'arrosage de 15%. Prédiction: stabilisation à 58% dans 4h.</div>
                            </div>
                        </div>

                        <!-- Soil Moisture Chart -->
                        <div style="background: #ffffff; border-radius: 12px; padding: 15px; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 4px 15px rgba(0,0,0,0.06);">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                <div style="width: 35px; height: 35px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-seedling" style="color: white; font-size: 16px;"></i>
                                </div>
                                <div style="flex: 1;">
                                    <h3 style="color: #1e293b; font-size: 1.2rem; font-weight: 600; margin: 0;">Humidité Sol</h3>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; background: rgba(245, 158, 11, 0.1); padding: 6px 10px; border-radius: 8px; border: 1px solid rgba(245, 158, 11, 0.2);">
                                    <i class="fas fa-clock" style="color: #f59e0b; font-size: 12px;"></i>
                                    <span style="color: #f59e0b; font-size: 0.75rem; font-weight: 600;">MàJ:</span>
                                    <select onchange="setRefreshRate('soil', this.value)" style="background: white; border: 1px solid #f59e0b; border-radius: 4px; padding: 3px 6px; font-size: 0.75rem; cursor: pointer; color: #f59e0b; font-weight: 600;">
                                        <option value="1000">1s</option>
                                        <option value="5000" selected>5s</option>
                                        <option value="30000">30s</option>
                                        <option value="60000">1m</option>
                                    </select>
                                </div>
                                <div style="margin-left: auto; text-align: right;">
                                    <div id="soilStats" style="background: rgba(245, 158, 11, 0.1); padding: 8px 12px; border-radius: 8px;">
                                        <div class="current" style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">45.2%</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Threshold Bands -->
                            <div style="margin-bottom: 10px; padding: 8px; background: #f8fafc; border-radius: 6px; border-left: 4px solid #f59e0b;">
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem;">
                                    <span style="color: #64748b;">Seuils:</span>
                                    <div style="display: flex; gap: 10px;">
                                        <span style="color: #ef4444;">🔴 <30%</span>
                                        <span style="color: #f59e0b;">🟡 30-60%</span>
                                        <span style="color: #10b981;">🟢 >60%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="height: 200px; background: #f8fafc; border-radius: 8px; padding: 10px; position: relative;">
                                <canvas id="soilChart" style="position: relative; z-index: 2; cursor: crosshair;"></canvas>
                                <div style="position: absolute; top: 10px; left: 10px; background: rgba(245, 158, 11, 0.9); padding: 4px 8px; border-radius: 6px; color: white; font-size: 0.7rem; font-weight: 600;">
                                    <i class="fas fa-circle" style="color: #ffffff; margin-right: 3px; font-size: 4px;"></i> LIVE
                                </div>
                                <div style="position: absolute; top: 10px; right: 10px; background: rgba(239, 68, 68, 0.9); padding: 4px 8px; border-radius: 6px; color: white; font-size: 0.7rem; font-weight: 600;">
                                    <i class="fas fa-exclamation-triangle" style="color: #ffffff; margin-right: 3px;"></i> Critique
                                </div>
                            </div>
                            
                            <!-- Additional Stats -->
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px;">
                                <div style="text-align: center; background: #f1f5f9; padding: 8px; border-radius: 6px;">
                                    <div style="color: #3b82f6; font-size: 0.9rem; font-weight: 700;">72.1%</div>
                                    <div style="color: #64748b; font-size: 0.7rem;">Max 24h</div>
                                </div>
                                <div style="text-align: center; background: #f1f5f9; padding: 8px; border-radius: 6px;">
                                    <div style="color: #ef4444; font-size: 0.9rem; font-weight: 700;">28.3%</div>
                                    <div style="color: #64748b; font-size: 0.7rem;">Min 24h</div>
                                </div>
                                <div style="text-align: center; background: #f1f5f9; padding: 8px; border-radius: 6px;">
                                    <div style="color: #ef4444; font-size: 0.9rem; font-weight: 700;">42%</div>
                                    <div style="color: #64748b; font-size: 0.7rem;">Lows</div>
                                </div>
                            </div>
                            
                            <!-- AI Intelligence -->
                            <div style="margin-top: 10px; padding: 8px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1)); border-radius: 8px; border: 1px solid rgba(245, 158, 11, 0.2);">
                                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                    <i class="fas fa-brain" style="color: #f59e0b; font-size: 12px;"></i>
                                    <span style="color: #f59e0b; font-weight: 600; font-size: 0.8rem;">IA Analytics</span>
                                </div>
                                <div style="color: #64748b; font-size: 0.75rem;">Niveau critique atteint! Irrigation automatique programmée dans 1h30. Pattern détecté: baisse rapide après 14h. Recommandation: ajuster timing d'arrosage matinal.</div>
                            </div>
                        </div>

                        <!-- Thermocouple Chart -->
                        <div style="background: #ffffff; border-radius: 12px; padding: 15px; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 4px 15px rgba(0,0,0,0.06);">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                <div style="width: 35px; height: 35px; background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-fire" style="color: white; font-size: 16px;"></i>
                                </div>
                                <div style="flex: 1;">
                                    <h3 style="color: #1e293b; font-size: 1.2rem; font-weight: 600; margin: 0;">Thermocouple</h3>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; background: rgba(239, 68, 68, 0.1); padding: 6px 10px; border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.2);">
                                    <i class="fas fa-clock" style="color: #ef4444; font-size: 12px;"></i>
                                    <span style="color: #ef4444; font-size: 0.75rem; font-weight: 600;">MàJ:</span>
                                    <select onchange="setRefreshRate('thermocouple', this.value)" style="background: white; border: 1px solid #ef4444; border-radius: 4px; padding: 3px 6px; font-size: 0.75rem; cursor: pointer; color: #ef4444; font-weight: 600;">
                                        <option value="1000">1s</option>
                                        <option value="5000" selected>5s</option>
                                        <option value="30000">30s</option>
                                        <option value="60000">1m</option>
                                    </select>
                                </div>
                                <div style="margin-left: auto; text-align: right;">
                                    <div id="thermocoupleStats" style="background: rgba(239, 68, 68, 0.1); padding: 8px 12px; border-radius: 8px;">
                                        <div class="current" style="font-size: 1.5rem; font-weight: 700; color: #ef4444;">35.0°C</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Threshold Bands -->
                            <div style="margin-bottom: 10px; padding: 8px; background: #f8fafc; border-radius: 6px; border-left: 4px solid #ef4444;">
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem;">
                                    <span style="color: #64748b;">Seuils:</span>
                                    <div style="display: flex; gap: 10px;">
                                        <span style="color: #ef4444;">🔴 >80°C</span>
                                        <span style="color: #f59e0b;">🟡 50-80°C</span>
                                        <span style="color: #10b981;">🟢 <50°C</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="height: 200px; background: #f8fafc; border-radius: 8px; padding: 10px; position: relative;">
                                <canvas id="thermocoupleChart" style="position: relative; z-index: 2; cursor: crosshair;"></canvas>
                                <div style="position: absolute; top: 10px; left: 10px; background: rgba(239, 68, 68, 0.9); padding: 4px 8px; border-radius: 6px; color: white; font-size: 0.7rem; font-weight: 600;">
                                    <i class="fas fa-circle" style="color: #ffffff; margin-right: 3px; font-size: 4px;"></i> LIVE
                                </div>
                                <div style="position: absolute; top: 10px; right: 10px; background: rgba(16, 185, 129, 0.9); padding: 4px 8px; border-radius: 6px; color: white; font-size: 0.7rem; font-weight: 600;">
                                    <i class="fas fa-shield-alt" style="color: #ffffff; margin-right: 3px;"></i> Sécurisé
                                </div>
                            </div>
                            
                            <!-- Additional Stats -->
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px;">
                                <div style="text-align: center; background: #f1f5f9; padding: 8px; border-radius: 6px;">
                                    <div style="color: #ef4444; font-size: 0.9rem; font-weight: 700;">85.2°C</div>
                                    <div style="color: #64748b; font-size: 0.7rem;">Max 24h</div>
                                </div>
                                <div style="text-align: center; background: #f1f5f9; padding: 8px; border-radius: 6px;">
                                    <div style="color: #10b981; font-size: 0.9rem; font-weight: 700;">22.1°C</div>
                                    <div style="color: #64748b; font-size: 0.7rem;">Min 24h</div>
                                </div>
                                <div style="text-align: center; background: #f1f5f9; padding: 8px; border-radius: 6px;">
                                    <div style="color: #3b82f6; font-size: 0.9rem; font-weight: 700;">12%</div>
                                    <div style="color: #64748b; font-size: 0.7rem;">Highs</div>
                                </div>
                            </div>
                            
                            <!-- AI Intelligence -->
                            <div style="margin-top: 10px; padding: 8px; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(16, 185, 129, 0.1)); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.2);">
                                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                    <i class="fas fa-brain" style="color: #ef4444; font-size: 12px;"></i>
                                    <span style="color: #ef4444; font-weight: 600; font-size: 0.8rem;">IA Analytics</span>
                                </div>
                                <div style="color: #64748b; font-size: 0.75rem;">Température sécurisée. Pattern cyclique détecté: pics à 14h-16h. Efficacité thermique: 94%. Prédiction: maintien sous 40°C. Aucune intervention requise.</div>
                            </div>
                        </div>

                        <!-- Current Sensor Chart -->
                        <div style="background: #ffffff; border-radius: 12px; padding: 15px; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 4px 15px rgba(0,0,0,0.06);">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                <div style="width: 35px; height: 35px; background: linear-gradient(135deg, #22c55e, #16a34a); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-bolt" style="color: white; font-size: 16px;"></i>
                                </div>
                                <div style="flex: 1;">
                                    <h3 style="color: #1e293b; font-size: 1.2rem; font-weight: 600; margin: 0;">Courant</h3>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; background: rgba(34, 197, 94, 0.1); padding: 6px 10px; border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.2);">
                                    <i class="fas fa-clock" style="color: #22c55e; font-size: 12px;"></i>
                                    <span style="color: #22c55e; font-size: 0.75rem; font-weight: 600;">MàJ:</span>
                                    <select onchange="setRefreshRate('current', this.value)" style="background: white; border: 1px solid #22c55e; border-radius: 4px; padding: 3px 6px; font-size: 0.75rem; cursor: pointer; color: #22c55e; font-weight: 600;">">
                                        <option value="1000">1s</option>
                                        <option value="5000" selected>5s</option>
                                        <option value="30000">30s</option>
                                        <option value="60000">1m</option>
                                    </select>
                                </div>
                                <div style="margin-left: auto; text-align: right;">
                                    <div id="lightStats" style="background: rgba(251, 191, 36, 0.1); padding: 8px 12px; border-radius: 8px;">
                                        <div class="current" style="font-size: 1.5rem; font-weight: 700; color: #fbbf24;">75.2%</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Threshold Bands -->
                            <div style="margin-bottom: 10px; padding: 8px; background: #f8fafc; border-radius: 6px; border-left: 4px solid #fbbf24;">
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem;">
                                    <span style="color: #64748b;">Seuils:</span>
                                    <div style="display: flex; gap: 10px;">
                                        <span style="color: #ef4444;">🔴 <20%</span>
                                        <span style="color: #f59e0b;">🟡 20-70%</span>
                                        <span style="color: #10b981;">🟢 >70%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="height: 200px; background: #f8fafc; border-radius: 8px; padding: 10px; position: relative;">
                                <canvas id="currentChart" style="position: relative; z-index: 2; cursor: crosshair;"></canvas>
                                <div style="position: absolute; top: 10px; left: 10px; background: rgba(34, 197, 94, 0.9); padding: 4px 8px; border-radius: 6px; color: white; font-size: 0.7rem; font-weight: 600;">
                                    <i class="fas fa-circle" style="color: #ffffff; margin-right: 3px; font-size: 4px;"></i> LIVE
                                </div>
                                <div style="position: absolute; top: 10px; right: 10px; background: rgba(16, 185, 129, 0.9); padding: 4px 8px; border-radius: 6px; color: white; font-size: 0.7rem; font-weight: 600;">
                                    <i class="fas fa-arrow-up" style="color: #ffffff; margin-right: 3px;"></i> +12%
                                </div>
                            </div>
                            
                            <!-- Additional Stats -->
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px;">
                                <div style="text-align: center; background: #f1f5f9; padding: 8px; border-radius: 6px;">
                                    <div style="color: #10b981; font-size: 0.9rem; font-weight: 700;">95.8%</div>
                                    <div style="color: #64748b; font-size: 0.7rem;">Max 24h</div>
                                </div>
                                <div style="text-align: center; background: #f1f5f9; padding: 8px; border-radius: 6px;">
                                    <div style="color: #ef4444; font-size: 0.9rem; font-weight: 700;">15.2%</div>
                                    <div style="color: #64748b; font-size: 0.7rem;">Min 24h</div>
                                </div>
                                <div style="text-align: center; background: #f1f5f9; padding: 8px; border-radius: 6px;">
                                    <div style="color: #fbbf24; font-size: 0.9rem; font-weight: 700;">78%</div>
                                    <div style="color: #64748b; font-size: 0.7rem;">Optimal</div>
                                </div>
                            </div>
                            
                            <!-- AI Intelligence -->
                            <div style="margin-top: 10px; padding: 8px; background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(16, 185, 129, 0.1)); border-radius: 8px; border: 1px solid rgba(251, 191, 36, 0.2);">
                                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                    <i class="fas fa-brain" style="color: #fbbf24; font-size: 12px;"></i>
                                    <span style="color: #fbbf24; font-weight: 600; font-size: 0.8rem;">IA Analytics</span>
                                </div>
                                <div style="color: #64748b; font-size: 0.75rem;">Niveau de lumière optimal pour photosynthèse. Pattern jour/nuit détecté. Peak luminosité: 12h-15h. Efficacité éclairage LED: 89%. Recommandation: maintenir cycle actuel.</div>
                            </div>
                        </div>


                `,
            historical: `
                <!-- Time Period Selector -->
                <div style="background: #ffffff; border-radius: 20px; padding: 25px; margin-bottom: 30px; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 10px 40px rgba(0,0,0,0.06);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #1e293b; font-size: 1.5rem; font-weight: 600; margin: 0;">Période d'Analyse</h3>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="loadHistoricalData('7d')" class="period-btn active" data-period="7d" style="padding: 8px 16px; border: none; border-radius: 8px; background: #3b82f6; color: white; font-weight: 600; cursor: pointer;">7 Jours</button>
                            <button onclick="loadHistoricalData('30d')" class="period-btn" data-period="30d" style="padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 8px; background: white; color: #64748b; font-weight: 600; cursor: pointer;">30 Jours</button>
                            <button onclick="loadHistoricalData('90d')" class="period-btn" data-period="90d" style="padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 8px; background: white; color: #64748b; font-weight: 600; cursor: pointer;">3 Mois</button>
                            <button onclick="loadHistoricalData('365d')" class="period-btn" data-period="365d" style="padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 8px; background: white; color: #64748b; font-weight: 600; cursor: pointer;">1 Année</button>
                        </div>
                    </div>
                    
                    <!-- Fixed Time Analysis -->
                    <div style="border-top: 1px solid #e2e8f0; padding-top: 20px; margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: #1e293b; font-size: 1.2rem; font-weight: 600; margin: 0;">Analyse à Moment Fixe</h4>
                            <button id="toggleFixedTime" onclick="toggleFixedTimeMode()" style="padding: 6px 12px; border: 1px solid #e2e8f0; border-radius: 6px; background: white; color: #64748b; font-size: 0.85rem; cursor: pointer;">
                                <i class="fas fa-clock"></i> Activer
                            </button>
                        </div>
                        <div id="fixedTimeControls" style="display: none; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="color: #64748b; font-size: 0.9rem; font-weight: 500;">Date:</label>
                                <input type="date" id="fixedDate" style="padding: 6px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem;" />
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="color: #64748b; font-size: 0.9rem; font-weight: 500;">Heure:</label>
                                <input type="time" id="fixedTime" style="padding: 6px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem;" />
                            </div>
                            <button onclick="loadFixedTimeData()" style="padding: 6px 16px; border: none; border-radius: 6px; background: #10b981; color: white; font-weight: 600; cursor: pointer; font-size: 0.9rem;">
                                <i class="fas fa-search"></i> Analyser
                            </button>
                            <button onclick="resetToLiveData()" style="padding: 6px 16px; border: 1px solid #e2e8f0; border-radius: 6px; background: white; color: #64748b; font-weight: 600; cursor: pointer; font-size: 0.9rem;">
                                <i class="fas fa-sync"></i> Temps Réel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Date Range Analysis -->
                    <div style="border-top: 1px solid #e2e8f0; padding-top: 20px; margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: #1e293b; font-size: 1.2rem; font-weight: 600; margin: 0;">Analyse par Période Personnalisée</h4>
                            <button id="toggleDateRange" onclick="toggleDateRangeMode()" style="padding: 6px 12px; border: 1px solid #e2e8f0; border-radius: 6px; background: white; color: #64748b; font-size: 0.85rem; cursor: pointer;">
                                <i class="fas fa-calendar-alt"></i> Activer
                            </button>
                        </div>
                        <div id="dateRangeControls" style="display: none; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="color: #64748b; font-size: 0.9rem; font-weight: 500;">Période de Début:</label>
                                <input type="date" id="startDate" style="padding: 6px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem;" />
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="color: #64748b; font-size: 0.9rem; font-weight: 500;">Période de Fin:</label>
                                <input type="date" id="endDate" style="padding: 6px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem;" />
                            </div>
                            <button onclick="loadDateRangeData()" style="padding: 6px 16px; border: none; border-radius: 6px; background: #3b82f6; color: white; font-weight: 600; cursor: pointer; font-size: 0.9rem;">
                                <i class="fas fa-chart-line"></i> Générer Graphique
                            </button>
                            <button onclick="resetToLiveData()" style="padding: 6px 16px; border: 1px solid #e2e8f0; border-radius: 6px; background: white; color: #64748b; font-weight: 600; cursor: pointer; font-size: 0.9rem;">
                                <i class="fas fa-sync"></i> Temps Réel
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Comparative Chart -->
                <div style="background: #ffffff; border-radius: 20px; padding: 30px; margin-bottom: 30px; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 10px 40px rgba(0,0,0,0.06);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <div>
                            <h3 style="color: #1e293b; font-size: 1.8rem; font-weight: 700; margin: 0;">Comparaison Périodes</h3>
                            <p style="color: #64748b; margin: 0; font-size: 1rem;">Cette période vs période précédente</p>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 2px;"></div>
                                <span style="color: #64748b; font-size: 0.9rem;">Période Actuelle</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 12px; height: 12px; background: #e2e8f0; border-radius: 2px;"></div>
                                <span style="color: #64748b; font-size: 0.9rem;">Période Précédente</span>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="findMaxValue()" style="padding: 4px 8px; border: 1px solid #10b981; border-radius: 6px; background: white; color: #10b981; font-size: 0.8rem; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-arrow-up"></i> Max
                                </button>
                                <button onclick="findMinValue()" style="padding: 4px 8px; border: 1px solid #ef4444; border-radius: 6px; background: white; color: #ef4444; font-size: 0.8rem; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-arrow-down"></i> Min
                                </button>
                                <button onclick="clearMaxMin()" style="padding: 4px 8px; border: 1px solid #64748b; border-radius: 6px; background: white; color: #64748b; font-size: 0.8rem; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sensor Selector -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;">
                        <button onclick="switchHistoricalSensor('temperature')" class="sensor-btn active" data-sensor="temperature" style="padding: 10px 20px; border: none; border-radius: 12px; background: #10b981; color: white; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-thermometer-half"></i> Température
                        </button>
                        <button onclick="switchHistoricalSensor('humidity')" class="sensor-btn" data-sensor="humidity" style="padding: 10px 20px; border: 1px solid #e2e8f0; border-radius: 12px; background: white; color: #64748b; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-tint"></i> Humidité
                        </button>
                        <button onclick="switchHistoricalSensor('soil')" class="sensor-btn" data-sensor="soil" style="padding: 10px 20px; border: 1px solid #e2e8f0; border-radius: 12px; background: white; color: #64748b; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-seedling"></i> Sol
                        </button>
                        <button onclick="switchHistoricalSensor('thermocouple')" class="sensor-btn" data-sensor="thermocouple" style="padding: 10px 20px; border: 1px solid #e2e8f0; border-radius: 12px; background: white; color: #64748b; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-fire"></i> Thermocouple
                        </button>
                        <button onclick="switchHistoricalSensor('current')" class="sensor-btn" data-sensor="current" style="padding: 10px 20px; border: 1px solid #e2e8f0; border-radius: 12px; background: white; color: #64748b; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-bolt"></i> Courant
                        </button>
                    </div>
                    
                    <div style="height: 350px; background: #f8fafc; border-radius: 16px; padding: 20px; position: relative;">
                        <canvas id="historicalChart" style="position: relative; z-index: 2;"></canvas>
                    </div>
                </div>

                `,
            commande: `
                <div class="page-header">
                    <h1>
                        <i class="fas fa-power-off"></i>
                        Commande des Actionneurs
                    </h1>
                    <p>Contrôle et gestion des équipements automatisés du système PRIMA</p>
                </div>

                <!-- Actuators Grid -->
                <div class="actuators-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px;">
                    <!-- Light Control -->
                    <div class="actuator-card" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 16px; padding: 24px; border-left: 4px solid #fbbf24;">
                        <div class="actuator-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                            <div class="actuator-info" style="display: flex; gap: 15px;">
                                <div class="actuator-icon" style="width: 50px; height: 50px; background: #fef3c7; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-lightbulb" style="color: #d97706; font-size: 20px;"></i>
                                </div>
                                <div class="actuator-details">
                                    <h3 style="margin: 0 0 5px 0; color: #1e293b;">Éclairage LED</h3>
                                    <p class="actuator-location" style="margin: 0; color: #64748b; font-size: 14px;">
                                        <i class="fas fa-map-marker-alt"></i> Serre - Éclairage Principal
                                    </p>
                                </div>
                            </div>
                            <div id="lightActuatorStatus" class="actuator-status" style="background: #ef4444; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                Arrêté
                            </div>
                        </div>
                        <div class="actuator-controls" style="margin: 20px 0;">
                            <div class="control-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <span style="color: #64748b;">Puissance:</span>
                                <span style="font-weight: 600; color: #1e293b;">100W</span>
                            </div>
                            <div class="control-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <span style="color: #64748b;">Mode:</span>
                                <span style="font-weight: 600; color: #1e293b;">Manuel</span>
                            </div>
                            <div class="control-buttons" style="display: flex; gap: 10px; margin-top: 20px;">
                                <button onclick="controlActuator('light', 'on')" style="flex: 1; background: #10b981; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer;">
                                    <i class="fas fa-power-off"></i> ON
                                </button>
                                <button onclick="controlActuator('light', 'off')" style="flex: 1; background: #ef4444; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer;">
                                    <i class="fas fa-power-off"></i> OFF
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Fan Control -->
                    <div class="actuator-card" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 16px; padding: 24px; border-left: 4px solid #3b82f6;">
                        <div class="actuator-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                            <div class="actuator-info" style="display: flex; gap: 15px;">
                                <div class="actuator-icon" style="width: 50px; height: 50px; background: #dbeafe; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-fan" style="color: #2563eb; font-size: 20px;"></i>
                                </div>
                                <div class="actuator-details">
                                    <h3 style="margin: 0 0 5px 0; color: #1e293b;">Ventilateur</h3>
                                    <p class="actuator-location" style="margin: 0; color: #64748b; font-size: 14px;">
                                        <i class="fas fa-map-marker-alt"></i> Serre - Ventilation
                                    </p>
                                </div>
                            </div>
                            <div id="fanActuatorStatus" class="actuator-status" style="background: #ef4444; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                Arrêté
                            </div>
                        </div>
                        <div class="actuator-controls" style="margin: 20px 0;">
                            <div class="control-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <span style="color: #64748b;">Vitesse:</span>
                                <span style="font-weight: 600; color: #1e293b;">Variable</span>
                            </div>
                            <div class="control-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <span style="color: #64748b;">Mode:</span>
                                <span style="font-weight: 600; color: #1e293b;">Manuel</span>
                            </div>
                            <div class="control-buttons" style="display: flex; gap: 10px; margin-top: 20px;">
                                <button onclick="controlActuator('fan', 'on')" style="flex: 1; background: #10b981; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer;">
                                    <i class="fas fa-power-off"></i> ON
                                </button>
                                <button onclick="controlActuator('fan', 'off')" style="flex: 1; background: #ef4444; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer;">
                                    <i class="fas fa-power-off"></i> OFF
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Heater Control -->
                    <div class="actuator-card" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 16px; padding: 24px; border-left: 4px solid #ef4444;">
                        <div class="actuator-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                            <div class="actuator-info" style="display: flex; gap: 15px;">
                                <div class="actuator-icon" style="width: 50px; height: 50px; background: #fee2e2; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-fire" style="color: #dc2626; font-size: 20px;"></i>
                                </div>
                                <div class="actuator-details">
                                    <h3 style="margin: 0 0 5px 0; color: #1e293b;">Chauffage</h3>
                                    <p class="actuator-location" style="margin: 0; color: #64748b; font-size: 14px;">
                                        <i class="fas fa-map-marker-alt"></i> Serre - Système Thermique
                                    </p>
                                </div>
                            </div>
                            <div id="heaterActuatorStatus" class="actuator-status" style="background: #ef4444; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                Arrêté
                            </div>
                        </div>
                        <div class="actuator-controls" style="margin: 20px 0;">
                            <div class="control-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <span style="color: #64748b;">Température:</span>
                                <span style="font-weight: 600; color: #1e293b;">25°C</span>
                            </div>
                            <div class="control-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <span style="color: #64748b;">Mode:</span>
                                <span style="font-weight: 600; color: #1e293b;">Manuel</span>
                            </div>
                            <div class="control-buttons" style="display: flex; gap: 10px; margin-top: 20px;">
                                <button onclick="controlActuator('heater', 'on')" style="flex: 1; background: #10b981; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer;">
                                    <i class="fas fa-power-off"></i> ON
                                </button>
                                <button onclick="controlActuator('heater', 'off')" style="flex: 1; background: #ef4444; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer;">
                                    <i class="fas fa-power-off"></i> OFF
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Valve Control -->
                    <div class="actuator-card" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 16px; padding: 24px; border-left: 4px solid #10b981;">
                        <div class="actuator-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                            <div class="actuator-info" style="display: flex; gap: 15px;">
                                <div class="actuator-icon" style="width: 50px; height: 50px; background: #dcfce7; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-faucet" style="color: #16a34a; font-size: 20px;"></i>
                                </div>
                                <div class="actuator-details">
                                    <h3 style="margin: 0 0 5px 0; color: #1e293b;">Vanne d'Eau</h3>
                                    <p class="actuator-location" style="margin: 0; color: #64748b; font-size: 14px;">
                                        <i class="fas fa-map-marker-alt"></i> Serre - Distribution Eau
                                    </p>
                                </div>
                            </div>
                            <div id="valveActuatorStatus" class="actuator-status" style="background: #ef4444; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                Fermée
                            </div>
                        </div>
                        <div class="actuator-controls" style="margin: 20px 0;">
                            <div class="control-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <span style="color: #64748b;">Pression:</span>
                                <span style="font-weight: 600; color: #1e293b;">2.1 bar</span>
                            </div>
                            <div class="control-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <span style="color: #64748b;">Débit:</span>
                                <span style="font-weight: 600; color: #1e293b;">3.2 L/min</span>
                            </div>
                            <div class="control-buttons" style="display: flex; gap: 10px; margin-top: 20px;">
                                <button onclick="controlActuator('valve', 'on')" style="flex: 1; background: #10b981; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer;">
                                    <i class="fas fa-unlock"></i> Ouvrir
                                </button>
                                <button onclick="controlActuator('valve', 'off')" style="flex: 1; background: #ef4444; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer;">
                                    <i class="fas fa-lock"></i> Fermer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            statistiques: `
                <div class="page-header">
                    <h1>
                        <i class="fas fa-chart-line"></i>
                        Statistiques et Analytics
                    </h1>
                    <p>Tableaux de bord et analyses détaillées des performances du système PRIMA</p>
                </div>

                <!-- Statistics Overview -->
                <div class="stats-overview" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px;">
                    <div class="stat-card" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 16px; padding: 20px; text-align: center; border-left: 4px solid #3b82f6;">
                        <div class="stat-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div class="stat-icon" style="width: 40px; height: 40px; background: #dbeafe; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-thermometer-half" style="color: #2563eb; font-size: 16px;"></i>
                            </div>
                            <div class="stat-trend" style="color: #10b981; font-size: 12px; font-weight: 600;">
                                <i class="fas fa-arrow-up"></i> +2.3°C
                            </div>
                        </div>
                        <div class="stat-value" style="font-size: 2rem; font-weight: 700; color: #1e293b;">27.3°C</div>
                        <div class="stat-label" style="color: #64748b; font-size: 14px;">Température Actuelle</div>
                        <div class="stat-sublabel" style="color: #9ca3af; font-size: 12px;">Moyenne: 25.8°C</div>
                    </div>

                    <div class="stat-card" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 16px; padding: 20px; text-align: center; border-left: 4px solid #10b981;">
                        <div class="stat-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div class="stat-icon" style="width: 40px; height: 40px; background: #dcfce7; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-tint" style="color: #16a34a; font-size: 16px;"></i>
                            </div>
                            <div class="stat-trend" style="color: #ef4444; font-size: 12px; font-weight: 600;">
                                <i class="fas fa-arrow-down"></i> -5.2%
                            </div>
                        </div>
                        <div class="stat-value" style="font-size: 2rem; font-weight: 700; color: #1e293b;">60.1%</div>
                        <div class="stat-label" style="color: #64748b; font-size: 14px;">Humidité Actuelle</div>
                        <div class="stat-sublabel" style="color: #9ca3af; font-size: 12px;">Moyenne: 65.3%</div>
                    </div>


                    <div class="stat-card" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 16px; padding: 20px; text-align: center; border-left: 4px solid #8b5cf6;">
                        <div class="stat-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div class="stat-icon" style="width: 40px; height: 40px; background: #ede9fe; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-seedling" style="color: #7c3aed; font-size: 16px;"></i>
                            </div>
                            <div class="stat-trend" style="color: #10b981; font-size: 12px; font-weight: 600;">
                                <i class="fas fa-arrow-up"></i> +8.5%
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Grid -->
                <div class="charts-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">
                    <div class="chart-card" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 16px; padding: 24px;">
                        <div class="chart-header" style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 5px 0; color: #1e293b;">Évolution de la Température</h3>
                            <p style="margin: 0; color: #64748b; font-size: 14px;">Dernières 24 heures</p>
                        </div>
                        <div class="chart-placeholder" style="height: 200px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #2563eb; font-weight: 600;">
                            <i class="fas fa-chart-line" style="margin-right: 10px;"></i>
                            Graphique Température
                        </div>
                    </div>

                    <div class="chart-card" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 16px; padding: 24px;">
                        <div class="chart-header" style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 5px 0; color: #1e293b;">Consommation d'Eau</h3>
                            <p style="margin: 0; color: #64748b; font-size: 14px;">Par zone cette semaine</p>
                        </div>
                        <div class="chart-placeholder" style="height: 200px; background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #16a34a; font-weight: 600;">
                            <i class="fas fa-chart-bar" style="margin-right: 10px;"></i>
                            Graphique Irrigation
                        </div>
                    </div>

                    <div class="chart-card" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 16px; padding: 24px;">
                        <div class="chart-header" style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 5px 0; color: #1e293b;">Rendement des Cultures</h3>
                            <p style="margin: 0; color: #64748b; font-size: 14px;">Comparaison mensuelle</p>
                        </div>
                        <div class="chart-placeholder" style="height: 200px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #d97706; font-weight: 600;">
                            <i class="fas fa-chart-pie" style="margin-right: 10px;"></i>
                            Graphique Rendement
                        </div>
                    </div>

                    <div class="chart-card" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 16px; padding: 24px;">
                        <div class="chart-header" style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 5px 0; color: #1e293b;">Efficacité Énergétique</h3>
                            <p style="margin: 0; color: #64748b; font-size: 14px;">Consommation vs Production</p>
                        </div>
                        <div class="chart-placeholder" style="height: 200px; background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #7c3aed; font-weight: 600;">
            `,
            camera: `
                <!-- Camera Grid - 3 Small Containers -->
                <div class="stats-overview" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 12px; margin-bottom: 16px;">
                    
                    <!-- Camera 1 - Working ESP32 CAM -->
                    <div class="camera-container" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 16px; padding: 20px; border-left: 4px solid #10b981;">
                        <div class="camera-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div class="camera-info" style="display: flex; gap: 12px; align-items: center;">
                                <div class="camera-icon" style="width: 40px; height: 40px; background: #dcfce7; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-camera" style="color: #16a34a; font-size: 16px;"></i>
                                </div>
                                <div>
                                    <h3 style="margin: 0 0 3px 0; color: #1e293b; font-size: 1.1rem;">ESP32 CAM #1</h3>
                                    <p style="margin: 2px 0 0 0; color: #64748b; font-size: 11px;">
                                        <i class="fas fa-wifi"></i> <span id="cameraIP">192.168.1.100</span> • <i class="fas fa-microchip"></i> OV2640
                                    </p>
                                    <p style="margin: 2px 0 0 0; color: #64748b; font-size: 11px;">
                                        <i class="fas fa-clock"></i> Auto: <span id="camera1AutoInterval">OFF</span> • <i class="fas fa-signal"></i> <span id="camera1Signal">-45dBm</span>
                                    </p>
                                </div>
                            </div>
                            <div id="camera1Status" class="status-badge" style="background: #10b981; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                ONLINE
                            </div>
                        </div>
                        
                        <!-- Mini Camera Display -->
                        <div class="mini-camera-display" style="background: #f8fafc; border-radius: 8px; padding: 12px; position: relative; height: 180px; margin-bottom: 15px;">
                            <img id="camera1Snapshot" src="" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px; display: none;" alt="ESP32 CAM 1">
                            <div id="camera1Placeholder" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 6px;">
                                <div style="text-align: center; color: white;">
                                    <i class="fas fa-camera" style="font-size: 2rem; margin-bottom: 8px; display: block; opacity: 0.9;"></i>
                                    <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">ESP32 CAM Ready</p>
                                </div>
                            </div>
                            
                            <!-- Live Status -->
                            <div id="camera1LiveStatus" style="position: absolute; top: 18px; left: 18px; background: rgba(16, 185, 129, 0.95); padding: 4px 8px; border-radius: 12px; color: white; font-size: 10px; font-weight: 600; display: none;">
                                <i class="fas fa-circle" style="color: #ffffff; margin-right: 4px; font-size: 6px; animation: pulse 2s infinite;"></i> LIVE
                            </div>
                        </div>
                        
                        <!-- Auto-Capture Control -->
                        <div class="auto-capture-control" style="background: #f8fafc; border-radius: 8px; padding: 10px; margin-bottom: 12px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="color: #64748b; font-size: 12px; font-weight: 600;">Auto-Capture:</span>
                                <button onclick="toggleCamera1AutoCapture()" id="camera1AutoBtn" style="background: #6b7280; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; font-weight: 600;">
                                    <i class="fas fa-play"></i> START
                                </button>
                            </div>
                            <select onchange="setCamera1Interval(this.value)" id="camera1IntervalSelect" style="width: 100%; background: white; border: 1px solid #d1d5db; border-radius: 4px; padding: 4px 8px; font-size: 11px; color: #1e293b;">
                                <option value="500">Toutes les 0.5s</option>
                                <option value="1000">Toutes les 1s</option>
                                <option value="2000">Toutes les 2s</option>
                                <option value="5000" selected>Toutes les 5s</option>
                                <option value="10000">Toutes les 10s</option>
                                <option value="30000">Toutes les 30s</option>
                                <option value="60000">Toutes les 1min</option>
                            </select>
                        </div>
                        
                        <!-- Mini Controls -->
                        <div class="mini-controls" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                            <button onclick="captureCamera1()" style="background: #3b82f6; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                <i class="fas fa-camera"></i> Capture
                            </button>
                            <button onclick="toggleCamera1Flash()" id="camera1FlashBtn" style="background: #6b7280; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                <i class="fas fa-lightbulb"></i> Flash
                            </button>
                        </div>
                        
                        <!-- Camera Settings -->
                        <div class="camera-settings" style="background: #f1f5f9; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                            <h4 style="margin: 0 0 8px 0; color: #1e293b; font-size: 0.9rem; display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-cog" style="color: #6b7280; font-size: 12px;"></i>
                                Paramètres
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px;">
                                <div>
                                    <span style="color: #64748b;">Résolution:</span>
                                    <div id="camera1Resolution" style="color: #1e293b; font-weight: 600;">SVGA</div>
                                </div>
                                <div>
                                    <span style="color: #64748b;">Qualité:</span>
                                    <div style="color: #1e293b; font-weight: 600;">Haute</div>
                                </div>
                                <div>
                                    <span style="color: #64748b;">FPS:</span>
                                    <div style="color: #1e293b; font-weight: 600;">15</div>
                                </div>
                                <div>
                                    <span style="color: #64748b;">Uptime:</span>
                                    <div id="camera1Uptime" style="color: #1e293b; font-weight: 600;">--</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Additional Controls -->
                        <div class="additional-controls" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                            <button onclick="downloadCamera1Snapshot()" style="background: #f59e0b; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600;">
                                <i class="fas fa-download"></i> Télécharger
                            </button>
                            <button onclick="resetCamera1()" style="background: #ef4444; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600;">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                        </div>
                        
                        <!-- Stats -->
                        <div class="camera-stats" style="display: flex; justify-content: space-between; padding-top: 12px; border-top: 1px solid #e2e8f0;">
                            <div style="text-align: center;">
                                <div id="camera1SnapshotCount" style="font-size: 1.2rem; font-weight: 700; color: #1e293b;">0</div>
                                <div style="font-size: 11px; color: #64748b;">Photos</div>
                            </div>
                            <div style="text-align: center;">
                                <div id="camera1FlashStatus" style="font-size: 1.2rem; font-weight: 700; color: #1e293b;">OFF</div>
                                <div style="font-size: 11px; color: #64748b;">Flash</div>
                            </div>
                            <div style="text-align: center;">
                                <div id="camera1LastCapture" style="font-size: 1.2rem; font-weight: 700; color: #1e293b;">--:--</div>
                                <div style="font-size: 11px; color: #64748b;">Dernière</div>
                            </div>
                        </div>
                    </div>

                    <!-- Camera 2 - Coming Soon -->
                    <div class="camera-container" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 16px; padding: 20px; border-left: 4px solid #f59e0b; opacity: 0.7;">
                        <div class="camera-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div class="camera-info" style="display: flex; gap: 12px; align-items: center;">
                                <div class="camera-icon" style="width: 40px; height: 40px; background: #fef3c7; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-camera" style="color: #d97706; font-size: 16px;"></i>
                                </div>
                                <div>
                                    <h3 style="margin: 0 0 3px 0; color: #1e293b; font-size: 1.1rem;">ESP32 CAM #2</h3>
                                    <p style="margin: 0; color: #64748b; font-size: 12px;">
                                        <i class="fas fa-clock"></i> Configuration en cours
                                    </p>
                                </div>
                            </div>
                            <div class="status-badge" style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                SOON
                            </div>
                        </div>
                        
                        <!-- Coming Soon Display -->
                        <div class="mini-camera-display" style="background: #f8fafc; border-radius: 8px; padding: 12px; position: relative; height: 180px; margin-bottom: 15px;">
                            <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 6px;">
                                <div style="text-align: center; color: white;">
                                    <i class="fas fa-tools" style="font-size: 2rem; margin-bottom: 8px; display: block; opacity: 0.9;"></i>
                                    <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Bientôt Disponible</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Disabled Controls -->
                        <div class="mini-controls" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <button disabled style="background: #9ca3af; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: not-allowed; font-size: 12px; font-weight: 600;">
                                <i class="fas fa-camera"></i> Capture
                            </button>
                            <button disabled style="background: #9ca3af; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: not-allowed; font-size: 12px; font-weight: 600;">
                                <i class="fas fa-lightbulb"></i> Flash
                            </button>
                        </div>
                        
                        <!-- Coming Soon Stats -->
                        <div class="camera-stats" style="display: flex; justify-content: space-between; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.2rem; font-weight: 700; color: #9ca3af;">--</div>
                                <div style="font-size: 11px; color: #64748b;">Photos</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.2rem; font-weight: 700; color: #9ca3af;">--</div>
                                <div style="font-size: 11px; color: #64748b;">Flash</div>
                            </div>
                        </div>
                    </div>

                    <!-- Camera 3 - Coming Soon -->
                    <div class="camera-container" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 16px; padding: 20px; border-left: 4px solid #8b5cf6; opacity: 0.7;">
                        <div class="camera-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div class="camera-info" style="display: flex; gap: 12px; align-items: center;">
                                <div class="camera-icon" style="width: 40px; height: 40px; background: #ede9fe; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-camera" style="color: #7c3aed; font-size: 16px;"></i>
                                </div>
                                <div>
                                    <h3 style="margin: 0 0 3px 0; color: #1e293b; font-size: 1.1rem;">ESP32 CAM #3</h3>
                                    <p style="margin: 0; color: #64748b; font-size: 12px;">
                                        <i class="fas fa-clock"></i> Planifié pour v2.0
                                    </p>
                                </div>
                            </div>
                            <div class="status-badge" style="background: #8b5cf6; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                SOON
                            </div>
                        </div>
                        
                        <!-- Coming Soon Display -->
                        <div class="mini-camera-display" style="background: #f8fafc; border-radius: 8px; padding: 12px; position: relative; height: 180px; margin-bottom: 15px;">
                            <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 6px;">
                                <div style="text-align: center; color: white;">
                                    <i class="fas fa-plus-circle" style="font-size: 2rem; margin-bottom: 8px; display: block; opacity: 0.9;"></i>
                                    <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Prochainement</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Disabled Controls -->
                        <div class="mini-controls" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <button disabled style="background: #9ca3af; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: not-allowed; font-size: 12px; font-weight: 600;">
                                <i class="fas fa-camera"></i> Capture
                            </button>
                            <button disabled style="background: #9ca3af; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: not-allowed; font-size: 12px; font-weight: 600;">
                                <i class="fas fa-lightbulb"></i> Flash
                            </button>
                        </div>
                        
                        <!-- Coming Soon Stats -->
                        <div class="camera-stats" style="display: flex; justify-content: space-between; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.2rem; font-weight: 700; color: #9ca3af;">--</div>
                                <div style="font-size: 11px; color: #64748b;">Photos</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.2rem; font-weight: 700; color: #9ca3af;">--</div>
                                <div style="font-size: 11px; color: #64748b;">Flash</div>
                            </div>
                        </div>
                    </div>
                </div>

            `,
            contact: `
                <div class="page-header">
                    <h1>
                        <i class="fas fa-leaf"></i>
                        À propos de PRIMA
                    </h1>
                    <p>Informations sur le projet et contacts de l'équipe de développement</p>
                </div>

                <!-- Content Grid -->
                <div class="content-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">
                    <!-- About Section -->
                    <div class="content-card" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 16px; padding: 24px;">
                        <div class="card-header" style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                            <div class="card-icon" style="width: 50px; height: 50px; background: #dbeafe; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-info-circle" style="color: #2563eb; font-size: 20px;"></i>
                            </div>
                            <h2 class="card-title" style="margin: 0; color: #1e293b; font-size: 1.5rem;">À propos du projet</h2>
                        </div>
                        <div class="card-content">
                            <p style="margin-bottom: 15px; color: #64748b; line-height: 1.6;"><strong>PRIMA</strong> (Precision Agriculture Management System) est une solution innovante de gestion intelligente pour l'agriculture de précision.</p>

                            <h3 style="color: #1e293b; margin: 20px 0 10px 0; font-size: 1.2rem;">Objectifs du projet</h3>
                            <ul style="color: #64748b; line-height: 1.6; padding-left: 20px;">
                                <li>Optimiser la production agricole</li>
                                <li>Réduire la consommation d'eau et d'énergie</li>
                                <li>Améliorer la qualité des cultures</li>
                                <li>Automatiser les processus de surveillance</li>
                                <li>Fournir des analyses prédictives</li>
                            </ul>

                            <h3 style="color: #1e293b; margin: 20px 0 10px 0; font-size: 1.2rem;">Technologies utilisées</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                                <span style="background: #dbeafe; color: #2563eb; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">IoT</span>
                                <span style="background: #dcfce7; color: #16a34a; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">PHP</span>
                                <span style="background: #fef3c7; color: #d97706; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">JavaScript</span>
                                <span style="background: #ede9fe; color: #7c3aed; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">MySQL</span>
                                <span style="background: #fee2e2; color: #dc2626; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">Arduino</span>
                            </div>
                        </div>
                    </div>

                    <!-- Team Section -->
                    <div class="content-card" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 16px; padding: 24px;">
                        <div class="card-header" style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                            <div class="card-icon" style="width: 50px; height: 50px; background: #dcfce7; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-users" style="color: #16a34a; font-size: 20px;"></i>
                            </div>
                            <h2 class="card-title" style="margin: 0; color: #1e293b; font-size: 1.5rem;">Équipe de développement</h2>
                        </div>
                        <div class="card-content">
                            <div class="team-member" style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #f8fafc; border-radius: 12px; margin-bottom: 15px;">
                                <div class="member-avatar" style="width: 50px; height: 50px; background: linear-gradient(135deg, #4a6cf7 0%, #2e4ead 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 18px;">
                                    JD
                                </div>
                                <div class="member-info">
                                    <h4 style="margin: 0 0 5px 0; color: #1e293b;">Dr. Jean Dupont</h4>
                                    <p style="margin: 0; color: #64748b; font-size: 14px;">Chef de projet • Ingénieur Agronome</p>
                                    <p style="margin: 5px 0 0 0; color: #4a6cf7; font-size: 14px;">
                                        <i class="fas fa-envelope"></i> jean.dupont@prima.tn
                                    </p>
                                </div>
                            </div>

                            <div class="team-member" style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #f8fafc; border-radius: 12px; margin-bottom: 15px;">
                                <div class="member-avatar" style="width: 50px; height: 50px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 18px;">
                                    AM
                                </div>
                                <div class="member-info">
                                    <h4 style="margin: 0 0 5px 0; color: #1e293b;">Ahmed Mansouri</h4>
                                    <p style="margin: 0; color: #64748b; font-size: 14px;">Développeur IoT • Ingénieur Électronique</p>
                                    <p style="margin: 5px 0 0 0; color: #4a6cf7; font-size: 14px;">
                                        <i class="fas fa-envelope"></i> ahmed.mansouri@prima.tn
                                    </p>
                                </div>
                            </div>

                            <div class="team-member" style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #f8fafc; border-radius: 12px;">
                                <div class="member-avatar" style="width: 50px; height: 50px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 18px;">
                                    SB
                                </div>
                                <div class="member-info">
                                    <h4 style="margin: 0 0 5px 0; color: #1e293b;">Sarah Ben Ali</h4>
                                    <p style="margin: 0; color: #64748b; font-size: 14px;">Développeuse Web • Ingénieure Informatique</p>
                                    <p style="margin: 5px 0 0 0; color: #4a6cf7; font-size: 14px;">
                                        <i class="fas fa-envelope"></i> sarah.benali@prima.tn
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Section -->
                    <div class="content-card" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 16px; padding: 24px;">
                        <div class="card-header" style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                            <div class="card-icon" style="width: 50px; height: 50px; background: #fef3c7; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-phone" style="color: #d97706; font-size: 20px;"></i>
                            </div>
                            <h2 class="card-title" style="margin: 0; color: #1e293b; font-size: 1.5rem;">Informations de contact</h2>
                        </div>
                        <div class="card-content">
                            <div class="contact-item" style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <div class="contact-icon" style="width: 40px; height: 40px; background: #dbeafe; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-map-marker-alt" style="color: #2563eb; font-size: 16px;"></i>
                                </div>
                                <div>
                                    <h4 style="margin: 0 0 5px 0; color: #1e293b;">Adresse</h4>
                                    <p style="margin: 0; color: #64748b;">Institut Supérieur des Sciences Appliquées et de Technologie de Sousse</p>
                                    <p style="margin: 0; color: #64748b;">Cité Taffala, 4003 Sousse, Tunisie</p>
                                </div>
                            </div>

                            <div class="contact-item" style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <div class="contact-icon" style="width: 40px; height: 40px; background: #dcfce7; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-phone" style="color: #16a34a; font-size: 16px;"></i>
                                </div>
                                <div>
                                    <h4 style="margin: 0 0 5px 0; color: #1e293b;">Téléphone</h4>
                                    <p style="margin: 0; color: #64748b;">+216 73 327 400</p>
                                </div>
                            </div>

                            <div class="contact-item" style="display: flex; align-items: center; gap: 15px;">
                                <div class="contact-icon" style="width: 40px; height: 40px; background: #fef3c7; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-envelope" style="color: #d97706; font-size: 16px;"></i>
                                </div>
                                <div>
                                    <h4 style="margin: 0 0 5px 0; color: #1e293b;">Email</h4>
                                    <p style="margin: 0; color: #64748b;">contact@prima.tn</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Support Section -->
                    <div class="content-card" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 16px; padding: 24px;">
                        <div class="card-header" style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                            <div class="card-icon" style="width: 50px; height: 50px; background: #ede9fe; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-life-ring" style="color: #7c3aed; font-size: 20px;"></i>
                            </div>
                            <h2 class="card-title" style="margin: 0; color: #1e293b; font-size: 1.5rem;">Support technique</h2>
                        </div>
                        <div class="card-content">
                            <p style="margin-bottom: 15px; color: #64748b; line-height: 1.6;">Notre équipe de support est disponible pour vous aider avec toutes vos questions techniques.</p>

                            <div class="support-hours" style="background: #f8fafc; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                                <h4 style="margin: 0 0 10px 0; color: #1e293b;">Heures de support</h4>
                                <p style="margin: 0; color: #64748b;">Lundi - Vendredi : 8h00 - 18h00</p>
                                <p style="margin: 0; color: #64748b;">Samedi : 9h00 - 13h00</p>
                                <p style="margin: 0; color: #64748b;">Dimanche : Fermé</p>
                            </div>

                            <button style="width: 100%; background: #4a6cf7; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-headset" style="margin-right: 8px;"></i>
                                Contacter le support
                            </button>
                        </div>
                    </div>
                </div>
            `
        };

        // Advanced Page Loading System
        function showPageLoader(pageName, loadingText) {
            // Update loader text
            loaderText.textContent = `Chargement ${pageName}...`;
            loaderSubtext.textContent = loadingText;

            // Show loader
            pageLoader.classList.add('active');

            // Reset progress bar
            progressBar.style.width = '0%';
            progressBar.style.animation = 'none';

            // Start progress animation
            setTimeout(() => {
                progressBar.style.animation = 'loadProgress 2s ease-in-out';
            }, 100);

            // Add loading states to current page elements
            addLoadingStates();
        }

        function hidePageLoader() {
            setTimeout(() => {
                pageLoader.classList.remove('active');
                removeLoadingStates();
            }, 1500);
        }

        function addLoadingStates() {
            mainContainer.style.opacity = '0.7';
            mainContainer.style.pointerEvents = 'none';
        }

        function removeLoadingStates() {
            mainContainer.style.opacity = '1';
            mainContainer.style.pointerEvents = 'auto';
        }

        // Navigation functions
        function navigateTo(pageName, pageTitle, loadingText) {
            // Show loading
            showPageLoader(pageTitle, loadingText);

            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.closest('.nav-link').classList.add('active');

            // Initialize charts after DOM is ready and theme is loaded
            setTimeout(() => {
                initializeCharts();
                initializeHistoricalChart();
                initializeAllCharts();
            }, 100);

            // Load page after delay
            setTimeout(() => {
                loadPage(pageName);
                hidePageLoader();
            }, 1200);

            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        function loadPage(pageName) {
            app.innerHTML = pages[pageName] || pages.home;
            initScrollAnimations();

            // Update active nav link - only for main menu items, not submenu items
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // For submenu pages, activate the parent menu item
            if (pageName === 'sensors' || pageName === 'supervision' || pageName === 'historical') {
                const parentLink = document.querySelector('.has-submenu .nav-link');
                if (parentLink) {
                    parentLink.classList.add('active');
                }
            } else {
                // Find and activate the correct nav link for main menu items
                const activeLink = document.querySelector(`[onclick*="loadPage('${pageName}')"]`);
                if (activeLink && activeLink.classList.contains('nav-link')) {
                    activeLink.classList.add('active');
                }
            }

            // Initialize carousel if on home page
            if (pageName === 'home') {
                setTimeout(() => {
                    initCarousel();
                }, 100);
            }

            // Initialize charts if on supervision page (Capteurs et Statistiques)
            if (pageName === 'supervision') {
                setTimeout(() => {
                    initializeCharts();
                    
                    // Fetch initial real sensor data from ESP32
                    updateSensorValues();
                    
                    // Start auto-refresh with real data
                    startChartAutoRefresh();
                }, 200);
            }

            // Initialize simple sensor view for sensors page
            if (pageName === 'sensors') {
                setTimeout(() => {
                    initializeSensorCards();
                    
                    // Fetch initial real sensor data from ESP32
                    updateSensorValues();
                    
                    // Set up periodic refresh for sensor cards
                    setInterval(updateSensorValues, 5000); // Update every 5 seconds
                }, 200);
            }

            // Initialize historical analytics
            if (pageName === 'historical') {
                setTimeout(() => {
                    initializeHistoricalChart();
                    loadHistoricalData('7d');
                }, 200);
            }
        }

        function toggleSidebar() {
            sidebar.classList.toggle('active');
            mainContainer.classList.toggle('sidebar-open');
        }

        // Setup animations
        function setupAnimations() {
            initScrollAnimations();
            initParallax();
            startContinuousScroll();
            startContinuousBottomScroll();
        }

        // Initialize scroll animations
        function initScrollAnimations() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('animate-in');
                    }
                });
            }, {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            });

            document.querySelectorAll('.scroll-animate, .scroll-animate-left, .scroll-animate-right, .scroll-animate-scale').forEach(el => {
                observer.observe(el);
            });
        }

        // Enhanced page transition with loading
        function initPageTransitions() {
            mainContainer.classList.add('loaded');
        }

        // Parallax effects
        function initParallax() {
            let ticking = false;

            function updateParallax() {
                const scrolled = window.pageYOffset;

                // Background parallax
                document.body.style.setProperty('--bg-transform-1', `translate(${scrolled * -0.5}px, ${scrolled * -0.3}px)`);
                document.body.style.setProperty('--bg-transform-2', `translate(${scrolled * 0.3}px, ${scrolled * -0.4}px)`);

                // Hero section parallax
                const heroSection = document.querySelector('.hero-section');
                if (heroSection) {
                    const heroContent = heroSection.querySelector('.hero-content');
                    if (heroContent) {
                        heroContent.style.transform = `translateY(${scrolled * -0.2}px)`;
                    }

                    heroSection.style.setProperty('--hero-before-transform', `translate(${scrolled * -0.4}px, ${scrolled * -0.3}px)`);
                    heroSection.style.setProperty('--hero-after-transform', `translate(${scrolled * 0.2}px, ${scrolled * -0.5}px)`);
                }

                ticking = false;
            }

            function requestTick() {
                if (!ticking) {
                    requestAnimationFrame(updateParallax);
                    ticking = true;
                }
            }

            window.addEventListener('scroll', requestTick, { passive: true });
        }

        // Continuous scrolling animations
        function startContinuousScroll() {
            const scrollingText = document.querySelector('.top-scrolling-text');
            if (scrollingText) {
                scrollingText.style.animation = 'scroll-left 30s linear infinite';
            }
        }

        function startContinuousBottomScroll() {
            const bottomScrollingText = document.querySelector('.bottom-scrolling-text');
            if (bottomScrollingText) {
                bottomScrollingText.style.animation = 'scroll-right 35s linear infinite';
            }
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const hamburger = document.querySelector('.hamburger');
                
                if (!sidebar.contains(event.target) && !hamburger.contains(event.target)) {
                    closeSidebar();
                }
            }
        });

        // Toggle submenu function
        function toggleSubmenu(element) {
            const parentLi = element.parentElement;
            const isOpen = parentLi.classList.contains('open');
            
            // Close all other submenus
            document.querySelectorAll('.has-submenu.open').forEach(item => {
                if (item !== parentLi) {
                    item.classList.remove('open');
                }
            });
            
            // Toggle current submenu
            if (isOpen) {
                parentLi.classList.remove('open');
            } else {
                parentLi.classList.add('open');
            }
        }

        // Historical Analytics Functions
        let historicalChart = null;
        let currentHistoricalSensor = 'temperature';
        let currentHistoricalPeriod = '7d';

        function loadHistoricalData(period) {
            currentHistoricalPeriod = period;
            
            // Update active button
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'white';
                btn.style.color = '#64748b';
                btn.style.border = '1px solid #e2e8f0';
            });
            
            const activeBtn = document.querySelector(`[data-period="${period}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.background = '#3b82f6';
                activeBtn.style.color = 'white';
                activeBtn.style.border = 'none';
            }

            // Generate comparative data for the selected period
            if (historicalChart) {
                updateHistoricalChart(period, currentHistoricalSensor);
            }
        }

        function switchHistoricalSensor(sensor) {
            currentHistoricalSensor = sensor;
            
            // Update active sensor button
            const sensorColors = {
                temperature: '#10b981',
                humidity: '#3b82f6', 
                ph: '#8b5cf6',
                soil: '#f59e0b',
                thermocouple: '#ef4444',
                current: '#22c55e'
            };
            
            document.querySelectorAll('.sensor-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'white';
                btn.style.color = '#64748b';
                btn.style.border = '1px solid #e2e8f0';
            });
            
            const activeBtn = document.querySelector(`[data-sensor="${sensor}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.background = sensorColors[sensor];
                activeBtn.style.color = 'white';
                activeBtn.style.border = 'none';
            }

            // Update chart with new sensor data
            if (historicalChart) {
                updateHistoricalChart(currentHistoricalPeriod, sensor);
            }
        }

        function generateHistoricalData(period, sensor) {
            const days = period === '7d' ? 7 : period === '30d' ? 30 : period === '90d' ? 90 : 365;
            const currentData = [];
            const previousData = [];
            const snapshot = window.latestSensorSnapshot || null;
            const keyMap = { temperature: 'temperature', humidity: 'humidity', soil: 'soil_moisture', thermocouple: 'thermocouple_temperature', current: 'current', light: 'light_level' };
            const latestVal = snapshot ? snapshot[keyMap[sensor]] : null;
            const now = new Date();

            for (let i = days; i >= 0; i--) {
                const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                if (latestVal !== null && latestVal !== undefined) {
                    currentData.push({ x: date, y: Number(parseFloat(latestVal).toFixed(1)) });
                    previousData.push({ x: date, y: Number(parseFloat(latestVal).toFixed(1)) });
                }
            }

            return { current: currentData, previous: previousData };
        }

        function initializeHistoricalChart() {
            const canvas = document.getElementById('historicalChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const tempData = generateHistoricalData('7d', 'temperature');
            
            historicalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Période Actuelle',
                            data: tempData.current,
                            borderColor: '#10b981',
                            backgroundColor: function(context) {
                                const chart = context.chart;
                                const {ctx} = chart;
                                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                                gradient.addColorStop(0, 'rgba(16, 185, 129, 0.3)');
                                gradient.addColorStop(1, 'rgba(16, 185, 129, 0.05)');
                                return gradient;
                            },
                            borderWidth: 3,
                            fill: 'start',
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Période Précédente',
                            data: tempData.previous,
                            borderColor: '#e2e8f0',
                            backgroundColor: 'rgba(226, 232, 240, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: getHistoricalChartOptions('temperature')
            });
        }

        function getHistoricalChartOptions(sensor) {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const sensorConfig = {
                temperature: { unit: '°C', color: '#10b981' },
                humidity: { unit: '%', color: '#3b82f6' },
                ph: { unit: '', color: '#8b5cf6' },
                soil: { unit: '%', color: '#f59e0b' },
                thermocouple: { unit: '°C', color: '#ef4444' },
                current: { unit: 'A', color: '#22c55e' }
            };
            
            const config = sensorConfig[sensor];
            
            return {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 20,
                        bottom: 10,
                        left: 10,
                        right: 10
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: isDark ? 'rgba(30, 41, 59, 0.95)' : 'rgba(15, 23, 42, 0.95)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: isDark ? 'rgba(255, 255, 255, 0.2)' : 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        cornerRadius: 12,
                        displayColors: true,
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13 },
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y + config.unit;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'MMM DD'
                            }
                        },
                        grid: {
                            color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)',
                            drawBorder: false
                        },
                        ticks: {
                            color: isDark ? '#94a3b8' : '#64748b',
                            font: { size: 12 }
                        }
                    },
                    y: {
                        grid: {
                            color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)',
                            drawBorder: false
                        },
                        ticks: {
                            color: isDark ? '#94a3b8' : '#64748b',
                            font: { size: 12 },
                            callback: function(value) {
                                return value + config.unit;
                            }
                        }
                    }
                },
                animation: {
                    duration: 1500,
                    easing: 'easeInOutQuart'
                }
            };
        }

        // Fixed time analysis variables
        let isFixedTimeMode = false;
        let fixedTimeData = null;
        
        // Date range analysis variables
        let isDateRangeMode = false;
        let dateRangeData = null;
        
        // Max/Min analysis variables
        let maxMinAnnotations = [];
        
        // Advanced Alert System
        let systemAlerts = [];
        let alertCheckInterval = null;

        function toggleFixedTimeMode() {
            const controls = document.getElementById('fixedTimeControls');
            const toggleBtn = document.getElementById('toggleFixedTime');
            
            isFixedTimeMode = !isFixedTimeMode;
            
            if (isFixedTimeMode) {
                controls.style.display = 'flex';
                toggleBtn.innerHTML = '<i class="fas fa-clock"></i> Désactiver';
                toggleBtn.style.background = '#ef4444';
                toggleBtn.style.color = 'white';
                toggleBtn.style.border = 'none';
                
                // Set default date to today
                const today = new Date();
                document.getElementById('fixedDate').value = today.toISOString().split('T')[0];
                document.getElementById('fixedTime').value = today.toTimeString().slice(0, 5);
            } else {
                controls.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-clock"></i> Activer';
                toggleBtn.style.background = 'white';
                toggleBtn.style.color = '#64748b';
                toggleBtn.style.border = '1px solid #e2e8f0';
                resetToLiveData();
            }
        }

        function loadFixedTimeData() {
            const dateInput = document.getElementById('fixedDate').value;
            const timeInput = document.getElementById('fixedTime').value;
            
            if (!dateInput || !timeInput) {
                alert('Veuillez sélectionner une date et une heure.');
                return;
            }
            
            const selectedDateTime = new Date(`${dateInput}T${timeInput}`);
            const now = new Date();
            
            if (selectedDateTime > now) {
                alert('Impossible de sélectionner une date future.');
                return;
            }
            
            // Generate fixed time data
            fixedTimeData = generateFixedTimeData(selectedDateTime, currentHistoricalSensor);
            
            // Update chart title to show fixed time
            const chartTitle = document.querySelector('#historicalChart').closest('div').querySelector('h3');
            if (chartTitle) {
                chartTitle.innerHTML = `Données du ${selectedDateTime.toLocaleDateString('fr-FR')} à ${selectedDateTime.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}`;
            }
            
            // Update chart with fixed time data
            updateHistoricalChartWithFixedData();
        }

        function generateFixedTimeData(targetDateTime, sensor) {
            const snapshot = window.latestSensorSnapshot || null;
            const keyMap = { 
                temperature: 'temperature', 
                humidity: 'humidity', 
                soil: 'soil_moisture', 
                thermocouple: 'thermocouple_temperature', 
                current: 'current', 
                light: 'light_level' 
            };
            
            // Simulate historical data around the target time (±2 hours)
            const data = [];
            const baseValue = snapshot ? snapshot[keyMap[sensor]] : Math.random() * 50 + 20;
            
            for (let i = -24; i <= 24; i++) { // 48 data points (every 5 minutes for 4 hours)
                const time = new Date(targetDateTime.getTime() + i * 5 * 60 * 1000);
                const variation = Math.sin(i * 0.2) * 2 + (Math.random() - 0.5) * 1.5;
                const value = Math.max(0, baseValue + variation);
                data.push({ x: time, y: Number(value.toFixed(1)) });
            }
            
            return data;
        }

        function updateHistoricalChartWithFixedData() {
            if (!historicalChart || !fixedTimeData) return;
            
            const sensorColors = {
                temperature: '#10b981',
                humidity: '#3b82f6',
                ph: '#8b5cf6',
                soil: '#f59e0b',
                thermocouple: '#ef4444',
                current: '#22c55e'
            };
            
            const sensorGradients = {
                temperature: ['rgba(16, 185, 129, 0.3)', 'rgba(16, 185, 129, 0.05)'],
                humidity: ['rgba(59, 130, 246, 0.3)', 'rgba(59, 130, 246, 0.05)'],
                ph: ['rgba(139, 92, 246, 0.3)', 'rgba(139, 92, 246, 0.05)'],
                soil: ['rgba(245, 158, 11, 0.3)', 'rgba(245, 158, 11, 0.05)'],
                thermocouple: ['rgba(239, 68, 68, 0.3)', 'rgba(239, 68, 68, 0.05)'],
                current: ['rgba(34, 197, 94, 0.3)', 'rgba(34, 197, 94, 0.05)']
            };
            
            // Update to single dataset for fixed time view
            historicalChart.data.datasets = [{
                label: 'Données Historiques',
                data: fixedTimeData,
                borderColor: sensorColors[currentHistoricalSensor],
                backgroundColor: function(context) {
                    const chart = context.chart;
                    const {ctx} = chart;
                    const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                    gradient.addColorStop(0, sensorGradients[currentHistoricalSensor][0]);
                    gradient.addColorStop(1, sensorGradients[currentHistoricalSensor][1]);
                    return gradient;
                },
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 3,
                pointHoverRadius: 6
            }];
            
            // Update options for fixed time view
            historicalChart.options = getHistoricalChartOptions(currentHistoricalSensor);
            historicalChart.options.scales.x.time.unit = 'minute';
            historicalChart.options.scales.x.time.displayFormats = { minute: 'HH:mm' };
            
            historicalChart.update('active');
        }

        function toggleDateRangeMode() {
            const controls = document.getElementById('dateRangeControls');
            const toggleBtn = document.getElementById('toggleDateRange');
            
            isDateRangeMode = !isDateRangeMode;
            
            if (isDateRangeMode) {
                controls.style.display = 'flex';
                toggleBtn.innerHTML = '<i class="fas fa-calendar-alt"></i> Désactiver';
                toggleBtn.style.background = '#3b82f6';
                toggleBtn.style.color = 'white';
                toggleBtn.style.border = 'none';
                
                // Set default dates (last 7 days)
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(endDate.getDate() - 7);
                
                document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
                document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
                
                // Disable fixed time mode if active
                if (isFixedTimeMode) {
                    toggleFixedTimeMode();
                }
            } else {
                controls.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-calendar-alt"></i> Activer';
                toggleBtn.style.background = 'white';
                toggleBtn.style.color = '#64748b';
                toggleBtn.style.border = '1px solid #e2e8f0';
                resetToLiveData();
            }
        }

        function loadDateRangeData() {
            const startDateInput = document.getElementById('startDate').value;
            const endDateInput = document.getElementById('endDate').value;
            
            if (!startDateInput || !endDateInput) {
                alert('Veuillez sélectionner une période de début et de fin.');
                return;
            }
            
            const startDate = new Date(startDateInput);
            const endDate = new Date(endDateInput);
            const now = new Date();
            
            if (startDate > endDate) {
                alert('La période de début doit être antérieure à la période de fin.');
                return;
            }
            
            if (endDate > now) {
                alert('La période de fin ne peut pas être dans le futur.');
                return;
            }
            
            const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            if (daysDiff > 365) {
                alert('La période sélectionnée ne peut pas dépasser 365 jours.');
                return;
            }
            
            // Generate date range data
            dateRangeData = generateDateRangeData(startDate, endDate, currentHistoricalSensor);
            
            // Update chart title to show date range
            const chartTitle = document.querySelector('#historicalChart').closest('div').querySelector('h3');
            if (chartTitle) {
                chartTitle.innerHTML = `Données du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}`;
            }
            
            // Update chart with date range data
            updateHistoricalChartWithDateRange();
        }

        function generateDateRangeData(startDate, endDate, sensor) {
            const snapshot = window.latestSensorSnapshot || null;
            const keyMap = { 
                temperature: 'temperature', 
                humidity: 'humidity', 
                soil: 'soil_moisture', 
                thermocouple: 'thermocouple_temperature', 
                current: 'current', 
                light: 'light_level' 
            };
            
            const data = [];
            const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            const baseValue = snapshot ? snapshot[keyMap[sensor]] : Math.random() * 50 + 20;
            
            // Determine data point interval based on range
            let intervalHours = 1; // Default: hourly
            if (daysDiff > 30) intervalHours = 6; // 6-hourly for >30 days
            if (daysDiff > 90) intervalHours = 12; // 12-hourly for >90 days
            if (daysDiff > 180) intervalHours = 24; // Daily for >180 days
            
            const totalPoints = Math.floor(daysDiff * 24 / intervalHours);
            
            for (let i = 0; i <= totalPoints; i++) {
                const time = new Date(startDate.getTime() + i * intervalHours * 60 * 60 * 1000);
                if (time > endDate) break;
                
                // Create realistic variation over time
                const dayProgress = (time - startDate) / (endDate - startDate);
                const seasonalVariation = Math.sin(dayProgress * Math.PI * 2) * 3;
                const dailyVariation = Math.sin((time.getHours() / 24) * Math.PI * 2) * 2;
                const randomNoise = (Math.random() - 0.5) * 2;
                
                const value = Math.max(0, baseValue + seasonalVariation + dailyVariation + randomNoise);
                data.push({ x: time, y: Number(value.toFixed(1)) });
            }
            
            return data;
        }

        function updateHistoricalChartWithDateRange() {
            if (!historicalChart || !dateRangeData) return;
            
            const sensorColors = {
                temperature: '#10b981',
                humidity: '#3b82f6',
                ph: '#8b5cf6',
                soil: '#f59e0b',
                thermocouple: '#ef4444',
                current: '#22c55e'
            };
            
            const sensorGradients = {
                temperature: ['rgba(16, 185, 129, 0.3)', 'rgba(16, 185, 129, 0.05)'],
                humidity: ['rgba(59, 130, 246, 0.3)', 'rgba(59, 130, 246, 0.05)'],
                ph: ['rgba(139, 92, 246, 0.3)', 'rgba(139, 92, 246, 0.05)'],
                soil: ['rgba(245, 158, 11, 0.3)', 'rgba(245, 158, 11, 0.05)'],
                thermocouple: ['rgba(239, 68, 68, 0.3)', 'rgba(239, 68, 68, 0.05)'],
                current: ['rgba(34, 197, 94, 0.3)', 'rgba(34, 197, 94, 0.05)']
            };
            
            // Update to single dataset for date range view
            historicalChart.data.datasets = [{
                label: 'Données Période Personnalisée',
                data: dateRangeData,
                borderColor: sensorColors[currentHistoricalSensor],
                backgroundColor: function(context) {
                    const chart = context.chart;
                    const {ctx} = chart;
                    const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                    gradient.addColorStop(0, sensorGradients[currentHistoricalSensor][0]);
                    gradient.addColorStop(1, sensorGradients[currentHistoricalSensor][1]);
                    return gradient;
                },
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 2,
                pointHoverRadius: 5
            }];
            
            // Update options for date range view
            historicalChart.options = getHistoricalChartOptions(currentHistoricalSensor);
            
            // Determine appropriate time unit based on range
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            
            let timeUnit = 'day';
            let displayFormat = 'DD/MM';
            
            if (daysDiff <= 2) {
                timeUnit = 'hour';
                displayFormat = 'HH:mm';
            } else if (daysDiff <= 7) {
                timeUnit = 'day';
                displayFormat = 'DD/MM';
            } else if (daysDiff <= 30) {
                timeUnit = 'day';
                displayFormat = 'DD/MM';
            } else if (daysDiff <= 90) {
                timeUnit = 'week';
                displayFormat = 'DD/MM';
            } else {
                timeUnit = 'month';
                displayFormat = 'MM/YYYY';
            }
            
            historicalChart.options.scales.x.time.unit = timeUnit;
            historicalChart.options.scales.x.time.displayFormats = {};
            historicalChart.options.scales.x.time.displayFormats[timeUnit] = displayFormat;
            
            historicalChart.update('active');
        }

        function findMaxValue() {
            if (!historicalChart || !historicalChart.data.datasets.length) return;
            
            // Clear existing annotations
            clearMaxMin();
            
            // Find max value from all datasets
            let maxValue = -Infinity;
            let maxPoint = null;
            let maxDatasetIndex = 0;
            
            historicalChart.data.datasets.forEach((dataset, datasetIndex) => {
                if (dataset.data && dataset.data.length > 0) {
                    dataset.data.forEach((point, pointIndex) => {
                        if (point.y > maxValue) {
                            maxValue = point.y;
                            maxPoint = point;
                            maxDatasetIndex = datasetIndex;
                        }
                    });
                }
            });
            
            if (maxPoint) {
                // Add annotation for max point
                const annotation = {
                    type: 'point',
                    xValue: maxPoint.x,
                    yValue: maxPoint.y,
                    backgroundColor: 'rgba(16, 185, 129, 0.8)',
                    borderColor: '#10b981',
                    borderWidth: 3,
                    radius: 8,
                    label: {
                        content: `MAX: ${maxValue}`,
                        enabled: true,
                        position: 'top',
                        backgroundColor: '#10b981',
                        color: 'white',
                        font: { size: 12, weight: 'bold' },
                        padding: 6,
                        cornerRadius: 4
                    }
                };
                
                maxMinAnnotations.push(annotation);
                updateChartAnnotations();
                
                // Show info message
                const sensorConfig = {
                    temperature: { unit: '°C' },
                    humidity: { unit: '%' },
                    ph: { unit: '' },
                    soil: { unit: '%' },
                    thermocouple: { unit: '°C' },
                    current: { unit: 'A' }
                };
                
                const unit = sensorConfig[currentHistoricalSensor]?.unit || '';
                const dateStr = new Date(maxPoint.x).toLocaleString('fr-FR');
                
                alert(`Valeur maximale trouvée: ${maxValue}${unit}\nDate: ${dateStr}`);
            }
        }
        
        function findMinValue() {
            if (!historicalChart || !historicalChart.data.datasets.length) return;
            
            // Clear existing annotations
            clearMaxMin();
            
            // Find min value from all datasets
            let minValue = Infinity;
            let minPoint = null;
            let minDatasetIndex = 0;
            
            historicalChart.data.datasets.forEach((dataset, datasetIndex) => {
                if (dataset.data && dataset.data.length > 0) {
                    dataset.data.forEach((point, pointIndex) => {
                        if (point.y < minValue) {
                            minValue = point.y;
                            minPoint = point;
                            minDatasetIndex = datasetIndex;
                        }
                    });
                }
            });
            
            if (minPoint) {
                // Add annotation for min point
                const annotation = {
                    type: 'point',
                    xValue: minPoint.x,
                    yValue: minPoint.y,
                    backgroundColor: 'rgba(239, 68, 68, 0.8)',
                    borderColor: '#ef4444',
                    borderWidth: 3,
                    radius: 8,
                    label: {
                        content: `MIN: ${minValue}`,
                        enabled: true,
                        position: 'bottom',
                        backgroundColor: '#ef4444',
                        color: 'white',
                        font: { size: 12, weight: 'bold' },
                        padding: 6,
                        cornerRadius: 4
                    }
                };
                
                maxMinAnnotations.push(annotation);
                updateChartAnnotations();
                
                // Show info message
                const sensorConfig = {
                    temperature: { unit: '°C' },
                    humidity: { unit: '%' },
                    ph: { unit: '' },
                    soil: { unit: '%' },
                    thermocouple: { unit: '°C' },
                    current: { unit: 'A' }
                };
                
                const unit = sensorConfig[currentHistoricalSensor]?.unit || '';
                const dateStr = new Date(minPoint.x).toLocaleString('fr-FR');
                
                alert(`Valeur minimale trouvée: ${minValue}${unit}\nDate: ${dateStr}`);
            }
        }
        
        function clearMaxMin() {
            maxMinAnnotations = [];
            updateChartAnnotations();
        }
        
        function updateChartAnnotations() {
            if (!historicalChart) return;
            
            // Initialize annotations plugin if not exists
            if (!historicalChart.options.plugins) {
                historicalChart.options.plugins = {};
            }
            
            if (!historicalChart.options.plugins.annotation) {
                historicalChart.options.plugins.annotation = {
                    annotations: {}
                };
            }
            
            // Clear existing annotations
            historicalChart.options.plugins.annotation.annotations = {};
            
            // Add max/min annotations
            maxMinAnnotations.forEach((annotation, index) => {
                historicalChart.options.plugins.annotation.annotations[`maxmin_${index}`] = annotation;
            });
            
            historicalChart.update('none');
        }

        function resetToLiveData() {
            isFixedTimeMode = false;
            isDateRangeMode = false;
            fixedTimeData = null;
            dateRangeData = null;
            
            // Clear max/min annotations
            clearMaxMin();
            
            // Reset chart title
            const chartTitle = document.querySelector('#historicalChart').closest('div').querySelector('h3');
            if (chartTitle) {
                chartTitle.innerHTML = 'Comparaison Périodes';
            }
            
            // Reset to normal historical view
            updateHistoricalChart(currentHistoricalPeriod, currentHistoricalSensor);
        }

        function updateHistoricalChart(period, sensor) {
            if (!historicalChart) return;
            
            // If in fixed time mode, don't update with period data
            if (isFixedTimeMode && fixedTimeData) {
                updateHistoricalChartWithFixedData();
                return;
            }
            
            // If in date range mode, don't update with period data
            if (isDateRangeMode && dateRangeData) {
                updateHistoricalChartWithDateRange();
                return;
            }
            
            const sensorData = generateHistoricalData(period, sensor);
            const sensorColors = {
                temperature: '#10b981',
                humidity: '#3b82f6',
                ph: '#8b5cf6',
                soil: '#f59e0b',
                thermocouple: '#ef4444',
                current: '#22c55e'
            };
            
            const sensorGradients = {
                temperature: ['rgba(16, 185, 129, 0.3)', 'rgba(16, 185, 129, 0.05)'],
                humidity: ['rgba(59, 130, 246, 0.3)', 'rgba(59, 130, 246, 0.05)'],
                ph: ['rgba(139, 92, 246, 0.3)', 'rgba(139, 92, 246, 0.05)'],
                soil: ['rgba(245, 158, 11, 0.3)', 'rgba(245, 158, 11, 0.05)'],
                thermocouple: ['rgba(239, 68, 68, 0.3)', 'rgba(239, 68, 68, 0.05)'],
                current: ['rgba(34, 197, 94, 0.3)', 'rgba(34, 197, 94, 0.05)']
            };
            
            // Reset to dual dataset for period comparison
            historicalChart.data.datasets = [
                {
                    label: 'Période Actuelle',
                    data: sensorData.current,
                    borderColor: sensorColors[sensor],
                    backgroundColor: function(context) {
                        const chart = context.chart;
                        const {ctx} = chart;
                        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                        gradient.addColorStop(0, sensorGradients[sensor][0]);
                        gradient.addColorStop(1, sensorGradients[sensor][1]);
                        return gradient;
                    },
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Période Précédente',
                    data: sensorData.previous,
                    borderColor: '#94a3b8',
                    backgroundColor: 'rgba(148, 163, 184, 0.1)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.4
                }
            ];
            
            // Update options for the new sensor
            historicalChart.options = getHistoricalChartOptions(sensor);
            
            // Update time unit based on period
            const timeUnit = period === '7d' ? 'day' : period === '30d' ? 'day' : period === '90d' ? 'week' : 'month';
            historicalChart.options.scales.x.time.unit = timeUnit;
            
            historicalChart.update('active');
        }

        // Advanced Alert System Functions
        function initializeAlertSystem() {
            // Start monitoring alerts every 30 seconds
            alertCheckInterval = setInterval(checkSystemAlerts, 30000);
            
            // Initial check
            checkSystemAlerts();
        }

        function checkSystemAlerts() {
            const snapshot = window.latestSensorSnapshot || null;
            const newAlerts = [];
            
            if (snapshot) {
                // Temperature alerts
                if (snapshot.temperature !== undefined && snapshot.temperature !== null) {
                    if (snapshot.temperature > 35) {
                        newAlerts.push({
                            id: 'temp_high_' + Date.now(),
                            type: 'critical',
                            title: 'Température Critique',
                            message: `Température élevée: ${snapshot.temperature.toFixed(1)}°C`,
                            timestamp: new Date(),
                            sensor: 'temperature',
                            value: snapshot.temperature,
                            threshold: 35,
                            icon: 'fas fa-thermometer-full'
                        });
                    } else if (snapshot.temperature < 5) {
                        newAlerts.push({
                            id: 'temp_low_' + Date.now(),
                            type: 'warning',
                            title: 'Température Basse',
                            message: `Température faible: ${snapshot.temperature.toFixed(1)}°C`,
                            timestamp: new Date(),
                            sensor: 'temperature',
                            value: snapshot.temperature,
                            threshold: 5,
                            icon: 'fas fa-thermometer-empty'
                        });
                    }
                }
                
                // Humidity alerts
                if (snapshot.humidity !== undefined && snapshot.humidity !== null) {
                    if (snapshot.humidity > 90) {
                        newAlerts.push({
                            id: 'hum_high_' + Date.now(),
                            type: 'warning',
                            title: 'Humidité Élevée',
                            message: `Humidité excessive: ${snapshot.humidity.toFixed(1)}%`,
                            timestamp: new Date(),
                            sensor: 'humidity',
                            value: snapshot.humidity,
                            threshold: 90,
                            icon: 'fas fa-tint'
                        });
                    } else if (snapshot.humidity < 20) {
                        newAlerts.push({
                            id: 'hum_low_' + Date.now(),
                            type: 'warning',
                            title: 'Humidité Faible',
                            message: `Air trop sec: ${snapshot.humidity.toFixed(1)}%`,
                            timestamp: new Date(),
                            sensor: 'humidity',
                            value: snapshot.humidity,
                            threshold: 20,
                            icon: 'fas fa-tint'
                        });
                    }
                }
                
                // Soil moisture alerts
                if (snapshot.soil_moisture !== undefined && snapshot.soil_moisture !== null) {
                    if (snapshot.soil_moisture < 25) {
                        newAlerts.push({
                            id: 'soil_low_' + Date.now(),
                            type: 'critical',
                            title: 'Sol Sec - Irrigation Requise',
                            message: `Humidité du sol: ${snapshot.soil_moisture.toFixed(1)}%`,
                            timestamp: new Date(),
                            sensor: 'soil_moisture',
                            value: snapshot.soil_moisture,
                            threshold: 25,
                            icon: 'fas fa-seedling'
                        });
                    }
                }
                
                // Thermocouple alerts
                if (snapshot.thermocouple_temperature !== undefined && snapshot.thermocouple_temperature !== null && snapshot.thermocouple_temperature !== -999.0) {
                    if (snapshot.thermocouple_temperature > 100) {
                        newAlerts.push({
                            id: 'thermocouple_high_' + Date.now(),
                            type: 'critical',
                            title: 'Température Thermocouple Élevée',
                            message: `Température thermocouple: ${snapshot.thermocouple_temperature.toFixed(1)}°C`,
                            timestamp: new Date(),
                            sensor: 'thermocouple_temperature',
                            value: snapshot.thermocouple_temperature,
                            threshold: 100,
                            icon: 'fas fa-thermometer-full'
                        });
                    } else if (snapshot.thermocouple_temperature < 50) {
                        newAlerts.push({
                            id: 'thermocouple_low_' + Date.now(),
                            type: 'warning',
                            title: 'Température Thermocouple Faible',
                            message: `Température thermocouple: ${snapshot.thermocouple_temperature.toFixed(1)}°C`,
                            timestamp: new Date(),
                            sensor: 'thermocouple_temperature',
                            value: snapshot.thermocouple_temperature,
                            threshold: 50,
                            icon: 'fas fa-thermometer-empty'
                        });
                    }
                }
                
                // Current alerts
                if (snapshot.current !== undefined && snapshot.current !== null) {
                    if (snapshot.current > 5.0) {
                        newAlerts.push({
                            id: 'current_high_' + Date.now(),
                            type: 'critical',
                            title: 'Courant Élevé',
                            message: `Courant: ${snapshot.current.toFixed(1)}A`,
                            timestamp: new Date(),
                            sensor: 'current',
                            value: snapshot.current,
                            threshold: 5.0,
                            icon: 'fas fa-bolt'
                        });
                    } else if (snapshot.current < 0.5) {
                        newAlerts.push({
                            id: 'current_low_' + Date.now(),
                            type: 'warning',
                            title: 'Courant Faible',
                            message: `Courant: ${snapshot.current.toFixed(1)}A`,
                            timestamp: new Date(),
                            sensor: 'current',
                            value: snapshot.current,
                            threshold: 0.5,
                            icon: 'fas fa-bolt'
                        });
                    }
                }
            }
            
            // Add system connectivity alerts
            const now = Date.now();
            const lastUpdate = window.lastSensorUpdate || 0;
            if (now - lastUpdate > 120000) { // 2 minutes without update
                newAlerts.push({
                    id: 'connectivity_' + Date.now(),
                    type: 'critical',
                    title: 'Perte de Connexion',
                    message: 'Aucune donnée reçue depuis plus de 2 minutes',
                    timestamp: new Date(),
                    sensor: 'system',
                    icon: 'fas fa-wifi'
                });
            }
            
            // Update alerts array (avoid duplicates)
            newAlerts.forEach(alert => {
                const existingAlert = systemAlerts.find(a => 
                    a.sensor === alert.sensor && 
                    a.type === alert.type && 
                    Math.abs(a.timestamp - alert.timestamp) < 60000 // Within 1 minute
                );
                
                if (!existingAlert) {
                    systemAlerts.unshift(alert);
                }
            });
            
            // Keep only last 50 alerts
            systemAlerts = systemAlerts.slice(0, 50);
            
            updateAlertDisplay();
        }

        function updateAlertDisplay() {
            const alertBadge = document.getElementById('alertBadge');
            const alertsContent = document.getElementById('alertsContent');
            
            if (!alertBadge || !alertsContent) return;
            
            // Update badge
            const criticalCount = systemAlerts.filter(a => a.type === 'critical').length;
            const totalCount = systemAlerts.length;
            
            alertBadge.textContent = totalCount;
            alertBadge.className = 'alert-badge';
            
            if (criticalCount > 0) {
                alertBadge.classList.add('critical');
            }
            
            if (totalCount === 0) {
                alertBadge.style.display = 'none';
            } else {
                alertBadge.style.display = 'flex';
            }
            
            // Update dropdown content
            if (systemAlerts.length === 0) {
                alertsContent.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #64748b;">
                        <i class="fas fa-check-circle" style="font-size: 2rem; color: #10b981; margin-bottom: 10px;"></i>
                        <div style="font-weight: 600; margin-bottom: 5px;">Aucune Alerte</div>
                        <div style="font-size: 0.9rem;">Tous les systèmes fonctionnent normalement</div>
                    </div>
                `;
            } else {
                alertsContent.innerHTML = systemAlerts.map(alert => {
                    const alertColors = {
                        critical: { bg: '#fee2e2', color: '#b91c1c', border: '#fecaca' },
                        warning: { bg: '#fef3c7', color: '#d97706', border: '#fde68a' },
                        info: { bg: '#dbeafe', color: '#2563eb', border: '#bfdbfe' }
                    };
                    
                    const colors = alertColors[alert.type] || alertColors.info;
                    const timeAgo = getTimeAgo(alert.timestamp);
                    
                    return `
                        <div class="dropdown-item alert-item" style="border-left: 4px solid ${colors.border}; background: ${colors.bg}; margin-bottom: 8px;">
                            <span class="item-icon" style="--icon-bg:${colors.bg};--icon-color:${colors.color}">
                                <i class="${alert.icon}" aria-hidden="true"></i>
                            </span>
                            <div class="item-info" style="flex: 1;">
                                <div class="item-title" style="color: ${colors.color}; font-weight: 600;">${alert.title}</div>
                                <div class="item-meta" style="color: #64748b; font-size: 0.85rem; margin: 2px 0;">${alert.message}</div>
                                <div class="item-meta" style="color: #94a3b8; font-size: 0.8rem;">${timeAgo}</div>
                            </div>
                            <button onclick="dismissAlert('${alert.id}')" style="background: none; border: none; color: #94a3b8; cursor: pointer; padding: 4px;" title="Ignorer">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                }).join('');
            }
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (days > 0) return `il y a ${days} jour${days > 1 ? 's' : ''}`;
            if (hours > 0) return `il y a ${hours} heure${hours > 1 ? 's' : ''}`;
            if (minutes > 0) return `il y a ${minutes} min`;
            return 'à l\'instant';
        }

        function dismissAlert(alertId) {
            systemAlerts = systemAlerts.filter(alert => alert.id !== alertId);
            updateAlertDisplay();
        }

        function clearAllAlerts() {
            systemAlerts = [];
            updateAlertDisplay();
        }

        function refreshAlerts() {
            checkSystemAlerts();
        }

        // Initialize sensor cards for sensors page using latest snapshot
        function initializeSensorCards() {
            const snapshot = window.latestSensorSnapshot || null;
            const cards = ['temperature', 'humidity', 'ph', 'soil', 'thermocouple', 'light'];

            cards.forEach(sensor => {
                const valueElement = document.getElementById(`${sensor}Value`);
                const statusElement = document.getElementById(`${sensor}Status`);
                if (!valueElement) return;

                let display = 'N/A';
                if (snapshot) {
                    switch (sensor) {
                        case 'temperature':
                            if (snapshot.temperature !== undefined && snapshot.temperature !== null) display = `${snapshot.temperature.toFixed(1)}°C`;
                            break;
                        case 'humidity':
                            if (snapshot.humidity !== undefined && snapshot.humidity !== null) display = `${snapshot.humidity.toFixed(1)}%`;
                            break;
                        case 'soil':
                            if (snapshot.soil_moisture !== undefined && snapshot.soil_moisture !== null) display = `${snapshot.soil_moisture}%`;
                            break;
                        case 'thermocouple':
                            if (snapshot.thermocouple_temperature !== undefined && snapshot.thermocouple_temperature !== -999.0 && snapshot.thermocouple_temperature !== null) display = `${snapshot.thermocouple_temperature.toFixed(1)}°C`;
                            break;
                        case 'light':
                            if (snapshot.light_level !== undefined && snapshot.light_level !== null) display = `${snapshot.light_level}%`;
                            break;
                    }
                }

                valueElement.textContent = display;
                if (statusElement) {
                    if (display === 'N/A' || display === 'Erreur') statusElement.textContent = 'Déconnecté';
                    else statusElement.textContent = 'Normal';
                }
            });
        }

        // Dropdowns: toggle, close on outside/Escape, keyboard navigation
        function initDropdowns() {
            console.log('🔧 initDropdowns called');
            const dropdownLis = Array.from(document.querySelectorAll('.top_menu ul .has-dropdown'));
            const toggles = Array.from(document.querySelectorAll('.top_menu ul .has-dropdown > a.nav-icon'));
            console.log('🔧 Found dropdown LIs:', dropdownLis.length, 'toggles:', toggles.length);

            function closeAll(except = null) {
                dropdownLis.forEach(li => {
                    if (li !== except) {
                        li.classList.remove('open');
                        const t = li.querySelector('a.nav-icon');
                        if (t) t.setAttribute('aria-expanded', 'false');
                        const m = li.querySelector('.dropdown-menu');
                        if (m) m.setAttribute('aria-hidden', 'true');
                    }
                });
            }

            toggles.forEach(toggle => {
                console.log('🔧 Setting up toggle for:', toggle.className, toggle.title);
                toggle.addEventListener('click', (e) => {
                    console.log('🔧 Toggle clicked:', toggle.className);
                    e.preventDefault();
                    e.stopPropagation();
                    const li = toggle.closest('.has-dropdown');
                    const isOpen = li.classList.contains('open');
                    
                    // Close all other submenus
                    document.querySelectorAll('.has-dropdown.open').forEach(item => {
                        if (item !== li) {
                            item.classList.remove('open');
                        }
                    });
                    
                    // Toggle current submenu
                    if (isOpen) {
                        li.classList.remove('open');
                    } else {
                        li.classList.add('open');
                    }
                    
                    // Update aria-expanded attribute
                    toggle.setAttribute('aria-expanded', li.classList.contains('open'));
                    
                    // Update menu aria-hidden attribute
                    const menu = li.querySelector('.dropdown-menu');
                    if (menu) {
                        menu.setAttribute('aria-hidden', !li.classList.contains('open'));
                    }
                    
                    // Focus first interactive element
                    const focusable = li.querySelector('.dropdown-item, .dropdown-action, input, select, button');
                    if (focusable && focusable.focus) focusable.focus();
                });

                toggle.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        const li = toggle.closest('.has-dropdown');
                        if (!li.classList.contains('open')) {
                            closeAll();
                            li.classList.add('open');
                            toggle.setAttribute('aria-expanded', 'true');
                            const menu = li.querySelector('.dropdown-menu');
                            if (menu) menu.setAttribute('aria-hidden', 'false');
                        }
                        const firstItem = li.querySelector('.dropdown-item');
                        if (firstItem) firstItem.focus();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        closeAll();
                        toggle.focus();
                    }
                });
            });

            dropdownLis.forEach(li => {
                const items = Array.from(li.querySelectorAll('.dropdown-item'));
                const menu = li.querySelector('.dropdown-menu');
                if (!menu) return;

                menu.addEventListener('click', (e) => {
                    // Prevent clicks inside from bubbling to document and closing immediately
                    e.stopPropagation();
                });

                menu.addEventListener('keydown', (e) => {
                    const currentIndex = items.indexOf(document.activeElement);
                    const focusables = Array.from(menu.querySelectorAll('.dropdown-action, .dropdown-item'));
                    // Trap focus within the dropdown when open
                    if (e.key === 'Tab' && focusables.length > 0) {
                        const idx = focusables.indexOf(document.activeElement);
                        if (!e.shiftKey && (idx === -1 || idx === focusables.length - 1)) {
                            e.preventDefault();
                            focusables[0].focus();
                            return;
                        } else if (e.shiftKey && (idx <= 0)) {
                            e.preventDefault();
                            focusables[focusables.length - 1].focus();
                            return;
                        }
                    }

                    if (items.length === 0) return;
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        const next = items[(currentIndex + 1) % items.length] || items[0];
                        next && next.focus();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        const prev = items[(currentIndex - 1 + items.length) % items.length] || items[items.length - 1];
                        prev && prev.focus();
                    } else if (e.key === 'Home') {
                        e.preventDefault();
                        items[0] && items[0].focus();
                    } else if (e.key === 'End') {
                        e.preventDefault();
                        items[items.length - 1] && items[items.length - 1].focus();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        li.classList.remove('open');
                        const t = li.querySelector('a.nav-icon');
                        if (t) {
                            t.setAttribute('aria-expanded', 'false');
                            t.focus();
                        }
                        const m = li.querySelector('.dropdown-menu');
                        if (m) m.setAttribute('aria-hidden', 'true');
                    }
                });
            });

            // Close on click outside
            document.addEventListener('click', (e) => {
                const withinDropdown = e.target.closest && e.target.closest('.has-dropdown');
                const withinMenu = e.target.closest && e.target.closest('.dropdown-menu');
                if (!withinDropdown && !withinMenu) {
                    closeAll();
                }
            });

            // Close on Escape anywhere
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeAll();
            });

            // Actions
            document.querySelectorAll('.dropdown-action').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const action = btn.getAttribute('data-action');
                    if (action === 'mark-all-read') {
                        const rootLi = btn.closest('.has-dropdown');
                        const badge = rootLi && rootLi.querySelector('.notification-badge');
                        // Clear the badge so it becomes empty and is hidden via .notification-badge:empty
                        if (badge) badge.textContent = '';
                    }
                });
            });
        }

        // Normalize notification badge visibility on load
        function syncNotificationBadgeVisibility() {
            const badges = document.querySelectorAll('.notification-badge');
            badges.forEach(badge => {
                const txt = (badge.textContent || '').trim();
                if (txt === '0') {
                    badge.textContent = '';
                }
            });
        }

        // Initialize app
        function init() {
            loadPage('home');
            setupAnimations();
            initPageTransitions();
            initNavbarScrollEffect();
            initDropdowns();
            syncNotificationBadgeVisibility();

            // Hide initial loader if present
            setTimeout(() => {
                if (pageLoader.classList.contains('active')) {
                    hidePageLoader();
                }
            }, 1000);
        }

        // Smooth Navbar Scroll Effect
        function initNavbarScrollEffect() {
            const navbar = document.querySelector('.wrapper .top_navbar');
            const topMarquee = document.querySelector('.top-marquee');
            const mainContainer = document.querySelector('.main_container');
            let lastScrollTop = 0;
            let ticking = false;

            function updateNavbar() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                if (scrollTop > 80) {
                    // Scrolling down - minimize navbar, top marquee, and adjust main content
                    navbar.classList.add('minimized');
                    if (topMarquee) {
                        topMarquee.classList.add('minimized');
                    }
                    if (mainContainer) {
                        mainContainer.classList.add('navbar-minimized');
                    }
                } else {
                    // At top - restore navbar, top marquee, and main content
                    navbar.classList.remove('minimized');
                    if (topMarquee) {
                        topMarquee.classList.remove('minimized');
                    }
                    if (mainContainer) {
                        mainContainer.classList.remove('navbar-minimized');
                    }
                }
                
                lastScrollTop = scrollTop;
                ticking = false;
            }

            function requestTick() {
                if (!ticking) {
                    requestAnimationFrame(updateNavbar);
                    ticking = true;
                }
            }

            // Use passive listener for better performance
            window.addEventListener('scroll', requestTick, { passive: true });
        }

        // Photo Carousel Functions
        let currentSlide = 0;
        const totalSlides = 6;
        let carouselInterval;

        function changeSlide(direction) {
            const slides = document.querySelectorAll('.carousel-slide');
            const indicators = document.querySelectorAll('.indicator');

            // Check if carousel elements exist
            if (!slides.length || !indicators.length || !slides[currentSlide] || !indicators[currentSlide]) {
                return;
            }

            // Remove active class from current slide and indicator
            slides[currentSlide].classList.remove('active');
            indicators[currentSlide].classList.remove('active');

            // Calculate new slide index
            currentSlide += direction;
            if (currentSlide >= totalSlides) currentSlide = 0;
            if (currentSlide < 0) currentSlide = totalSlides - 1;

            // Add active class to new slide and indicator if they exist
            if (slides[currentSlide] && indicators[currentSlide]) {
                slides[currentSlide].classList.add('active');
                indicators[currentSlide].classList.add('active');
            }

            updateProgress();
        }

        function goToSlide(slideIndex) {
            const slides = document.querySelectorAll('.carousel-slide');
            const indicators = document.querySelectorAll('.indicator');

            // Check if carousel elements exist
            if (!slides.length || !indicators.length || !slides[currentSlide] || !indicators[currentSlide]) {
                return;
            }

            // Remove active class from current slide and indicator
            slides[currentSlide].classList.remove('active');
            indicators[currentSlide].classList.remove('active');

            // Set new slide
            currentSlide = slideIndex;

            // Add active class to new slide and indicator if they exist
            if (slides[currentSlide] && indicators[currentSlide]) {
                slides[currentSlide].classList.add('active');
                indicators[currentSlide].classList.add('active');
            }

            updateProgress();
        }

        function updateProgress() {
            const progressBar = document.getElementById('carouselProgress');
            if (progressBar) {
                const progress = ((currentSlide + 1) / totalSlides) * 100;
                progressBar.style.width = progress + '%';
            }
        }

        function startCarouselAutoplay() {
            // Only start autoplay if carousel elements exist
            const slides = document.querySelectorAll('.carousel-slide');
            if (slides.length > 0) {
                carouselInterval = setInterval(() => {
                    changeSlide(1);
                }, 5000);
            }
        }

        function stopCarouselAutoplay() {
            if (carouselInterval) {
                clearInterval(carouselInterval);
            }
        }

        // Initialize carousel when on home page
        function initCarousel() {
            const carousel = document.querySelector('.photo-carousel');
            if (carousel) {
                updateProgress();
                startCarouselAutoplay();

                // Pause autoplay on hover
                carousel.addEventListener('mouseenter', stopCarouselAutoplay);
                carousel.addEventListener('mouseleave', startCarouselAutoplay);
            }
        }

        // Advanced Chart System with AI Analytics
        let charts = {};

        // Generate sensor data series using the latest real snapshot (window.latestSensorSnapshot)
        // Returns an array of {x: Date, y: Number}. If no snapshot is available, returns an empty array.
        function generateSensorData(type, hours = 24) {
                    console.log('🔧 generateSensorData called for type:', type);
                    // Prefer deterministic recent history built from successive /api/sensors snapshots.
                    // This avoids injecting random mock data while still producing a pleasing chart.
                    window.sensorHistory = window.sensorHistory || {};
                    const history = window.sensorHistory[type];
                    if (history && history.length) {
                        console.log('🔧 Using sensor history for', type, ':', history.length, 'points');
                        // Return a shallow copy so callers can safely mutate the dataset
                        return history.slice();
                    }

                    // Fallback: if no history exists yet, duplicate the latest snapshot value
                    const snapshot = window.latestSensorSnapshot || null;
                    console.log('🔧 Latest sensor snapshot:', snapshot);
                    const data = [];
                    if (!snapshot) {
                        console.log('❌ No sensor snapshot available, generating mock data for', type);
                        // Generate mock data if no snapshot is available
                        const mockValues = {
                            temperature: 25.5,
                            humidity: 65.0,
                            soil: 45.0,
                            thermocouple: 85.0,
                            light: 750,
                            current: 2.5
                        };
                        const mockVal = mockValues[type] || 0;
                        const now = Date.now();
                        const points = Math.min(settingsData.maxDataPoints || 48, 48);
                        for (let i = 0; i < points; i++) {
                            const ts = new Date(now - (points - i) * (hours * 60 * 60 * 1000) / points);
                            const variation = (Math.random() - 0.5) * (mockVal * 0.1); // 10% variation
                            data.push({ x: ts, y: Number((mockVal + variation).toFixed(1)) });
                        }
                        console.log('🔧 Generated mock data for', type, ':', data.length, 'points');
                        return data;
                    }

                    const keyMap = {
                        temperature: 'temperature',
                        humidity: 'humidity',
                        soil: 'soil_moisture',
                        thermocouple: 'thermocouple_temperature',
                        light: 'light_level',
                        current: 'current'
                    };

                    const val = snapshot[keyMap[type]];
                    console.log('🔧 Snapshot value for', type, ':', val);
                    if (val === undefined || val === null || isNaN(val)) {
                        console.log('❌ Invalid snapshot value for', type, ', returning empty data');
                        return data;
                    }

                    const now = Date.now();
                    const points = Math.min(settingsData.maxDataPoints || 48, 48);
                    for (let i = 0; i < points; i++) {
                        const ts = new Date(now - (points - i) * (hours * 60 * 60 * 1000) / points);
                        data.push({ x: ts, y: Number(parseFloat(val).toFixed(1)) });
                    }

                    console.log('🔧 Generated', data.length, 'data points for', type);
                    return data;
        }

        // Create gradient function for mountain-style charts
        function createGradient(ctx, color1, color2, color3) {
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(0.6, color2);
            gradient.addColorStop(1, color3);
            return gradient;
        }

        // Chart configurations with mountain-style styling
        const chartConfigs = {
            temperature: {
                data: {
                    datasets: [{
                        label: 'Température °C',
                        data: [], // Start with empty data, will be populated with real ESP32 data
                        borderColor: '#10b981',
                        backgroundColor: function(context) {
                            const chart = context.chart;
                            const {ctx} = chart;
                            return createGradient(ctx, 'rgba(16, 185, 129, 0.8)', 'rgba(16, 185, 129, 0.4)', 'rgba(16, 185, 129, 0.05)');
                        },
                        borderWidth: 4,
                        fill: 'start',
                        tension: 0.5,
                        pointRadius: 0,
                        pointHoverRadius: 0
                    }]
                },
                options: getChartOptions('°C', [15, 35])
            },
            humidity: {
                data: {
                    datasets: [{
                        label: 'Humidité %',
                        data: [], // Start with empty data, will be populated with real ESP32 data
                        borderColor: '#3b82f6',
                        backgroundColor: function(context) {
                            const chart = context.chart;
                            const {ctx} = chart;
                            return createGradient(ctx, 'rgba(59, 130, 246, 0.8)', 'rgba(59, 130, 246, 0.4)', 'rgba(59, 130, 246, 0.05)');
                        },
                        borderWidth: 4,
                        fill: 'start',
                        tension: 0.5,
                        pointRadius: 0,
                        pointHoverRadius: 0
                    }]
                },
                options: getChartOptions('%', [30, 90])
            },
            ph: {
                data: {
                    datasets: [{
                        label: 'pH',
                        data: [], // Start with empty data, will be populated with real ESP32 data
                        borderColor: '#8b5cf6',
                        backgroundColor: function(context) {
                            const chart = context.chart;
                            const {ctx} = chart;
                            return createGradient(ctx, 'rgba(139, 92, 246, 0.8)', 'rgba(139, 92, 246, 0.4)', 'rgba(139, 92, 246, 0.05)');
                        },
                        borderWidth: 4,
                        fill: 'start',
                        tension: 0.5,
                        pointRadius: 0,
                        pointHoverRadius: 0
                    }]
                },
                options: getChartOptions('pH', [5.5, 8.0])
            },
            soil: {
                data: {
                    datasets: [{
                        label: 'Humidité Sol %',
                        data: [], // Start with empty data, will be populated with real ESP32 data
                        borderColor: '#f59e0b',
                        backgroundColor: function(context) {
                            const chart = context.chart;
                            const {ctx} = chart;
                            return createGradient(ctx, 'rgba(245, 158, 11, 0.8)', 'rgba(245, 158, 11, 0.4)', 'rgba(245, 158, 11, 0.05)');
                        },
                        borderWidth: 4,
                        fill: 'start',
                        tension: 0.5,
                        pointRadius: 0,
                        pointHoverRadius: 0
                    }]
                },
                options: getChartOptions('%', [20, 80])
            },
            thermocouple: {
                data: {
                    datasets: [{
                        label: 'Thermocouple °C',
                        data: [], // Start with empty data, will be populated with real ESP32 data
                        borderColor: '#ef4444',
                        backgroundColor: function(context) {
                            const chart = context.chart;
                            const {ctx} = chart;
                            return createGradient(ctx, 'rgba(239, 68, 68, 0.8)', 'rgba(239, 68, 68, 0.4)', 'rgba(239, 68, 68, 0.05)');
                        },
                        borderWidth: 4,
                        fill: 'start',
                        tension: 0.5,
                        pointRadius: 0,
                        pointHoverRadius: 0
                    }]
                },
                options: getChartOptions('°C', [20, 120])
            },
            current: {
                data: {
                    datasets: [{
                        label: 'Courant (A)',
                        data: [], // Start with empty data, will be populated with real ESP32 data
                        borderColor: '#22c55e',
                        backgroundColor: function(context) {
                            const chart = context.chart;
                            const {ctx} = chart;
                            return createGradient(ctx, 'rgba(34, 197, 94, 0.8)', 'rgba(34, 197, 94, 0.4)', 'rgba(34, 197, 94, 0.05)');
                        },
                        borderWidth: 4,
                        fill: 'start',
                        tension: 0.5,
                        pointRadius: 0,
                        pointHoverRadius: 0
                    }]
                },
                options: getChartOptions('A', [0, 10])
            }
        };

        function getChartOptions(unit, yRange) {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            
            return {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 25,
                        bottom: 10,
                        left: 10,
                        right: 10
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: isDark ? 'rgba(30, 41, 59, 0.95)' : 'rgba(15, 23, 42, 0.95)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: isDark ? 'rgba(255, 255, 255, 0.2)' : 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        cornerRadius: 16,
                        displayColors: false,
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        padding: 16,
                        callbacks: {
                            title: function(context) {
                                return 'Time: ' + new Date(context[0].parsed.x).toLocaleTimeString();
                            },
                            label: function(context) {
                                return `${context.parsed.y}${unit}`;
                            }
                        }
                    },
                    datalabels: {
                        display: function(context) {
                            // Show every 3rd data point to avoid overcrowding
                            return context.dataIndex % 3 === 0;
                        },
                        align: function(context) {
                            // Alternate between top and bottom to avoid overlap
                            return context.dataIndex % 6 === 0 ? 'top' : 'bottom';
                        },
                        anchor: 'center',
                        offset: function(context) {
                            // Dynamic offset based on position
                            return context.dataIndex % 6 === 0 ? 15 : -15;
                        },
                        color: isDark ? '#94a3b8' : '#64748b',
                        backgroundColor: function(context) {
                            // Semi-transparent background for better readability
                            return isDark ? 'rgba(30, 41, 59, 0.8)' : 'rgba(255, 255, 255, 0.9)';
                        },
                        borderColor: isDark ? 'rgba(148, 163, 184, 0.3)' : 'rgba(100, 116, 139, 0.3)',
                        borderWidth: 1,
                        borderRadius: 4,
                        padding: {
                            top: 2,
                            bottom: 2,
                            left: 4,
                            right: 4
                        },
                        font: {
                            size: 9,
                            weight: '600'
                        },
                        formatter: function(value, context) {
                            return value.y + unit;
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'hour',
                            displayFormats: {
                                hour: 'HH:mm'
                            }
                        },
                        display: false,
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        min: yRange[0] * 0.95,
                        max: yRange[1] * 1.05,
                        display: false,
                        grid: {
                            display: false
                        }
                    }
                },
                elements: {
                    point: {
                        radius: 0,
                        hoverRadius: 0,
                        pointStyle: false
                    }
                },
                animation: {
                    duration: 2500,
                    easing: 'easeInOutQuart'
                }
            };
        }

        function initializeCharts() {
            const chartTypes = ['temperature', 'humidity', 'ph', 'soil', 'thermocouple', 'current'];
            
            // Clear any existing charts first
            Object.keys(charts).forEach(type => {
                if (charts[type]) {
                    charts[type].destroy();
                }
            });
            charts = {};
            
            chartTypes.forEach(type => {
                const canvas = document.getElementById(`${type}Chart`);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    
                    // Regenerate data for each chart
                    chartConfigs[type].data.datasets[0].data = generateSensorData(type);
                    
                    charts[type] = new Chart(ctx, {
                        type: 'line',
                        data: chartConfigs[type].data,
                        options: chartConfigs[type].options,
                        plugins: [ChartDataLabels]
                    });
                    
                    // Update initial stats display
                    updateStatsDisplay(type, chartConfigs[type].data.datasets[0].data);
                }
            });
        }

        function refreshChart(type) {
            if (charts[type]) {
                // Add refresh animation to button
                const button = event.target.closest('.chart-btn');
                button.style.transform = 'scale(0.95)';
                button.querySelector('i').style.animation = 'spin 0.5s linear';
                
                setTimeout(() => {
                    button.style.transform = '';
                    button.querySelector('i').style.animation = '';
                }, 500);

                // Update chart data with new values
                const newData = generateSensorData(type);
                charts[type].data.datasets[0].data = newData;
                charts[type].update('active');

                // Update stats display
                updateStatsDisplay(type, newData);
            }
        }

        function updateStatsDisplay(type, data) {
            const statsContainer = document.getElementById(`${type}Stats`);
            if (!statsContainer) return;
            
            const values = data.map(point => point.y);
            const current = values[values.length - 1];
            
            const unit = type === 'temperature' ? '°C' : 
                        type === 'thermocouple' ? '°C' :
                        type === 'ph' ? '' : '%';
            
            const currentElement = statsContainer.querySelector('.current');
            if (currentElement) {
                currentElement.textContent = `${current}${unit}`;
            }
        }

        // Function to update sensor values from ESP32 API (defensive DOM updates)
        function updateSensorValues() {
            // Fetch both sensor data and system info to get complete state
            Promise.all([
                fetch('/api/sensors').then(response => response.json()).catch(() => ({})),
                fetch('/api/system-info').then(response => response.json()).catch(() => ({}))
            ]).then(([sensorData, systemInfo]) => {
                // Cache latest snapshot for charts and other components
                window.latestSensorSnapshot = sensorData || {};

                // Push new samples into deterministic history buffers for charts
                (function pushToHistory(snapshot){
                    window.sensorHistory = window.sensorHistory || {};
                    const keyMap = {
                        temperature: 'temperature',
                        humidity: 'humidity',
                        soil: 'soil_moisture',
                        thermocouple: 'thermocouple_temperature',
                        light: 'light_level',
                        current: 'current'
                    };

                    const types = Object.keys(keyMap);
                    const maxPoints = Math.min(settingsData?.maxDataPoints || 48, 96);
                    const ts = new Date();
                    types.forEach(type => {
                        const key = keyMap[type];
                        let val = snapshot[key];
                        // treat sentinel invalid thermocouple as missing
                        if (type === 'thermocouple' && (val === -999.0 || val === null || val === undefined)) return;
                        if (val === null || val === undefined || isNaN(val)) return;
                        val = Number(parseFloat(val).toFixed(1));
                        window.sensorHistory[type] = window.sensorHistory[type] || [];
                        window.sensorHistory[type].push({ x: ts, y: val });
                        // Trim to maxPoints
                        if (window.sensorHistory[type].length > maxPoints) {
                            window.sensorHistory[type].splice(0, window.sensorHistory[type].length - maxPoints);
                        }
                    });
                })(sensorData || {});
                // Helper to safely set textContent
                function setText(id, value) {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                }

                // Temperature
                if (sensorData.temperature !== undefined && !isNaN(sensorData.temperature)) {
                    setText('temperatureValue', `${sensorData.temperature.toFixed(1)}°C`);
                } else {
                    setText('temperatureValue', 'N/A');
                }

                // Humidity
                if (sensorData.humidity !== undefined && !isNaN(sensorData.humidity)) {
                    setText('humidityValue', `${sensorData.humidity.toFixed(1)}%`);
                } else {
                    setText('humidityValue', 'N/A');
                }


                // Soil moisture
                if (sensorData.soil_moisture !== undefined && !isNaN(sensorData.soil_moisture)) {
                    setText('soilValue', `${sensorData.soil_moisture}%`);
                } else {
                    setText('soilValue', 'N/A');
                }

                // Thermocouple
                if (sensorData.thermocouple_temperature !== undefined && sensorData.thermocouple_temperature !== -999.0) {
                    setText('thermocoupleValue', `${sensorData.thermocouple_temperature.toFixed(1)}°C`);
                    const thermocoupleStatus = document.getElementById('thermocoupleStatus');
                    if (thermocoupleStatus) {
                        if (sensorData.thermocouple_temperature > 100) {
                            thermocoupleStatus.textContent = 'Élevée';
                            thermocoupleStatus.style.background = 'rgba(239, 68, 68, 0.2)';
                            thermocoupleStatus.style.color = '#dc2626';
                        } else if (sensorData.thermocouple_temperature > 50) {
                            thermocoupleStatus.textContent = 'Modérée';
                            thermocoupleStatus.style.background = 'rgba(245, 158, 11, 0.2)';
                            thermocoupleStatus.style.color = '#d97706';
                        } else {
                            thermocoupleStatus.textContent = 'Normal';
                            thermocoupleStatus.style.background = 'rgba(16, 185, 129, 0.1)';
                            thermocoupleStatus.style.color = '#059669';
                        }
                    }
                } else {
                    setText('thermocoupleValue', 'Erreur');
                    setText('thermocoupleStatus', 'Déconnecté');
                }

                // Light level
                if (sensorData.light_level !== undefined && !isNaN(sensorData.light_level)) {
                    setText('lightValue', `${sensorData.light_level}%`);
                } else {
                    setText('lightValue', 'N/A');
                }

                // Voltage
                if (sensorData.voltage !== undefined && !isNaN(sensorData.voltage)) {
                    setText('voltageValue', `${sensorData.voltage.toFixed(1)}V`);
                    const voltageStatus = document.getElementById('voltageStatus');
                    if (voltageStatus) {
                        if (sensorData.voltage < 11.0) {
                            voltageStatus.textContent = 'Faible';
                            voltageStatus.style.background = 'rgba(239, 68, 68, 0.2)';
                            voltageStatus.style.color = '#dc2626';
                        } else if (sensorData.voltage > 14.0) {
                            voltageStatus.textContent = 'Élevé';
                            voltageStatus.style.background = 'rgba(239, 68, 68, 0.2)';
                            voltageStatus.style.color = '#dc2626';
                        } else {
                            voltageStatus.textContent = 'Normal';
                            voltageStatus.style.background = 'rgba(245, 158, 11, 0.1)';
                            voltageStatus.style.color = '#d97706';
                        }
                    }
                } else {
                    setText('voltageValue', 'N/A');
                    setText('voltageStatus', 'Déconnecté');
                }

                // Current
                if (sensorData.current !== undefined && !isNaN(sensorData.current)) {
                    setText('currentValue', `${sensorData.current.toFixed(1)}A`);
                    const currentStatus = document.getElementById('currentStatus');
                    if (currentStatus) {
                        if (sensorData.current > 5.0) {
                            currentStatus.textContent = 'Élevé';
                            currentStatus.style.background = 'rgba(239, 68, 68, 0.2)';
                            currentStatus.style.color = '#dc2626';
                        } else if (sensorData.current < 0.5) {
                            currentStatus.textContent = 'Faible';
                            currentStatus.style.background = 'rgba(245, 158, 11, 0.2)';
                            currentStatus.style.color = '#d97706';
                        } else {
                            currentStatus.textContent = 'Normal';
                            currentStatus.style.background = 'rgba(139, 92, 246, 0.1)';
                            currentStatus.style.color = '#7c3aed';
                        }
                    }
                } else {
                    setText('currentValue', 'N/A');
                    setText('currentStatus', 'Déconnecté');
                }

                // Update actuator statuses from system info (guarded)
                if (systemInfo && typeof systemInfo === 'object') {
                    if (systemInfo.pump_status !== undefined) updateActuatorStatus('pump', systemInfo.pump_status);
                    if (systemInfo.light_status !== undefined) updateActuatorStatus('light', systemInfo.light_status);
                    if (systemInfo.fan_status !== undefined) updateActuatorStatus('fan', systemInfo.fan_status);
                    if (systemInfo.heater_status !== undefined) updateActuatorStatus('heater', systemInfo.heater_status);
                    if (systemInfo.valve_status !== undefined) updateActuatorStatus('valve', systemInfo.valve_status);
                }
            }).catch(error => {
                console.error('Error fetching sensor data:', error);
                // Use simulated data if API is not available
                updateSimulatedSensorValues();
            });
        }

        // Fallback function for simulated data when ESP32 is not connected
        function updateSimulatedSensorValues() {
            // Prefer explicit N/A to make it clear data is not live
            ['temperatureValue','humidityValue','phValue','soilValue','thermocoupleValue','voltageValue','currentValue','lightValue'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = 'N/A';
            });
        }

        // Actuator control functions
        function controlActuator(type, state) {
            fetch('/api/actuator', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `type=${type}&state=${state}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showNotification(`${type} ${state === 'on' ? 'activé' : 'désactivé'}`, 'success');
                    // Read back the actual state after a brief delay
                    setTimeout(() => {
                        updateSensorValues();
                    }, 500);
                } else {
                    showNotification(`Erreur: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error controlling actuator:', error);
                showNotification('Erreur de connexion', 'error');
            });
        }

        function controlPump(state) {
            fetch('/api/pump', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `state=${state}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showNotification(`Pompe ${state === 'on' ? 'activée' : 'désactivée'}`, 'success');
                    // Read back the actual state after a brief delay
                    setTimeout(() => {
                        updateSensorValues();
                    }, 500);
                } else {
                    showNotification(`Erreur: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error controlling pump:', error);
                showNotification('Erreur de connexion', 'error');
            });
        }

        function updateActuatorStatus(type, isOn) {
            const statusElement = document.getElementById(`${type}ActuatorStatus`);
            if (statusElement) {
                if (isOn) {
                    statusElement.textContent = type === 'pump' ? 'Active' : 
                                             type === 'light' ? 'Allumé' :
                                             type === 'fan' ? 'En marche' :
                                             type === 'heater' ? 'Chauffage' :
                                             type === 'valve' ? 'Ouverte' : 'Actif';
                    statusElement.style.background = '#10b981';
                } else {
                    statusElement.textContent = type === 'pump' ? 'Arrêtée' :
                                             type === 'light' ? 'Éteint' :
                                             type === 'fan' ? 'Arrêté' :
                                             type === 'heater' ? 'Arrêté' :
                                             type === 'valve' ? 'Fermée' : 'Arrêté';
                    statusElement.style.background = '#ef4444';
                }
            }
        }

        // Auto-refresh charts every 15 seconds with realistic data changes
        let chartRefreshInterval = null;
        
        function startChartAutoRefresh() {
            // Clear any existing interval
            if (chartRefreshInterval) {
                clearInterval(chartRefreshInterval);
            }
            
            // Only start if auto-refresh is enabled
            if (!settingsData.enableAutoRefresh) {
                return;
            }
            
            chartRefreshInterval = setInterval(() => {
                // Refresh live snapshot and update UI
                updateSensorValues();

                // Update charts from latest snapshot
                const chartTypes = ['temperature', 'humidity', 'ph', 'soil', 'thermocouple', 'current', 'light'];
                chartTypes.forEach(type => {
                    if (charts[type]) {
                        const newData = generateSensorData(type);
                        charts[type].data.datasets[0].data = newData;
                        charts[type].update('active');
                        updateStatsDisplay(type, newData);
                    }
                });
            }, settingsData.dataRefreshRate * 1000); // Use settings refresh rate
        }

        // ESP32 System Information Functions
        let esp32InfoInterval;
        
        function updateESP32Info() {
            // Fetch comprehensive system information
            Promise.all([
                fetch('/api/system-info').then(r => r.json()).catch(() => ({})),
                fetch('/api/sensors').then(r => r.json()).catch(() => ({}))
            ]).then(([systemInfo, sensorData]) => {
                // Update IP Address
                const ipElement = document.getElementById('ipAddress');
                if (ipElement && systemInfo.ip_address) {
                    ipElement.textContent = systemInfo.ip_address;
                }
                
                // Update WiFi Signal Strength
                const wifiElement = document.getElementById('wifiSignal');
                if (wifiElement && systemInfo.wifi_rssi) {
                    wifiElement.textContent = `${systemInfo.wifi_rssi} dBm`;
                    
                    // Update signal bars
                    const signalBars = document.getElementById('signalBars');
                    if (signalBars) {
                        const rssi = systemInfo.wifi_rssi;
                        signalBars.className = 'signal-bars';
                        if (rssi > -50) signalBars.classList.add('excellent');
                        else if (rssi > -60) signalBars.classList.add('good');
                        else if (rssi > -70) signalBars.classList.add('fair');
                        else signalBars.classList.add('poor');
                    }
                }
                
                // Update CPU Frequency
                const cpuElement = document.getElementById('cpuFreq');
                if (cpuElement && systemInfo.cpu_frequency) {
                    cpuElement.textContent = `${systemInfo.cpu_frequency} MHz`;
                }
                
                // Update Free RAM
                const ramElement = document.getElementById('freeRam');
                if (ramElement && systemInfo.free_ram) {
                    const ramKB = Math.round(systemInfo.free_ram / 1024);
                    ramElement.textContent = `${ramKB} KB`;
                    
                    // Update RAM usage bar
                    const ramBar = document.getElementById('ramUsageBar');
                    if (ramBar && systemInfo.total_ram) {
                        const usagePercent = ((systemInfo.total_ram - systemInfo.free_ram) / systemInfo.total_ram) * 100;
                        const fill = ramBar.querySelector('.usage-fill');
                        if (fill) {
                            fill.style.width = `${Math.min(usagePercent, 100)}%`;
                        }
                    }
                }
                
                // Update CPU Temperature (estimated)
                const tempElement = document.getElementById('cpuTemp');
                if (tempElement && systemInfo.cpu_temperature) {
                    const temp = Math.round(systemInfo.cpu_temperature);
                    tempElement.textContent = `${temp}°C`;
                    
                    // Update temperature indicator
                    const tempIndicator = document.getElementById('tempIndicator');
                    if (tempIndicator) {
                        tempIndicator.className = 'temp-indicator';
                        if (temp > 80) tempIndicator.classList.add('critical');
                        else if (temp > 70) tempIndicator.classList.add('hot');
                        else if (temp > 60) tempIndicator.classList.add('warm');
                    }
                }
                
                // Update Uptime
                const uptimeElement = document.getElementById('uptime');
                if (uptimeElement && systemInfo.uptime) {
                    const hours = Math.floor(systemInfo.uptime / 3600);
                    const minutes = Math.floor((systemInfo.uptime % 3600) / 60);
                    uptimeElement.textContent = `${hours}h ${minutes}m`;
                }
                
                // Update System Status
                const statusElement = document.getElementById('systemStatus');
                const statusTextElement = document.getElementById('systemStatusText');
                if (statusElement && statusTextElement && sensorData.system_status) {
                    statusElement.className = 'esp32-status-indicator';
                    
                    switch(sensorData.system_status) {
                        case 'critical':
                            statusElement.classList.add('critical');
                            statusTextElement.textContent = 'CRITICAL';
                            break;
                        case 'warning':
                            statusElement.classList.add('warning');
                            statusTextElement.textContent = 'WARNING';
                            break;
                        default:
                            statusTextElement.textContent = 'OK';
                            break;
                    }
                }
                
                // Update additional system information
                const flashElement = document.getElementById('flashUsage');
                if (flashElement && systemInfo.flash_size && systemInfo.sketch_size) {
                    const flashMB = (systemInfo.flash_size / 1024 / 1024).toFixed(1);
                    flashElement.textContent = `${flashMB} MB`;
                }
                
                const sketchElement = document.getElementById('sketchSize');
                if (sketchElement && systemInfo.sketch_size) {
                    const sketchMB = (systemInfo.sketch_size / 1024 / 1024).toFixed(1);
                    sketchElement.textContent = `${sketchMB} MB`;
                }
                
                const powerElement = document.getElementById('powerStatus');
                if (powerElement) {
                    powerElement.textContent = '3.3V'; // ESP32 standard voltage
                }
                
                const networkElement = document.getElementById('networkStatus');
                if (networkElement && systemInfo.wifi_status) {
                    networkElement.textContent = systemInfo.wifi_status === 'connected' ? 'Connected' : 'Disconnected';
                }
                
                // Update sensor and actuator counts
                const sensorElement = document.getElementById('sensorCount');
                if (sensorElement) {
                    let activeSensors = 0;
                    if (sensorData.temperature !== undefined && !isNaN(sensorData.temperature)) activeSensors++;
                    if (sensorData.humidity !== undefined && !isNaN(sensorData.humidity)) activeSensors++;
                    if (sensorData.soil_moisture !== undefined && !isNaN(sensorData.soil_moisture)) activeSensors++;
                    if (sensorData.thermocouple_temperature !== undefined && sensorData.thermocouple_temperature !== -999.0) activeSensors++;
                    // water_level removed
                    if (sensorData.soil_temperature !== undefined && !isNaN(sensorData.soil_temperature)) activeSensors++;
                    
                    sensorElement.textContent = `${activeSensors} Active`;
                }
                
                const actuatorElement = document.getElementById('actuatorCount');
                if (actuatorElement) {
                    let activeActuators = 0;
                    if (systemInfo.pump_status) activeActuators++;
                    if (systemInfo.light_status) activeActuators++;
                    if (systemInfo.fan_status) activeActuators++;
                    if (systemInfo.heater_status) activeActuators++;
                    if (systemInfo.valve_status) activeActuators++;
                    
                    actuatorElement.textContent = `${activeActuators}/5 Active`;
                }
                
                // Update actuator status dots
                const actuatorStatus = document.getElementById('actuatorStatus');
                if (actuatorStatus) {
                    const dots = actuatorStatus.querySelectorAll('.actuator-dot');
                    if (dots[0]) dots[0].className = `actuator-dot pump ${systemInfo.pump_status ? 'active' : ''}`;
                    if (dots[1]) dots[1].className = `actuator-dot light ${systemInfo.light_status ? 'active' : ''}`;
                    if (dots[2]) dots[2].className = `actuator-dot fan ${systemInfo.fan_status ? 'active' : ''}`;
                    if (dots[3]) dots[3].className = `actuator-dot heater ${systemInfo.heater_status ? 'active' : ''}`;
                    if (dots[4]) dots[4].className = `actuator-dot valve ${systemInfo.valve_status ? 'active' : ''}`;
                }
                
                // Update actuator status displays in control page
                if (systemInfo.pump_status !== undefined) {
                    updateActuatorStatus('pump', systemInfo.pump_status);
                }
                if (systemInfo.light_status !== undefined) {
                    updateActuatorStatus('light', systemInfo.light_status);
                }
                if (systemInfo.fan_status !== undefined) {
                    updateActuatorStatus('fan', systemInfo.fan_status);
                }
                if (systemInfo.heater_status !== undefined) {
                    updateActuatorStatus('heater', systemInfo.heater_status);
                }
                if (systemInfo.valve_status !== undefined) {
                    updateActuatorStatus('valve', systemInfo.valve_status);
                }
                
                // Add comprehensive system info tooltip
                const esp32InfoElement = document.getElementById('esp32Info');
                if (esp32InfoElement && systemInfo.chip_model) {
                    esp32InfoElement.title = `ESP32 ${systemInfo.chip_model} Rev${systemInfo.chip_revision || 0} | ` +
                        `${systemInfo.chip_cores || 2} cores @ ${systemInfo.cpu_frequency || 240}MHz | ` +
                        `RAM: ${Math.round((systemInfo.free_ram || 0) / 1024)}KB free / ${Math.round((systemInfo.total_ram || 0) / 1024)}KB total | ` +
                        `Flash: ${Math.round((systemInfo.flash_size || 0) / 1024 / 1024)}MB @ ${Math.round((systemInfo.flash_speed || 0) / 1000000)}MHz | ` +
                        `Sketch: ${Math.round((systemInfo.sketch_size || 0) / 1024)}KB | ` +
                        `WiFi: ${systemInfo.wifi_ssid || 'Unknown'} (${systemInfo.wifi_rssi || 'N/A'} dBm) | ` +
                        `Uptime: ${Math.floor((systemInfo.uptime || 0) / 3600)}h ${Math.floor(((systemInfo.uptime || 0) % 3600) / 60)}m`;
                }
                
            }).catch(error => {
                console.warn('Failed to update ESP32 info:', error);
                // Set error indicators
                const statusElement = document.getElementById('systemStatus');
                const statusTextElement = document.getElementById('systemStatusText');
                if (statusElement && statusTextElement) {
                    statusElement.className = 'esp32-status-indicator critical';
                    statusTextElement.textContent = 'OFFLINE';
                }
            });
        }
        
        function startESP32InfoUpdates() {
            if (esp32InfoInterval) {
                clearInterval(esp32InfoInterval);
            }
            updateESP32Info();
            esp32InfoInterval = setInterval(updateESP32Info, 5000);
        }
        
        function stopESP32InfoUpdates() {
            if (esp32InfoInterval) {
                clearInterval(esp32InfoInterval);
                esp32InfoInterval = null;
            }
        }

        // Camera connectivity check
        let cameraCheckInterval;
        
        async function checkCameraConnectivity() {
            const cameraIP = '192.168.1.100';
            const statusElement = document.getElementById('camera1Status');
            const ipElement = document.getElementById('cameraIP');
            
            try {
                // Try to fetch from the camera (this will likely fail due to CORS, but we can catch the error type)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000); // 3 second timeout
                
                const response = await fetch(`http://${cameraIP}`, {
                    method: 'HEAD',
                    mode: 'no-cors',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                // If we get here, camera is likely online
                updateCameraStatus(true);
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    // Timeout - camera is offline
                    updateCameraStatus(false);
                } else {
                    // CORS error usually means the server is responding (camera is online)
                    updateCameraStatus(true);
                }
            }
        }
        
        function updateCameraStatus(isOnline) {
            const statusElement = document.getElementById('camera1Status');
            const ipElement = document.getElementById('cameraIP');
            
            if (statusElement) {
                if (isOnline) {
                    statusElement.style.background = '#10b981';
                    statusElement.textContent = 'ONLINE';
                    statusElement.innerHTML = '<i class="fas fa-circle" style="margin-right: 4px; animation: pulse 2s infinite;"></i>ONLINE';
                } else {
                    statusElement.style.background = '#ef4444';
                    statusElement.textContent = 'OFFLINE';
                    statusElement.innerHTML = '<i class="fas fa-times-circle" style="margin-right: 4px;"></i>OFFLINE';
                }
            }
            
            if (ipElement) {
                ipElement.style.color = isOnline ? '#10b981' : '#ef4444';
                ipElement.style.fontWeight = isOnline ? '600' : '400';
            }
        }
        
        function startCameraMonitoring() {
            // Check immediately
            checkCameraConnectivity();
            
            // Then check every 10 seconds
            cameraCheckInterval = setInterval(checkCameraConnectivity, 10000);
        }
        
        function stopCameraMonitoring() {
            if (cameraCheckInterval) {
                clearInterval(cameraCheckInterval);
            }
        }

        // Initialize all charts
        function initializeAllCharts() {
            console.log('🔌 Initializing all charts...');
            // Initialize all charts
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            loadSavedTheme();
            loadSettings();
            init();
            
            // Start ESP32 system info updates
            startESP32InfoUpdates();
            
            // Load initial sensor and actuator states
            updateSensorValues();
            
            // Initialize advanced alert system
            initializeAlertSystem();
            
            // Initialize all charts
            setTimeout(() => {
                initializeAllCharts();
            }, 200);
            
            // Add ESP32 info click handler for detailed view
            const esp32InfoElement = document.getElementById('esp32Info');
            if (esp32InfoElement) {
                esp32InfoElement.addEventListener('click', function() {
                    fetch('/api/system-info')
                        .then(r => r.json())
                        .then(info => {
                            const details = [
                                `Chip: ${info.chip_model || 'ESP32'} Rev${info.chip_revision || 0}`,
                                `Cores: ${info.chip_cores || 2}`,
                                `CPU: ${info.cpu_frequency || 240} MHz`,
                                `Total RAM: ${Math.round((info.total_ram || 0) / 1024)} KB`,
                                `Free RAM: ${Math.round((info.free_ram || 0) / 1024)} KB`,
                                `Min Free RAM: ${Math.round((info.min_free_ram || 0) / 1024)} KB`,
                                `Flash Size: ${Math.round((info.flash_size || 0) / 1024 / 1024)} MB`,
                                `Flash Speed: ${Math.round((info.flash_speed || 0) / 1000000)} MHz`,
                                `Sketch Size: ${Math.round((info.sketch_size || 0) / 1024)} KB`,
                                `Free Sketch: ${Math.round((info.free_sketch_space || 0) / 1024)} KB`,
                                `WiFi SSID: ${info.wifi_ssid || 'Unknown'}`,
                                `WiFi RSSI: ${info.wifi_rssi || 'N/A'} dBm`,
                                `Reset Reason: ${info.reset_reason || 'Unknown'}`,
                                `Uptime: ${Math.floor((info.uptime || 0) / 3600)}h ${Math.floor(((info.uptime || 0) % 3600) / 60)}m`
                            ];
                            
                            showNotification(
                                'ESP32 System Information:\n' + details.join('\n'),
                                'info'
                            );
                        })
                        .catch(() => {
                            showNotification('Unable to fetch detailed system information', 'error');
                        });
                });
            }
        });

        // Fallback: explicit settings cog handler to guarantee toggle works
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🔧 Fallback handler setting up...');
            try {
                // Helper: position a dropdown menu under the toggle using fixed positioning so
                // it stays attached to the top nav and isn't clipped by parent overflow or page scroll.
                function positionDropdown(menu, toggle) {
                    if (!menu || !toggle) return;
                    // Reset any previous inline positioning
                    menu.style.position = 'fixed';
                    menu.style.right = 'auto';
                    menu.style.left = 'auto';
                    // Get bounding rect of the toggle (icon)
                    const rect = toggle.getBoundingClientRect();
                    // Prefer aligning menu's right edge with toggle's right edge
                    const menuWidth = Math.min(menu.offsetWidth || 420, Math.max(200, window.innerWidth - 24));
                    // Compute left so menu's right matches toggle's right
                    let left = rect.right - menuWidth;
                    // If left would go off-screen, clamp
                    if (left < 12) left = 12;
                    // Compute top so the dropdown visually sits flush under the top nav icon.
                    // The dropdown has a ::before arrow positioned at top: -8px; account for that
                    // by pulling the menu up so the arrow meets the icon edge (remove visible gap).
                    let top = rect.bottom - 8; // align arrow with toggle bottom
                    // If bottom would go off-screen, try to show above the toggle
                    const menuHeightGuess = Math.min(menu.offsetHeight || 360, window.innerHeight * 0.8);
                    if (top + menuHeightGuess > window.innerHeight - 12) {
                        // show above the toggle if enough space
                        if (rect.top - 6 - menuHeightGuess > 12) {
                            top = rect.top - 6 - menuHeightGuess;
                        } else {
                            // clamp to fit
                            top = Math.max(12, window.innerHeight - menuHeightGuess - 12);
                        }
                    }
                    menu.style.width = menuWidth + 'px';
                    menu.style.left = left + 'px';
                    menu.style.top = top + 'px';
                    menu.style.zIndex = '1400';
                    // small visual tweak: ensure transform reset for entrance
                    menu.style.transform = 'translateY(0) scale(1)';
                }

                function resetDropdownPosition(menu) {
                    if (!menu) return;
                    // Remove inline positioning to fall back to CSS absolute behavior
                    menu.style.position = '';
                    menu.style.left = '';
                    menu.style.right = '';
                    menu.style.top = '';
                    menu.style.width = '';
                    menu.style.zIndex = '';
                    // allow CSS transition to take effect
                    menu.style.transform = '';
                }

                const settingsToggle = document.querySelector('.nav-icon.settings');
                console.log('🔧 Settings toggle found:', !!settingsToggle);
                console.log('🔧 Initial li classes:', settingsToggle?.closest('.has-dropdown')?.className);
                if (settingsToggle && !settingsToggle._hasSettingsHandler) {
                    console.log('🔧 Adding fallback settings handler');
                    settingsToggle.addEventListener('click', (e) => {
                        console.log('🔧 Fallback settings clicked!');
                        e.preventDefault();
                        e.stopPropagation();

                        const li = settingsToggle.closest('.has-dropdown');
                        console.log('🔧 Found li element:', !!li, li);
                        if (!li) return;

                        let isOpen = li.classList.contains('open');
                        console.log('🔧 Is currently open:', isOpen);
                        console.log('🔧 Current li classes:', li.className);
                        console.log('🔧 Current menu visibility:', li.querySelector('.dropdown-menu')?.style.visibility);

                        // If it's already open but not visible, force reset
                        if (isOpen) {
                            const menu = li.querySelector('.dropdown-menu');
                            if (menu) {
                                const computedVisibility = window.getComputedStyle(menu).visibility;
                                console.log('🔧 Menu computed visibility:', computedVisibility);
                                if (computedVisibility === 'hidden') {
                                    console.log('🔧 Dropdown is open but hidden - forcing reset');
                                    li.classList.remove('open');
                                    isOpen = false; // Reset to false so it will open
                                }
                            }
                        }

                        // Close others
                        document.querySelectorAll('.has-dropdown.open').forEach(x => { if (x !== li) x.classList.remove('open'); });

            if (!isOpen) {
                            console.log('🔧 Opening dropdown...');
                            li.classList.add('open');
                            console.log('🔧 Added "open" class, li classes now:', li.className);
                            settingsToggle.setAttribute('aria-expanded', 'true');
                            const menu = li.querySelector('.dropdown-menu');
                            console.log('🔧 Found menu element:', !!menu, menu);
                            if (menu) {
                                menu.setAttribute('aria-hidden', 'false');
                // Position the dropdown so it visually attaches to the top nav
                try { positionDropdown(menu, settingsToggle); } catch (err) { console.warn('positionDropdown failed', err); }
                                console.log('🔧 Menu visibility style:', window.getComputedStyle(menu).visibility);
                                console.log('🔧 Menu opacity style:', window.getComputedStyle(menu).opacity);
                                console.log('🔧 Menu transform style:', window.getComputedStyle(menu).transform);
                                console.log('🔧 Menu display style:', window.getComputedStyle(menu).display);
                                console.log('🔧 Menu position style:', window.getComputedStyle(menu).position);
                                console.log('🔧 Menu z-index style:', window.getComputedStyle(menu).zIndex);
                                console.log('🔧 Menu bounding rect:', menu.getBoundingClientRect());
                                console.log('🔧 Parent li bounding rect:', li.getBoundingClientRect());
                                // Check for potential CSS conflicts
                                console.log('🔧 Checking for CSS conflicts...');
                                const allStyles = window.getComputedStyle(menu);
                                console.log('🔧 All menu styles:', {
                                    opacity: allStyles.opacity,
                                    visibility: allStyles.visibility,
                                    display: allStyles.display,
                                    transform: allStyles.transform,
                                    position: allStyles.position,
                                    zIndex: allStyles.zIndex,
                                    top: allStyles.top,
                                    left: allStyles.left,
                                    right: allStyles.right,
                                    width: allStyles.width,
                                    height: allStyles.height
                                });
                                
                                // Check parent elements for overflow hidden
                                let parent = menu.parentElement;
                                while (parent && parent !== document.body) {
                                    const parentStyles = window.getComputedStyle(parent);
                                    if (parentStyles.overflow === 'hidden' || parentStyles.overflowY === 'hidden') {
                                        console.log('🔧 Found parent with overflow hidden:', parent, parentStyles.overflow, parentStyles.overflowY);
                                    }
                                    parent = parent.parentElement;
                                }
                            }
                            try { loadSettings(); } catch (err) { console.warn('loadSettings on fallback failed', err); }
                            // focus first interactive element
                            const focusable = li.querySelector('.dropdown-item, .dropdown-action, input, select, button');
                            if (focusable && focusable.focus) focusable.focus();
                        } else {
                            console.log('🔧 Closing dropdown...');
                            li.classList.remove('open');
                            settingsToggle.setAttribute('aria-expanded', 'false');
                            const menu = li.querySelector('.dropdown-menu');
                            if (menu) menu.setAttribute('aria-hidden', 'true');
                            // Reset any inline positioning we applied
                            try { resetDropdownPosition(menu); } catch (err) { console.warn('resetDropdownPosition failed', err); }
                        }
                    });
                    settingsToggle._hasSettingsHandler = true;
                }
            } catch (e) {
                console.warn('Fallback settings handler setup failed', e);
            }
        });

        // Test function to manually open dropdown
        function testOpenDropdown() {
            const li = document.querySelector('.nav-icon.settings')?.closest('.has-dropdown');
            if (li) {
                li.classList.add('open');
                const toggle = document.querySelector('.nav-icon.settings');
                const menu = li.querySelector('.dropdown-menu');
                try { positionDropdown(menu, toggle); } catch (err) { console.warn('testOpen position failed', err); }
                console.log('🔧 Manually opened dropdown');
            }
        }

        // Add test button to page for debugging
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const testBtn = document.createElement('button');
                testBtn.textContent = 'Test Dropdown';
                testBtn.style.position = 'fixed';
                testBtn.style.bottom = '20px';
                testBtn.style.right = '20px';
                testBtn.style.zIndex = '9999';
                testBtn.style.padding = '10px';
                testBtn.onclick = testOpenDropdown;
                document.body.appendChild(testBtn);
            }, 1000);
        });

        // Camera control functions
        const cameraIP = '192.168.1.100';
        let cameraAutoRefresh = false;
        let cameraRefreshInterval = null;
        let flashState = false;
        let camera1SnapshotCounter = 0;
        let camera1FlashState = false;
        let camera1AutoCapture = false;
        let camera1AutoInterval = null;
        let camera1IntervalTime = 5000; // Default 5 seconds

        // Camera 1 specific functions
        function captureCamera1() {
            const img = document.getElementById('camera1Snapshot');
            const placeholder = document.getElementById('camera1Placeholder');
            const liveStatus = document.getElementById('camera1LiveStatus');
            const snapshotCountEl = document.getElementById('camera1SnapshotCount');
            const statusBadge = document.getElementById('camera1Status');
            const lastCaptureEl = document.getElementById('camera1LastCapture');
            
            // Create new image with timestamp to avoid caching
            const captureUrl = `http://${cameraIP}/capture?t=${Date.now()}`;
            
            // Create a new image element to test loading
            const testImg = new Image();
            testImg.onload = function() {
                // Success - show the image
                img.src = captureUrl;
                img.style.display = 'block';
                placeholder.style.display = 'none';
                liveStatus.style.display = 'block';
                
                // Update counter and timestamp
                camera1SnapshotCounter++;
                snapshotCountEl.textContent = camera1SnapshotCounter;
                const now = new Date();
                lastCaptureEl.textContent = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                
                // Update status
                statusBadge.textContent = 'ONLINE';
                statusBadge.style.background = '#10b981';
                
                // Hide live status after 3 seconds
                setTimeout(() => {
                    liveStatus.style.display = 'none';
                }, 3000);
            };
            
            testImg.onerror = function() {
                // Error - show placeholder
                img.style.display = 'none';
                placeholder.style.display = 'flex';
                liveStatus.style.display = 'none';
                
                // Update placeholder for error
                placeholder.innerHTML = `
                    <div style="text-align: center; color: white;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 8px; display: block; opacity: 0.9; color: #ef4444;"></i>
                        <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Connexion Échouée</p>
                    </div>
                `;
                
                statusBadge.textContent = 'OFFLINE';
                statusBadge.style.background = '#ef4444';
            };
            
            testImg.src = captureUrl;
        }

        function downloadCamera1Snapshot() {
            const img = document.getElementById('camera1Snapshot');
            if (img.src && img.style.display !== 'none') {
                const link = document.createElement('a');
                link.href = img.src;
                link.download = `ESP32_CAM_1_${new Date().toISOString().replace(/[:.]/g, '-')}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert('Aucune image à télécharger. Prenez d\'abord une photo.');
            }
        }

        function resetCamera1() {
            if (confirm('Êtes-vous sûr de vouloir redémarrer la caméra ESP32 #1?')) {
                fetch(`http://${cameraIP}/reset`)
                    .then(response => {
                        if (response.ok) {
                            alert('Commande de redémarrage envoyée à la caméra.');
                            // Reset UI elements
                            document.getElementById('camera1Snapshot').style.display = 'none';
                            document.getElementById('camera1Placeholder').style.display = 'flex';
                            document.getElementById('camera1Status').textContent = 'REBOOT';
                            document.getElementById('camera1Status').style.background = '#f59e0b';
                        }
                    })
                    .catch(error => {
                        console.error('Reset error:', error);
                        alert('Erreur lors du redémarrage de la caméra.');
                    });
            }
        }

        function toggleCamera1Flash() {
            const btn = document.getElementById('camera1FlashBtn');
            const flashStatusEl = document.getElementById('camera1FlashStatus');
            
            // Toggle flash state
            camera1FlashState = !camera1FlashState;
            
            // Send flash command to ESP32
            fetch(`http://${cameraIP}/flash`)
                .then(response => response.text())
                .then(data => {
                    // Update button appearance and status
                    if (camera1FlashState) {
                        btn.style.background = '#f59e0b';
                        btn.innerHTML = '<i class="fas fa-lightbulb"></i> ON';
                        flashStatusEl.textContent = 'ON';
                        flashStatusEl.style.color = '#f59e0b';
                    } else {
                        btn.style.background = '#6b7280';
                        btn.innerHTML = '<i class="fas fa-lightbulb"></i> Flash';
                        flashStatusEl.textContent = 'OFF';
                        flashStatusEl.style.color = '#1e293b';
                    }
                })
                .catch(error => {
                    console.error('Flash toggle error:', error);
                    // Revert flash state on error
                    camera1FlashState = !camera1FlashState;
                    btn.style.background = '#ef4444';
                    btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Err';
                    setTimeout(() => {
                        btn.style.background = '#6b7280';
                        btn.innerHTML = '<i class="fas fa-lightbulb"></i> Flash';
                    }, 2000);
                });
        }

        // Camera 1 Auto-Capture Functions
        function toggleCamera1AutoCapture() {
            const btn = document.getElementById('camera1AutoBtn');
            const intervalDisplay = document.getElementById('camera1AutoInterval');
            
            camera1AutoCapture = !camera1AutoCapture;
            
            if (camera1AutoCapture) {
                // Start auto-capture
                camera1AutoInterval = setInterval(() => {
                    captureCamera1();
                }, camera1IntervalTime);
                
                btn.style.background = '#ef4444';
                btn.innerHTML = '<i class="fas fa-stop"></i> STOP';
                intervalDisplay.textContent = camera1IntervalTime < 1000 ? `${camera1IntervalTime}ms` : `${camera1IntervalTime/1000}s`;
                intervalDisplay.style.color = '#10b981';
            } else {
                // Stop auto-capture
                if (camera1AutoInterval) {
                    clearInterval(camera1AutoInterval);
                    camera1AutoInterval = null;
                }
                
                btn.style.background = '#6b7280';
                btn.innerHTML = '<i class="fas fa-play"></i> START';
                intervalDisplay.textContent = 'OFF';
                intervalDisplay.style.color = '#64748b';
            }
        }

        function setCamera1Interval(interval) {
            camera1IntervalTime = parseInt(interval);
            const intervalDisplay = document.getElementById('camera1AutoInterval');
            
            // If auto-capture is running, restart with new interval
            if (camera1AutoCapture) {
                toggleCamera1AutoCapture(); // Stop
                toggleCamera1AutoCapture(); // Start with new interval
            } else {
                intervalDisplay.textContent = 'OFF';
            }
        }

        // Update camera uptime and signal periodically
        setInterval(() => {
            const uptimeEl = document.getElementById('camera1Uptime');
            const signalEl = document.getElementById('camera1Signal');
            
            if (uptimeEl) {
                fetch(`http://${cameraIP}/status`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.uptime) {
                            const hours = Math.floor(data.uptime / 3600);
                            const minutes = Math.floor((data.uptime % 3600) / 60);
                            uptimeEl.textContent = `${hours}h${minutes}m`;
                        }
                        if (data.wifi_rssi && signalEl) {
                            signalEl.textContent = `${data.wifi_rssi}dBm`;
                        }
                    })
                    .catch(() => {
                        uptimeEl.textContent = '--';
                        if (signalEl) signalEl.textContent = '--dBm';
                    });
            }
        }, 30000); // Update every 30 seconds

        function setCameraRefreshRate(rate) {
            cameraRefreshRate = parseInt(rate);
            if (cameraAutoRefresh) {
                // Restart auto refresh with new rate
                toggleCameraAutoRefresh();
                toggleCameraAutoRefresh();
            }
        }

        function toggleCameraAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            if (cameraAutoRefresh) {
                // Stop auto refresh
                cameraAutoRefresh = false;
                if (cameraRefreshInterval) {
                    clearInterval(cameraRefreshInterval);
                    cameraRefreshInterval = null;
                }
                btn.style.background = '#6c757d';
                btn.textContent = '⏸️ Auto';
                document.getElementById('cameraStatus2').textContent = 'Arrêté';
                document.getElementById('cameraStatus2').style.color = '#6c757d';
            } else {
                // Start auto refresh
                cameraAutoRefresh = true;
                refreshCameraSnapshot(); // Take first snapshot
                cameraRefreshInterval = setInterval(refreshCameraSnapshot, cameraRefreshRate);
                btn.style.background = '#10b981';
                btn.textContent = '🔄 Auto';
                document.getElementById('cameraStatus2').textContent = 'Auto';
                document.getElementById('cameraStatus2').style.color = '#10b981';
            }
        }

        function refreshCameraSnapshot() {
            const img = document.getElementById('cameraSnapshot');
            const placeholder = document.getElementById('cameraPlaceholder');
            const status = document.getElementById('cameraStatus');
            const timestamp = document.getElementById('cameraTimestamp');
            const timestampText = document.getElementById('timestampText');
            const resolution = document.getElementById('cameraResolution');
            
            // Update timestamp
            const now = new Date();
            timestampText.textContent = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            
            // Show loading state
            document.getElementById('cameraStatus2').textContent = 'Capture...';
            document.getElementById('cameraStatus2').style.color = '#f59e0b';
            
            // Create new image with timestamp to avoid caching
            const captureUrl = `http://${cameraIP}/capture?t=${Date.now()}`;
            
            // Create a new image element to test loading
            const testImg = new Image();
            testImg.onload = function() {
                // Success - show the image
                img.src = captureUrl;
                img.style.display = 'block';
                placeholder.style.display = 'none';
                status.style.display = 'block';
                timestamp.style.display = 'block';
                
                // Update resolution (estimate based on ESP32 CAM)
                resolution.textContent = '800x600';
                
                // Update status
                document.getElementById('cameraStatus2').textContent = cameraAutoRefresh ? 'Auto' : 'Prêt';
                document.getElementById('cameraStatus2').style.color = cameraAutoRefresh ? '#10b981' : '#3b82f6';
            };
            
            testImg.onerror = function() {
                // Error - show placeholder
                img.style.display = 'none';
                placeholder.style.display = 'flex';
                status.style.display = 'none';
                timestamp.style.display = 'none';
                
                // Update placeholder text
                placeholder.innerHTML = `
                    <div style="text-align: center;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 8px; opacity: 0.5; color: #ef4444;"></i><br>
                        Erreur de connexion à ${cameraIP}
                    </div>
                `;
                
                resolution.textContent = 'Erreur';
                document.getElementById('cameraStatus2').textContent = 'Hors ligne';
                document.getElementById('cameraStatus2').style.color = '#ef4444';
            };
            
            testImg.src = captureUrl;
        }

        function toggleCameraFlash() {
            const btn = document.getElementById('flashToggleBtn');
            const flashStatusEl = document.getElementById('flashStatus');
            
            // Toggle flash state
            flashState = !flashState;
            
            // Send flash command to ESP32
            fetch(`http://${cameraIP}/flash`)
                .then(response => response.text())
                .then(data => {
                    // Update button appearance and status
                    if (flashState) {
                        btn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
                        btn.innerHTML = '<i class="fas fa-lightbulb"></i> Flash ON';
                        flashStatusEl.textContent = 'ON';
                        flashStatusEl.style.color = '#f59e0b';
                    } else {
                        btn.style.background = 'linear-gradient(135deg, #6b7280, #4b5563)';
                        btn.innerHTML = '<i class="fas fa-lightbulb"></i> Flash LED';
                        flashStatusEl.textContent = 'OFF';
                        flashStatusEl.style.color = '#1e293b';
                    }
                })
                .catch(error => {
                    console.error('Flash toggle error:', error);
                    // Revert flash state on error
                    flashState = !flashState;
                    btn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Erreur';
                    setTimeout(() => {
                        btn.style.background = 'linear-gradient(135deg, #6b7280, #4b5563)';
                        btn.innerHTML = '<i class="fas fa-lightbulb"></i> Flash LED';
                    }, 2000);
                });
        }

        function downloadSnapshot() {
            const img = document.getElementById('cameraSnapshot');
            if (img.src && img.style.display !== 'none') {
                const link = document.createElement('a');
                link.href = img.src;
                link.download = `ESP32_CAM_${new Date().toISOString().replace(/[:.]/g, '-')}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert('Aucune image à télécharger. Prenez d\'abord une photo.');
            }
        }

        // Enhanced refresh function with counters
        let snapshotCounter = 0;
        function refreshCameraSnapshot() {
            const img = document.getElementById('cameraSnapshot');
            const placeholder = document.getElementById('cameraPlaceholder');
            const status = document.getElementById('cameraStatus');
            const timestamp = document.getElementById('cameraTimestamp');
            const timestampText = document.getElementById('timestampText');
            const connectionStatus = document.getElementById('connectionStatus');
            const lastCaptureTime = document.getElementById('lastCaptureTime');
            const snapshotCount = document.getElementById('snapshotCount');
            
            // Update timestamp
            const now = new Date();
            timestampText.textContent = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            
            // Show loading state
            document.getElementById('cameraStatus2').textContent = 'Capture...';
            document.getElementById('cameraStatus2').style.color = '#f59e0b';
            document.getElementById('cameraStatus2').style.background = '#fef3c7';
            
            // Create new image with timestamp to avoid caching
            const captureUrl = `http://${cameraIP}/capture?t=${Date.now()}`;
            
            // Create a new image element to test loading
            const testImg = new Image();
            testImg.onload = function() {
                // Success - show the image
                img.src = captureUrl;
                img.style.display = 'block';
                placeholder.style.display = 'none';
                status.style.display = 'block';
                timestamp.style.display = 'block';
                connectionStatus.style.display = 'block';
                
                // Update counters and status
                snapshotCounter++;
                snapshotCount.textContent = snapshotCounter;
                lastCaptureTime.textContent = now.toLocaleTimeString('fr-FR');
                
                // Update status
                document.getElementById('cameraStatus2').textContent = cameraAutoRefresh ? 'Auto' : 'Prêt';
                document.getElementById('cameraStatus2').style.color = cameraAutoRefresh ? '#16a34a' : '#2563eb';
                document.getElementById('cameraStatus2').style.background = cameraAutoRefresh ? '#dcfce7' : '#dbeafe';
                document.getElementById('cameraConnectionStatus').textContent = 'ONLINE';
            };
            
            testImg.onerror = function() {
                // Error - show placeholder
                img.style.display = 'none';
                placeholder.style.display = 'flex';
                status.style.display = 'none';
                timestamp.style.display = 'none';
                connectionStatus.style.display = 'none';
                
                // Update placeholder text
                placeholder.innerHTML = `
                    <div style="text-align: center; color: white;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 4rem; margin-bottom: 20px; display: block; opacity: 0.8; color: #ef4444;"></i>
                        <h3 style="margin: 0 0 10px 0; font-size: 1.5rem;">Connexion Échouée</h3>
                        <p style="margin: 0; opacity: 0.9;">Impossible de se connecter à ${cameraIP}</p>
                    </div>
                `;
                
                document.getElementById('cameraStatus2').textContent = 'Hors ligne';
                document.getElementById('cameraStatus2').style.color = '#dc2626';
                document.getElementById('cameraStatus2').style.background = '#fee2e2';
                document.getElementById('cameraConnectionStatus').textContent = 'OFFLINE';
            };
            
            testImg.src = captureUrl;
        }

        // Initialize advanced settings on page load
        function initializeAdvancedSettings() {
            loadAdvancedSettings();
            
            // Add event listeners for all settings controls
            const themeSelector = document.getElementById('themeSelector');
            if (themeSelector) {
                themeSelector.addEventListener('change', (e) => changeAppTheme(e.target.value));
            }

            const accentColor = document.getElementById('accentColor');
            if (accentColor) {
                accentColor.addEventListener('change', (e) => changeAccentColor(e.target.value));
            }

            const enableAnimations = document.getElementById('enableAnimations');
            if (enableAnimations) {
                enableAnimations.addEventListener('change', (e) => toggleAnimations(e.target.checked));
            }

            const animationSpeed = document.getElementById('animationSpeed');
            if (animationSpeed) {
                animationSpeed.addEventListener('input', (e) => updateAnimationSpeed(e.target.value));
            }

            const refreshInterval = document.getElementById('refreshInterval');
            if (refreshInterval) {
                refreshInterval.addEventListener('change', (e) => updateRefreshInterval(e.target.value));
            }

            const maxDataPoints = document.getElementById('maxDataPoints');
            if (maxDataPoints) {
                maxDataPoints.addEventListener('change', (e) => updateMaxDataPoints(e.target.value));
            }

            const autoSave = document.getElementById('autoSave');
            if (autoSave) {
                autoSave.addEventListener('change', (e) => toggleAutoSave(e.target.checked));
            }

            const dataCompression = document.getElementById('dataCompression');
            if (dataCompression) {
                dataCompression.addEventListener('change', (e) => toggleDataCompression(e.target.checked));
            }

            const desktopNotifications = document.getElementById('desktopNotifications');
            if (desktopNotifications) {
                desktopNotifications.addEventListener('change', (e) => toggleDesktopNotifications(e.target.checked));
            }

            const notificationSounds = document.getElementById('notificationSounds');
            if (notificationSounds) {
                notificationSounds.addEventListener('change', (e) => toggleNotificationSounds(e.target.checked));
            }

            const tempThreshold = document.getElementById('tempThreshold');
            if (tempThreshold) {
                tempThreshold.addEventListener('change', (e) => updateTempThreshold(e.target.value));
            }

            const humidityThreshold = document.getElementById('humidityThreshold');
            if (humidityThreshold) {
                humidityThreshold.addEventListener('change', (e) => updateHumidityThreshold(e.target.value));
            }

            const debugMode = document.getElementById('debugMode');
            if (debugMode) {
                debugMode.addEventListener('change', (e) => toggleDebugMode(e.target.checked));
            }

            const verboseLogs = document.getElementById('verboseLogs');
            if (verboseLogs) {
                verboseLogs.addEventListener('change', (e) => toggleVerboseLogs(e.target.checked));
            }

            const cacheSize = document.getElementById('cacheSize');
            if (cacheSize) {
                cacheSize.addEventListener('input', (e) => updateCacheSize(e.target.value));
            }

            // System action buttons
            const restartBtn = document.getElementById('restartSystem');
            if (restartBtn) {
                restartBtn.addEventListener('click', restartSystem);
            }

            const clearCacheBtn = document.getElementById('clearCache');
            if (clearCacheBtn) {
                clearCacheBtn.addEventListener('click', clearCache);
            }

            const factoryResetBtn = document.getElementById('factoryReset');
            if (factoryResetBtn) {
                factoryResetBtn.addEventListener('click', factoryReset);
            }

            // Export/Import buttons
            const exportJsonBtn = document.getElementById('exportJson');
            if (exportJsonBtn) {
                exportJsonBtn.addEventListener('click', () => exportData('json'));
            }

            const exportCsvBtn = document.getElementById('exportCsv');
            if (exportCsvBtn) {
                exportCsvBtn.addEventListener('click', () => exportData('csv'));
            }

            const exportSettingsBtn = document.getElementById('exportSettingsBtn');
            if (exportSettingsBtn) {
                exportSettingsBtn.addEventListener('click', exportSettings);
            }

            const resetSettingsBtn = document.getElementById('resetSettings');
            if (resetSettingsBtn) {
                resetSettingsBtn.addEventListener('click', resetAllSettings);
            }

            const importFile = document.getElementById('importFile');
            if (importFile) {
                importFile.addEventListener('change', (e) => {
                    if (e.target.files[0]) {
                        importSettings(e.target.files[0]);
                    }
                });
            }

            // Category toggle buttons
            document.querySelectorAll('.category-toggle').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleCategory(button);
                });
            });

            // Settings dropdown toggle
            const settingsToggle = document.querySelector('.settings-nav a');
            if (settingsToggle) {
                settingsToggle.addEventListener('click', toggleSettingsDropdown);
            }
        }

        // Call initialization when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeAdvancedSettings();
        });

        </script>
    </body>
</html>
